{% extends "base.html" %}
{% load static %}
{% load travel_filters %}

{% block title %}Safar Zone - Book Flights Online{% endblock %}

{% block extra_css %}
<!-- Flatpickr Date Picker CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    /* Professional Static Background - Light Blue Gradient */
    .hero-section {
        background: linear-gradient(135deg, #598caf 0%, #336681 50%, #306279 100%);
        min-height: 600px;
        position: relative;
    }

    /* Professional Form Styling - Goibibo Style */
    .search-form-container {
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 24px;
        margin-top: 40px;
        max-width: 100%;
        margin-right: auto;
    }

    .form-field-wrapper {
        position: relative;
        margin-bottom: 15px;
    }

    .form-field-label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
    }

    .form-field-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 15px;
        color: #111827;
        background: #ffffff;
        transition: border-color 0.2s;
    }

    .form-field-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-field-display {
        padding: 12px 16px;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        background: #f9fafb;
        min-height: 48px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: center;
        transition: all 0.2s;
    }

    .form-field-display:hover {
        border-color: #d1d5db;
        background: #ffffff;
    }

    .form-field-value {
        font-size: 15px;
        font-weight: 600;
        color: #111827;
    }

    .form-field-subtext {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 2px;
    }

    .form-field-placeholder {
        font-size: 15px;
        color: #9ca3af;
        font-weight: 400;
    }

    .trip-type-container {
        display: flex;
        gap: 24px;
        margin-bottom: 20px;
    }

    .trip-type-btn {
        padding: 0;
        border: none;
        background: transparent;
        font-weight: 600;
        font-size: 16px;
        color: #333;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
    }

    .trip-type-btn::before {
        content: '';
        width: 18px;
        height: 18px;
        border: 2px solid #d1d5db;
        border-radius: 50%;
        background: #ffffff;
        transition: all 0.2s;
    }

    .trip-type-btn.active {
        color: #3b82f6;
    }

    .trip-type-btn.active::before {
        border-color: #3b82f6;
        background: #3b82f6;
        box-shadow: inset 0 0 0 4px #ffffff;
    }

    .swap-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid #d1d5db;
        background: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        margin-top: 28px;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .swap-btn:hover {
        background: #f3f4f6;
        border-color: #ff6b35;
        color: #ff6b35;
    }

    .search-btn {
        width: 100%;
        padding: 16px;
        background: #ff6b35;
        color: #ffffff;
        border: none;
        border-radius: 30px;
        font-size: 16px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .search-btn:hover {
        background: #e55a2b;
    }

    .hidden-input-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
        z-index: 5;
    }

    .hidden-input-overlay:focus {
        opacity: 1;
        z-index: 10;
    }

    .error-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ef4444;
        color: #ffffff;
        padding: 16px 24px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 12px;
        max-width: 400px;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .field-error {
        border-color: #ef4444 !important;
    }

    /* Passenger Selection Modal */
    .passenger-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .passenger-modal.active {
        display: flex;
    }

    .passenger-modal-content {
        background: #ffffff;
        border-radius: 8px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .passenger-section {
        margin-bottom: 25px;
    }

    .passenger-section-title {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .passenger-count-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .passenger-count-btn {
        min-width: 50px;
        padding: 10px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        background: #ffffff;
        font-weight: 600;
        font-size: 14px;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
    }

    .passenger-count-btn:hover {
        border-color: #3b82f6;
        background: #f3f4f6;
    }

    .passenger-count-btn.selected {
        background: #3b82f6;
        border-color: #3b82f6;
        color: #ffffff;
    }

    .travel-class-section {
        margin-top: 25px;
        padding-top: 25px;
        border-top: 1px solid #e5e7eb;
    }

    .travel-class-btn {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        background: #ffffff;
        font-weight: 600;
        font-size: 14px;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
        margin-bottom: 8px;
    }

    .travel-class-btn:hover {
        border-color: #3b82f6;
        background: #f3f4f6;
    }

    .travel-class-btn.selected {
        background: #3b82f6;
        border-color: #3b82f6;
        color: #ffffff;
    }

    .modal-apply-btn {
        width: 100%;
        padding: 14px;
        background: #ff6b35;
        color: #ffffff;
        border: none;
        border-radius: 30px;
        font-size: 16px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: background 0.2s;
        margin-top: 20px;
    }

    .modal-apply-btn:hover {
        background: #e55a2b;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section py-12">
    <div class="max-w-7xl mx-auto px-2 lg:px-4">
        <!-- Two Column Layout: Left for form, Right for ads -->
        <div class="flex flex-col lg:flex-row gap-8 justify-center">
            <!-- Mobile Header -->
            <div class="lg:hidden text-center mb-4">
                <h1 class="text-2xl font-bold text-white mb-2">
                    Book Flights Online
                </h1>
                <p class="text-sm text-white/90">
                    Find the best deals for your journey
                </p>
            </div>
            
            <!-- Search Form Container - 60% width on desktop, centered -->
            <div class="w-full lg:w-[60%] order-2 lg:order-1">
                <!-- Search Form -->
                <div class="search-form-container" style="padding: 30px;">
                <form method="GET" action="{% url 'search_flights' %}" id="searchForm">
                    <!-- Hidden radio inputs for trip type -->
                    <input type="radio" name="trip_type" value="one_way" checked id="trip_one_way" style="display: none;">
                    <input type="radio" name="trip_type" value="return" id="trip_return" style="display: none;">
                    
                    <!-- Desktop Layout - Single Horizontal Row -->
                    <div class="hidden lg:block">
                        <!-- Trip Type Buttons - Horizontal on Top -->
                        <div class="flex gap-3 mb-4 max-w-sm">
                            <button type="button" class="trip-type-btn active flex-1 py-2.5 text-sm font-semibold" id="trip_one_way_btn">
                                One Way
                            </button>
                            <button type="button" class="trip-type-btn flex-1 py-2.5 text-sm font-semibold" id="trip_return_btn">
                                Round Trip
                            </button>
                        </div>
                        
                        <!-- Flight Type Filter -->
                        <div class="mb-4">
                            <label class="text-xs font-semibold text-gray-600 mb-2 block">FLIGHT TYPE</label>
                            <div class="flex gap-2 max-w-sm">
                                <input type="radio" name="flight_type" value="any" checked class="hidden" id="flight_any">
                                <button type="button" class="flight-type-btn flex-1 text-center py-2 px-3 text-xs font-semibold cursor-pointer rounded-lg border-2" 
                                        id="btn_flight_any" onclick="selectFlightType('any')" style="border-color: #d1d5db; background: white; color: #374151;">
                                    <i class="fas fa-plane text-xs mr-1"></i> Any
                                </button>
                                
                                <input type="radio" name="flight_type" value="direct" class="hidden" id="flight_direct">
                                <button type="button" class="flight-type-btn flex-1 text-center py-2 px-3 text-xs font-semibold cursor-pointer rounded-lg border-2" 
                                        id="btn_flight_direct" onclick="selectFlightType('direct')" style="border-color: #d1d5db; background: white; color: #374151;">
                                    <i class="fas fa-plane-departure text-xs mr-1"></i> Direct
                                </button>
                                
                                <input type="radio" name="flight_type" value="via" class="hidden" id="flight_via">
                                <button type="button" class="flight-type-btn flex-1 text-center py-2 px-3 text-xs font-semibold cursor-pointer rounded-lg border-2" 
                                        id="btn_flight_via" onclick="selectFlightType('via')" style="border-color: #d1d5db; background: white; color: #374151;">
                                    <i class="fas fa-route text-xs mr-1"></i> Via
                                </button>
                            </div>
                        </div>
                        
                        <!-- All Fields in One Horizontal Row -->
                        <div class="flex gap-3 items-end">
                            <!-- From -->
                            <div class="flex-1 form-field-wrapper">
                                <label class="form-field-label text-xs font-bold mb-1.5 block">FROM</label>
                                <div class="form-field-display h-12" id="from_display_card">
                                    <div class="form-field-value text-sm" id="from_display">Enter city</div>
                                    <div class="form-field-subtext text-xs" id="from_subtext" style="display: none;"></div>
                                </div>
                                <input type="text" name="from_location" id="from_location" list="origin-suggestions"
                                    class="form-field-input hidden-input-overlay" required value="{{ prefill_from }}">
                                <datalist id="origin-suggestions">
                                    {% for origin in origins %}
                                    <option value="{{ origin }}{% if origin in airport_codes %} ({{ airport_codes|get_item:origin }}){% endif %}" data-value="{{ origin }}" data-city="{{ origin|lower }}" data-code="{% if origin in airport_codes %}{{ airport_codes|get_item:origin|lower }}{% endif %}">
                                    {% endfor %}
                                </datalist>
                            </div>

                            <!-- Swap Button -->
                            <div class="swap-btn" onclick="swapLocations()" title="Swap cities">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M7 16V4M7 4L3 8M7 4L11 8"></path>
                                    <path d="M17 8V20M17 20L21 16M17 20L13 16"></path>
                                </svg>
                            </div>

                            <!-- To -->
                            <div class="flex-1 form-field-wrapper">
                                <label class="form-field-label text-xs font-bold mb-1.5 block">TO</label>
                                <div class="form-field-display h-12" id="to_display_card">
                                    <div class="form-field-value text-sm" id="to_display">Enter city</div>
                                    <div class="form-field-subtext text-xs" id="to_subtext" style="display: none;"></div>
                                </div>
                                <input type="text" name="to_location" id="to_location" list="destination-suggestions"
                                    class="form-field-input hidden-input-overlay" required value="{{ prefill_to }}">
                                <datalist id="destination-suggestions">
                                    {% for destination in destinations %}
                                    <option value="{{ destination }}{% if destination in airport_codes %} ({{ airport_codes|get_item:destination }}){% endif %}" data-value="{{ destination }}" data-city="{{ destination|lower }}" data-code="{% if destination in airport_codes %}{{ airport_codes|get_item:destination|lower }}{% endif %}">
                                    {% endfor %}
                                </datalist>
                            </div>

                            <!-- Departure Date -->
                            <div class="flex-1 form-field-wrapper">
                                <label class="form-field-label text-xs font-bold mb-1.5 block">DEPARTURE</label>
                                <div class="form-field-display h-12" id="departure_display_card">
                                    <div class="form-field-value text-sm" id="departure_display">Select date</div>
                                    <div class="form-field-subtext text-xs" id="departure_subtext" style="display: none;"></div>
                                </div>
                                <input type="text" name="travel_date" id="travel_date" placeholder="Select date"
                                    class="form-field-input hidden-input-overlay" required readonly value="{{ prefill_travel_date }}">
                            </div>

                            <!-- Return Date -->
                            <div class="flex-1 form-field-wrapper" id="return_date_wrapper" style="display: none;">
                                <label class="form-field-label text-xs font-bold mb-1.5 block">RETURN</label>
                                <div class="form-field-display h-12" id="return_display_card"
                                    style="background: #f9fafb; border-color: #e5e7eb;">
                                    <div class="form-field-placeholder text-sm" id="return_display">Add return date</div>
                                    <div class="form-field-subtext text-xs" id="return_subtext" style="display: none;"></div>
                                </div>
                                <input type="text" name="return_date" id="return_date" placeholder="Select date"
                                    class="form-field-input hidden-input-overlay" disabled readonly value="{{ prefill_return_date }}">
                            </div>

                            <!-- Passengers -->
                            <div class="flex-1 form-field-wrapper">
                                <label class="form-field-label text-xs font-bold mb-1.5 block">TRAVELLERS</label>
                                <div class="form-field-display h-12 cursor-pointer" id="passenger_display_card" onclick="openPassengerModal()">
                                    <div class="form-field-value text-sm" id="passenger_display">1 Traveller</div>
                                    <div class="form-field-subtext text-xs" id="passenger_subtext">Economy</div>
                                </div>
                                <input type="hidden" name="adults" id="adults_input" value="{{ request.GET.adults|default:'1' }}" required>
                                <input type="hidden" name="children" id="children_input" value="{{ request.GET.children|default:'0' }}">
                                <input type="hidden" name="infants" id="infants_input" value="{{ request.GET.infants|default:'0' }}">
                                <input type="hidden" name="travel_class" id="travel_class_input" value="{{ request.GET.travel_class|default:'economy' }}">
                            </div>
                            
                            <!-- Search Button -->
                            <div class="w-40">
                                <button type="submit" class="search-btn w-full h-12 text-sm font-bold">
                                    <i class="fas fa-search mr-1"></i>
                                    SEARCH
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile/Tablet Layout (Original Vertical) -->
                    <div class="lg:hidden">
                        <!-- Trip Type -->
                        <div class="trip-type-container mb-4">
                            <button type="button" class="trip-type-btn active" id="trip_one_way_btn_mobile">One Way</button>
                            <button type="button" class="trip-type-btn" id="trip_return_btn_mobile">Round Trip</button>
                        </div>
                        
                        <!-- Flight Type Filter - Mobile -->
                        <div class="mb-4">
                            <label class="text-xs font-semibold text-gray-600 mb-2 block">FLIGHT TYPE</label>
                            <div class="flex gap-2">
                                <label class="flex-1">
                                    <input type="radio" name="flight_type_mobile" value="any" checked class="hidden" id="flight_any_mobile">
                                    <div class="flight-type-btn text-center py-2 px-3 text-xs font-semibold cursor-pointer rounded-lg border-2 border-gray-300 bg-white hover:border-blue-500 transition-all" onclick="selectFlightType('any')">
                                        <i class="fas fa-plane text-xs mr-1"></i> Any
                                    </div>
                                </label>
                                <label class="flex-1">
                                    <input type="radio" name="flight_type_mobile" value="direct" class="hidden" id="flight_direct_mobile">
                                    <div class="flight-type-btn text-center py-2 px-3 text-xs font-semibold cursor-pointer rounded-lg border-2 border-gray-300 bg-white hover:border-blue-500 transition-all" onclick="selectFlightType('direct')">
                                        <i class="fas fa-plane-departure text-xs mr-1"></i> Direct
                                    </div>
                                </label>
                                <label class="flex-1">
                                    <input type="radio" name="flight_type_mobile" value="via" class="hidden" id="flight_via_mobile">
                                    <div class="flight-type-btn text-center py-2 px-3 text-xs font-semibold cursor-pointer rounded-lg border-2 border-gray-300 bg-white hover:border-blue-500 transition-all" onclick="selectFlightType('via')">
                                        <i class="fas fa-route text-xs mr-1"></i> Via
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Form Fields - Vertical on Mobile -->
                        <div class="grid grid-cols-1 gap-4">
                            <!-- From -->
                            <div class="form-field-wrapper">
                                <label class="form-field-label">FROM</label>
                                <div class="form-field-display" id="from_display_card_mobile">
                                    <div class="form-field-value" id="from_display_mobile">Enter city</div>
                                </div>
                            </div>

                            <!-- To -->
                            <div class="form-field-wrapper">
                                <label class="form-field-label">TO</label>
                                <div class="form-field-display" id="to_display_card_mobile">
                                    <div class="form-field-value" id="to_display_mobile">Enter city</div>
                                </div>
                            </div>

                            <!-- Departure Date -->
                            <div class="form-field-wrapper">
                                <label class="form-field-label">DEPARTURE</label>
                                <div class="form-field-display" id="departure_display_card_mobile">
                                    <div class="form-field-value" id="departure_display_mobile">Select date</div>
                                </div>
                            </div>

                            <!-- Return Date -->
                            <div class="form-field-wrapper" id="return_date_wrapper_mobile" style="display: none;">
                                <label class="form-field-label">RETURN</label>
                                <div class="form-field-display" id="return_display_card_mobile">
                                    <div class="form-field-placeholder" id="return_display_mobile">Add return date</div>
                                </div>
                            </div>

                            <!-- Passengers -->
                            <div class="form-field-wrapper">
                                <label class="form-field-label">TRAVELLERS</label>
                                <div class="form-field-display" id="passenger_display_card_mobile" onclick="openPassengerModal()">
                                    <div class="form-field-value" id="passenger_display_mobile">1 Traveller</div>
                                    <div class="form-field-subtext" id="passenger_subtext_mobile">Economy</div>
                                </div>
                            </div>
                        </div>

                        <!-- Search Button -->
                        <div class="mt-6">
                            <button type="submit" class="search-btn">
                                <i class="fas fa-search mr-2"></i>
                                Search Flights
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            </div><!-- End Left Column (Form) -->
            
            <!-- Right Column - For Ads (Hidden for now to give more space to form) -->
            <div class="hidden order-3 lg:order-2">
                <!-- Ads space - can be filled later -->
                <div class="text-center mb-6">
                    <h1 class="text-3xl md:text-4xl font-bold text-white mb-3">
                        Book Flights Online
                    </h1>
                    <p class="text-lg text-white/90">
                        Find the best deals for your journey
                    </p>
                </div>
                <!-- Ad placeholder -->
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 text-center text-white/60 min-h-[300px] flex items-center justify-center">
                    <div>
                        <i class="fas fa-ad text-4xl mb-3 opacity-50"></i>
                        <p class="text-sm">Advertisement Space</p>
                    </div>
                </div>
            </div>
        </div><!-- End Flex Container -->
        
        <!-- Promotional Banners - Below Search Form -->
        <div class="max-w-7xl mx-auto px-4 mt-24 pb-12">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Special Offer Banner -->
                <div class="group relative overflow-hidden rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-500 transform hover:scale-105 cursor-pointer">
                    <div class="absolute inset-0 bg-gradient-to-br from-orange-600/90 to-red-700/90"></div>
                    <img src="https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=400&h=300&fit=crop" alt="Flight Offer" class="absolute inset-0 w-full h-full object-cover opacity-40 group-hover:opacity-50 transition-opacity duration-500">
                    <div class="relative p-6 h-full flex flex-col justify-between min-h-[200px]">
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <span class="inline-block text-xs font-bold bg-yellow-400 text-orange-900 px-3 py-1 rounded-full shadow-lg">LIMITED TIME</span>
                                <i class="fas fa-bolt text-3xl text-yellow-300 animate-pulse drop-shadow-lg"></i>
                            </div>
                            <h3 class="text-2xl font-black mb-2 text-white drop-shadow-lg">Flat ₹2000 OFF</h3>
                            <p class="text-sm text-white/95 font-medium mb-3 drop-shadow">On International Flights</p>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs bg-white/20 backdrop-blur-sm px-3 py-1.5 rounded-full text-white font-semibold border border-white/30">Code: INTFLY2K</span>
                            <i class="fas fa-arrow-right text-white text-lg group-hover:translate-x-2 transition-transform duration-300"></i>
                        </div>
                    </div>
                </div>

                <!-- Umrah Package Banner -->
                <div class="group relative overflow-hidden rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-500 transform hover:scale-105 cursor-pointer">
                    <div class="absolute inset-0 bg-gradient-to-br from-green-700/90 to-emerald-800/90"></div>
                    <img src="https://images.unsplash.com/photo-1592326871020-04f58c1a52f3?q=80&w=465&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Umrah" class="absolute inset-0 w-full h-full object-cover opacity-30 group-hover:opacity-40 transition-opacity duration-500">
                    <div class="relative p-6 h-full flex flex-col justify-between min-h-[200px]">
                        <div>
                            <div class="flex items-center mb-3">
                                <i class="fas fa-kaaba text-4xl mr-3 text-yellow-200 drop-shadow-xl"></i>
                                <div>
                                    <h3 class="text-xl font-black text-white drop-shadow-lg">Umrah Packages</h3>
                                    <p class="text-xs text-yellow-200/90 font-semibold">Special Ramadan Offers</p>
                                </div>
                            </div>
                            <p class="text-sm text-white/95 font-medium mb-3 drop-shadow">Premium packages with 5-star hotels</p>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-bold text-white drop-shadow-lg">From ₹89,999</span>
                            <a href="{% url 'umrah' %}" class="inline-flex items-center text-sm font-semibold text-white bg-white/20 backdrop-blur-sm px-4 py-2 rounded-full hover:bg-white/30 transition-all border border-white/30">
                                View <i class="fas fa-arrow-right ml-2 group-hover:translate-x-2 transition-transform duration-300"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Hot Deals Banner -->
                <div class="group relative overflow-hidden rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-500 transform hover:scale-105 cursor-pointer">
                    <div class="absolute inset-0 bg-white/95"></div>
                    <img src="https://plus.unsplash.com/premium_photo-1729029731689-16e7989704b8?q=80&w=1032&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Hot Deals" class="absolute inset-0 w-full h-full object-cover opacity-30 group-hover:opacity-40 transition-opacity duration-500">
                    <div class="relative p-6 h-full flex flex-col justify-between min-h-[200px]">
                        <div>
                            <div class="flex items-center mb-4">
                                <div class="bg-gradient-to-r from-orange-500 to-red-500 p-2 rounded-xl mr-3 shadow-lg">
                                    <i class="fas fa-fire text-white text-2xl"></i>
                                </div>
                                <h3 class="text-xl font-black text-gray-800">Hot Deals</h3>
                            </div>
                            <div class="space-y-2.5">
                                <div class="flex items-center justify-between p-2.5 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
                                    <div class="flex items-center">
                                        <i class="fas fa-plane-departure text-blue-600 mr-2 text-sm"></i>
                                        <span class="text-sm font-semibold text-gray-700">Delhi → Dubai</span>
                                    </div>
                                    <span class="text-base font-bold text-blue-600">₹12,999</span>
                                </div>
                                <div class="flex items-center justify-between p-2.5 bg-green-50 rounded-lg hover:bg-green-100 transition-colors">
                                    <div class="flex items-center">
                                        <i class="fas fa-plane-departure text-green-600 mr-2 text-sm"></i>
                                        <span class="text-sm font-semibold text-gray-700">Mumbai → Singapore</span>
                                    </div>
                                    <span class="text-base font-bold text-green-600">₹18,499</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Support Banner -->
                <div class="group relative overflow-hidden rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-500 transform hover:scale-105 cursor-pointer">
                    <div class="absolute inset-0 bg-gradient-to-br from-blue-600/90 to-indigo-800/90"></div>
                    <img src="https://images.unsplash.com/photo-1423666639041-f56000c27a9a?w=400&h=300&fit=crop" alt="Support" class="absolute inset-0 w-full h-full object-cover opacity-20 group-hover:opacity-30 transition-opacity duration-500">
                    <div class="relative p-6 h-full flex flex-col justify-between min-h-[200px]">
                        <div>
                            <div class="bg-white/20 backdrop-blur-sm p-3 rounded-xl inline-block mb-4 shadow-lg">
                                <i class="fas fa-headset text-4xl text-white drop-shadow-xl"></i>
                            </div>
                            <h3 class="text-2xl font-black mb-2 text-white drop-shadow-lg">24/7 Support</h3>
                            <p class="text-sm text-white/95 font-medium mb-4 drop-shadow">Expert travel assistance anytime</p>
                        </div>
                        <a href="tel:+919839049767" class="flex items-center text-white hover:text-yellow-300 transition-colors group">
                            <div class="bg-white/20 backdrop-blur-sm p-2 rounded-lg mr-3 border border-white/30">
                                <i class="fas fa-phone text-lg"></i>
                            </div>
                            <div>
                                <span class="text-xs text-white/80 block">Call Now</span>
                                <span class="font-bold text-base">+91 98390 49767</span>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Passenger Selection Modal -->
<div class="passenger-modal" id="passengerModal" onclick="closeModalOnBackdrop(event)">
    <div class="passenger-modal-content" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold text-gray-900 mb-6">Travellers & Class</h3>

        <!-- Adults Section -->
        <div class="passenger-section">
            <div class="passenger-section-title">Adults (12y +)</div>
            <div class="passenger-count-selector" id="adultsSelector">
                <button type="button" class="passenger-count-btn selected" data-count="1">1</button>
                <button type="button" class="passenger-count-btn" data-count="2">2</button>
                <button type="button" class="passenger-count-btn" data-count="3">3</button>
                <button type="button" class="passenger-count-btn" data-count="4">4</button>
                <button type="button" class="passenger-count-btn" data-count="5">5</button>
                <button type="button" class="passenger-count-btn" data-count="6">6</button>
                <button type="button" class="passenger-count-btn" data-count="7">7</button>
                <button type="button" class="passenger-count-btn" data-count="8">8</button>
                <button type="button" class="passenger-count-btn" data-count="9">9</button>
            </div>
        </div>

        <!-- Children Section -->
        <div class="passenger-section">
            <div class="passenger-section-title">Children (2y - 12y)</div>
            <div class="passenger-count-selector" id="childrenSelector">
                <button type="button" class="passenger-count-btn selected" data-count="0">0</button>
                <button type="button" class="passenger-count-btn" data-count="1">1</button>
                <button type="button" class="passenger-count-btn" data-count="2">2</button>
                <button type="button" class="passenger-count-btn" data-count="3">3</button>
                <button type="button" class="passenger-count-btn" data-count="4">4</button>
                <button type="button" class="passenger-count-btn" data-count="5">5</button>
                <button type="button" class="passenger-count-btn" data-count="6">6</button>
            </div>
        </div>

        <!-- Infants Section -->
        <div class="passenger-section">
            <div class="passenger-section-title">Infants (below 2y)</div>
            <div class="passenger-count-selector" id="infantsSelector">
                <button type="button" class="passenger-count-btn selected" data-count="0">0</button>
                <button type="button" class="passenger-count-btn" data-count="1">1</button>
                <button type="button" class="passenger-count-btn" data-count="2">2</button>
                <button type="button" class="passenger-count-btn" data-count="3">3</button>
                <button type="button" class="passenger-count-btn" data-count="4">4</button>
                <button type="button" class="passenger-count-btn" data-count="5">5</button>
                <button type="button" class="passenger-count-btn" data-count="6">6</button>
            </div>
        </div>

        <!-- Travel Class Section -->
        <div class="travel-class-section">
            <div class="passenger-section-title">Choose Travel Class</div>
            <button type="button" class="travel-class-btn selected" data-class="economy">
                Economy / Premium Economy
            </button>
            <button type="button" class="travel-class-btn" data-class="premium_economy">
                Premium Economy
            </button>
            <button type="button" class="travel-class-btn" data-class="business">
                Business
            </button>
            <button type="button" class="travel-class-btn" data-class="first">
                First Class
            </button>
        </div>

        <button type="button" class="modal-apply-btn" onclick="applyPassengerSelection()">
            Apply
        </button>
    </div>
</div>

<!-- Popular Destinations / Packages -->
<section id="packages" class="py-16 bg-gray-50">
    <div class="container mx-auto px-4">
        <div class="text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
                Popular Travel Packages
            </h2>
            <p class="text-lg text-gray-600">
                Discover amazing destinations around the world
            </p>
        </div>

        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for package in popular_packages %}
            <a href="{% url 'apply_package' package.name %}"
                class="block bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 cursor-pointer group">
                <div class="h-64 relative overflow-hidden">
                    <img src="{{ package.image }}" alt="{{ package.name }}"
                        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent"></div>
                    <div class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm px-3 py-1 rounded-full">
                        <span class="text-gray-800 font-semibold text-sm">Popular</span>
                    </div>
                    <div class="absolute bottom-4 left-4 right-4">
                        <div class="text-4xl mb-2">{{ package.icon }}</div>
                        <h3 class="text-2xl font-bold text-white mb-1 drop-shadow-lg">{{ package.name }}</h3>
                    </div>
                </div>
                <div class="p-6">
                    <p class="text-gray-600 mb-4 min-h-[3rem]">{{ package.description|default:"Explore amazing destinations" }}</p>
                    <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                        <div>
                            <span class="text-sm text-gray-500 block">Starting from</span>
                            <span class="text-2xl font-bold text-blue-600">Custom Pricing</span>
                        </div>
                        <div
                            class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-blue-300 rounded-lg font-semibold group-hover:from-blue-700 group-hover:to-blue-800 transition-all duration-200 shadow-lg">
                            <i class="fas fa-paper-plane mr-2"></i>Apply Now
                        </div>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>

        <!-- Also show database packages if available -->
        {% if packages %}
        <div class="mt-12">
            <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">Featured Packages</h3>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for package in packages|slice:":6" %}
                <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                    <div class="h-48 bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center">
                        {% if package.images.first %}
                        <img src="{{ package.images.first.image.url }}" alt="{{ package.title }}"
                            class="w-full h-full object-cover">
                        {% else %}
                        <i class="fas fa-image text-white text-4xl opacity-50"></i>
                        {% endif %}
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-900 mb-2">{{ package.title }}</h3>
                        <p class="text-gray-600 mb-4">{{ package.short_description|truncatewords:15 }}</p>
                        <div class="flex items-center justify-between">
                            <span class="text-2xl font-bold text-blue-600">₹{{ package.discounted_price|floatformat:0
                                }}</span>
                            <a href="#"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                View Details
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</section>

<!-- Features -->
<section class="py-16 bg-white">
    <div class="container mx-auto px-4">
        <div class="text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
                Why Choose Safar Zone
            </h2>
        </div>

        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
            <div class="text-center">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-dollar-sign text-blue-600 text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Best Prices</h3>
                <p class="text-gray-600">Get the best deals and competitive prices</p>
            </div>

            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-shield-alt text-green-600 text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Secure Booking</h3>
                <p class="text-gray-600">Your data and payments are protected</p>
            </div>

            <div class="text-center">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-headset text-purple-600 text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">24/7 Support</h3>
                <p class="text-gray-600">Round-the-clock customer support</p>
            </div>

            <div class="text-center">
                <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-plane text-orange-600 text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Easy Booking</h3>
                <p class="text-gray-600">Simple and fast booking process</p>
            </div>
        </div>
    </div>
</section>

<!-- Flatpickr Date Picker JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    // Initialize Flatpickr for date inputs with DD/MM/YYYY format
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date();
        
        // Departure date picker
        const departurePicker = flatpickr("#travel_date", {
            dateFormat: "Y-m-d",  // Value format for server
            altInput: true,
            altFormat: "d/m/Y",  // Display format for user
            minDate: "today",
            disableMobile: true,
            onChange: function(selectedDates, dateStr) {
                if (selectedDates.length > 0) {
                    const d = selectedDates[0];
                    
                    // Update display card
                    const display = document.getElementById('departure_display');
                    const subtext = document.getElementById('departure_subtext');
                    if (display) {
                        const displayDate = String(d.getDate()).padStart(2, '0') + '/' + 
                            String(d.getMonth() + 1).padStart(2, '0') + '/' + 
                            d.getFullYear();
                        display.textContent = displayDate;
                        display.className = 'form-field-value';
                    }
                    if (subtext) {
                        const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });
                        subtext.textContent = dayName;
                        subtext.style.display = 'block';
                    }
                    
                    // Update return date minimum
                    if (window.returnPicker) {
                        window.returnPicker.set('minDate', d);
                    }
                }
            }
        });
        
        // Return date picker
        const returnPicker = flatpickr("#return_date", {
            dateFormat: "Y-m-d",  // Value format for server
            altInput: true,
            altFormat: "d/m/Y",  // Display format for user
            minDate: "today",
            disableMobile: true,
            onChange: function(selectedDates, dateStr) {
                if (selectedDates.length > 0) {
                    const d = selectedDates[0];
                    
                    // Update display card
                    const display = document.getElementById('return_display');
                    const subtext = document.getElementById('return_subtext');
                    if (display) {
                        const displayDate = String(d.getDate()).padStart(2, '0') + '/' + 
                            String(d.getMonth() + 1).padStart(2, '0') + '/' + 
                            d.getFullYear();
                        display.textContent = displayDate;
                        display.className = 'form-field-value';
                    }
                    if (subtext) {
                        const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });
                        subtext.textContent = dayName;
                        subtext.style.display = 'block';
                    }
                }
            }
        });
        
        // Make pickers available globally
        window.departurePicker = departurePicker;
        window.returnPicker = returnPicker;
    });
</script>

<script>
    (function () {
        'use strict';

        // Trip Type Toggle
        const tripOneWayBtn = document.getElementById('trip_one_way_btn');
        const tripReturnBtn = document.getElementById('trip_return_btn');
        const tripOneWayRadio = document.getElementById('trip_one_way');
        const tripReturnRadio = document.getElementById('trip_return');
        const returnDateInput = document.getElementById('return_date');
        const returnDisplayCard = document.getElementById('return_display_card');
        const returnDateWrapper = document.getElementById('return_date_wrapper');

        function toggleTripType() {
            if (tripOneWayBtn && tripReturnBtn) {
                tripOneWayBtn.addEventListener('click', function () {
                    tripOneWayRadio.checked = true;
                    tripOneWayBtn.classList.add('active');
                    tripReturnBtn.classList.remove('active');
                    if (returnDateInput) {
                        returnDateInput.disabled = true;
                        returnDateInput.required = false;
                        returnDateInput.value = '';
                        returnDisplayCard.style.background = '#f9fafb';
                        document.getElementById('return_display').textContent = 'Add return date';
                        document.getElementById('return_display').className = 'form-field-placeholder';
                        // Client Req: Hide return date column on One Way
                        if (returnDateWrapper) returnDateWrapper.style.display = 'none';
                    }
                });

                tripReturnBtn.addEventListener('click', function () {
                    tripReturnRadio.checked = true;
                    tripReturnBtn.classList.add('active');
                    tripOneWayBtn.classList.remove('active');
                    if (returnDateInput) {
                        returnDateInput.disabled = false;
                        returnDateInput.required = true;
                        returnDisplayCard.style.background = '#ffffff';
                        // Determine if we have a value or need placeholder
                        if (returnDateInput.value) {
                            updateDateDisplay('return_date', 'return_display', 'return_subtext');
                        } else {
                            document.getElementById('return_display').textContent = 'Select date';
                            document.getElementById('return_display').className = 'form-field-value';
                        }
                        if (returnDateWrapper) returnDateWrapper.style.display = 'block';
                    }
                });
            }
        }

        // Auto-switch to Round Trip if disabled return date clicked
        if (returnDisplayCard) {
            returnDisplayCard.addEventListener('click', function () {
                if (tripOneWayRadio.checked) {
                    // Determine if we should switch
                    tripReturnBtn.click(); // Trigger logic
                    setTimeout(() => {
                        if (returnDateInput) returnDateInput.focus();
                        try { returnDateInput.showPicker(); } catch (e) { }
                    }, 100);
                }
            });
        }

        // Update Location Display
        function updateLocationDisplay(inputId, displayId, subtextId) {
            const input = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            const subtext = document.getElementById(subtextId);

            if (input && display) {
                const value = input.value.trim();
                if (value) {
                    const match = value.match(/^(.+?)(\s*\(([^)]+)\))?$/);
                    const cityName = match ? match[1].trim() : value;
                    const code = match ? match[3] : '';

                    display.textContent = cityName;
                    display.className = 'form-field-value';

                    if (subtext && code) {
                        subtext.textContent = code.toUpperCase() + ', ' + cityName;
                        subtext.style.display = 'block';
                    } else if (subtext) {
                        subtext.textContent = cityName;
                        subtext.style.display = 'block';
                    }
                } else {
                    display.textContent = 'Enter city';
                    display.className = 'form-field-placeholder';
                    if (subtext) {
                        subtext.style.display = 'none';
                    }
                }
            }
        }

        // Update Date Display
        function updateDateDisplay(inputId, displayId, subtextId) {
            const input = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            const subtext = document.getElementById(subtextId);

            if (input && display) {
                const dateValue = input.value;
                if (dateValue) {
                    const date = new Date(dateValue);
                    const formattedDate = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: '2-digit' });
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });

                    display.textContent = formattedDate;
                    display.className = 'form-field-value';

                    if (subtext) {
                        subtext.textContent = dayName;
                        subtext.style.display = 'block';
                    }
                } else {
                    display.textContent = inputId === 'travel_date' ? 'Select date' : 'Add return date';
                    display.className = 'form-field-placeholder';
                    if (subtext) {
                        subtext.style.display = 'none';
                    }
                }
            }
        }

        // Passenger Selection Modal Functions
        let currentAdults = 1;
        let currentChildren = 0;
        let currentInfants = 0;
        let currentTravelClass = 'economy';

        function openPassengerModal() {
            const modal = document.getElementById('passengerModal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closePassengerModal() {
            const modal = document.getElementById('passengerModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function closeModalOnBackdrop(event) {
            if (event.target.id === 'passengerModal') {
                closePassengerModal();
            }
        }

        function applyPassengerSelection() {
            try {
                // Validate selection
                if (currentAdults < 1) {
                    showError('At least 1 adult is required');
                    return;
                }

                if (currentInfants > currentAdults) {
                    showError('Number of infants cannot exceed number of adults');
                    return;
                }

                // Update hidden inputs
                const adultsInput = document.getElementById('adults_input');
                const childrenInput = document.getElementById('children_input');
                const infantsInput = document.getElementById('infants_input');
                const travelClassInput = document.getElementById('travel_class_input');

                if (adultsInput) adultsInput.value = currentAdults;
                if (childrenInput) childrenInput.value = currentChildren;
                if (infantsInput) infantsInput.value = currentInfants;
                if (travelClassInput) travelClassInput.value = currentTravelClass;

                // Update display
                updatePassengerDisplay();

                // Close modal
                closePassengerModal();
            } catch (error) {
                console.error('Error applying passenger selection:', error);
                showError('An error occurred. Please try again.');
            }
        }

        // Make functions globally accessible for onclick handlers
        window.openPassengerModal = openPassengerModal;
        window.closePassengerModal = closePassengerModal;
        window.closeModalOnBackdrop = closeModalOnBackdrop;
        window.applyPassengerSelection = applyPassengerSelection;

        function updatePassengerDisplay() {
            const display = document.getElementById('passenger_display');
            const subtext = document.getElementById('passenger_subtext');
            const total = currentAdults + currentChildren + currentInfants;

            if (display) {
                if (total === 1) {
                    display.textContent = '1 Traveller';
                } else {
                    display.textContent = total + ' Travellers';
                }
            }

            if (subtext) {
                const classNames = {
                    'economy': 'Economy',
                    'premium_economy': 'Premium Economy',
                    'business': 'Business',
                    'first': 'First Class'
                };
                subtext.textContent = classNames[currentTravelClass] || 'Economy';
            }
        }

        // Initialize passenger selectors
        function initPassengerSelectors() {
            // Adults selector
            const adultsSelector = document.getElementById('adultsSelector');
            if (adultsSelector) {
                adultsSelector.querySelectorAll('.passenger-count-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        adultsSelector.querySelectorAll('.passenger-count-btn').forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                        currentAdults = parseInt(this.dataset.count);
                    });
                });
                // Set initial state from current values (for persistence)
                adultsSelector.querySelectorAll('.passenger-count-btn').forEach(b => {
                    if (parseInt(b.dataset.count) === currentAdults) b.click();
                });
            }

            // Children selector
            const childrenSelector = document.getElementById('childrenSelector');
            if (childrenSelector) {
                childrenSelector.querySelectorAll('.passenger-count-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        childrenSelector.querySelectorAll('.passenger-count-btn').forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                        currentChildren = parseInt(this.dataset.count);
                    });
                });
                childrenSelector.querySelectorAll('.passenger-count-btn').forEach(b => {
                    if (parseInt(b.dataset.count) === currentChildren) b.click();
                });
            }

            // Infants selector
            const infantsSelector = document.getElementById('infantsSelector');
            if (infantsSelector) {
                infantsSelector.querySelectorAll('.passenger-count-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        infantsSelector.querySelectorAll('.passenger-count-btn').forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                        currentInfants = parseInt(this.dataset.count);
                    });
                });
                infantsSelector.querySelectorAll('.passenger-count-btn').forEach(b => {
                    if (parseInt(b.dataset.count) === currentInfants) b.click();
                });
            }

            // Travel class selector
            document.querySelectorAll('.travel-class-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.travel-class-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    currentTravelClass = this.dataset.class;
                });
            });
            // Set initial class
            document.querySelectorAll('.travel-class-btn').forEach(btn => {
                if (btn.dataset.class === currentTravelClass) btn.classList.add('selected');
                else btn.classList.remove('selected');
            });
        }

        // Swap Locations
        function swapLocations() {
            const fromInput = document.getElementById('from_location');
            const toInput = document.getElementById('to_location');

            if (fromInput && toInput) {
                const temp = fromInput.value;
                fromInput.value = toInput.value;
                toInput.value = temp;

                updateLocationDisplay('from_location', 'from_display', 'from_subtext');
                updateLocationDisplay('to_location', 'to_display', 'to_subtext');
            }
        }

        // Make swapLocations globally accessible
        window.swapLocations = swapLocations;

        // Show Error
        function showError(message) {
            const existing = document.querySelector('.error-notification');
            if (existing) existing.remove();

            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-notification';
            errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>' + message + '</span>';
            document.body.appendChild(errorDiv);

            setTimeout(() => {
                errorDiv.style.opacity = '0';
                setTimeout(() => errorDiv.remove(), 300);
            }, 4000);
        }

        // Form Validation
        const searchForm = document.getElementById('searchForm');
        if (searchForm) {
            searchForm.addEventListener('submit', function (e) {
                const fromInput = document.getElementById('from_location');
                const toInput = document.getElementById('to_location');

                if (!fromInput.value.trim()) {
                    e.preventDefault();
                    showError('Please select a departure city');
                    fromInput.focus();
                    return false;
                }

                if (!toInput.value.trim()) {
                    e.preventDefault();
                    showError('Please select a destination city');
                    toInput.focus();
                    return false;
                }

                const fromCity = fromInput.value.match(/^(.+?)(\s*\([^)]+\))?$/)?.[1]?.trim() || fromInput.value;
                const toCity = toInput.value.match(/^(.+?)(\s*\([^)]+\))?$/)?.[1]?.trim() || toInput.value;

                if (fromCity === toCity) {
                    e.preventDefault();
                    showError('Departure and destination cannot be the same');
                    return false;
                }

                if (tripReturnRadio.checked && returnDateInput && !returnDateInput.value.trim()) {
                    e.preventDefault();
                    showError('Please select a return date for round trip');
                    returnDateInput.focus();
                    return false;
                }

                // Validate at least one adult
                const adults = parseInt(document.getElementById('adults_input').value) || 0;
                if (adults === 0) {
                    e.preventDefault();
                    showError('At least 1 adult is required');
                    return false;
                }

                // Validate infants don't exceed adults
                const infants = parseInt(document.getElementById('infants_input').value) || 0;
                if (infants > adults) {
                    e.preventDefault();
                    showError('Number of infants cannot exceed number of adults');
                    return false;
                }
            });
        }

        // Store original datalist options
        const originalOptions = {
            origin: [],
            destination: []
        };

        // Initialize datalists - clear them initially
        function initializeDatalists() {
            const originDatalist = document.getElementById('origin-suggestions');
            const destinationDatalist = document.getElementById('destination-suggestions');

            if (originDatalist) {
                originalOptions.origin = Array.from(originDatalist.options).map(opt => ({
                    value: opt.value,
                    dataValue: opt.dataset.value || '',
                    dataCity: opt.dataset.city || '',
                    dataCode: opt.dataset.code || ''
                }));
                originDatalist.innerHTML = ''; // Clear initially
            }

            if (destinationDatalist) {
                originalOptions.destination = Array.from(destinationDatalist.options).map(opt => ({
                    value: opt.value,
                    dataValue: opt.dataset.value || '',
                    dataCity: opt.dataset.city || '',
                    dataCode: opt.dataset.code || ''
                }));
                destinationDatalist.innerHTML = ''; // Clear initially
            }
        }

        // Filter and show datalist options based on input
        function filterDatalist(input, datalistId, optionsKey) {
            const datalist = document.getElementById(datalistId);
            if (!datalist || !originalOptions[optionsKey]) return;

            const searchTerm = input.value.toLowerCase().trim();

            // Clear datalist
            datalist.innerHTML = '';

            // If search term is empty, don't show any options
            if (!searchTerm) {
                return;
            }

            // Filter options that match
            const filtered = originalOptions[optionsKey].filter(opt => {
                const city = opt.dataCity || '';
                const code = opt.dataCode || '';
                const value = opt.value.toLowerCase();

                return city.includes(searchTerm) ||
                    code.includes(searchTerm) ||
                    value.includes(searchTerm);
            });

            // Add filtered options to datalist
            filtered.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.setAttribute('data-value', opt.dataValue);
                option.setAttribute('data-city', opt.dataCity);
                option.setAttribute('data-code', opt.dataCode);
                datalist.appendChild(option);
            });
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize datalists - clear them first
            initializeDatalists();

            toggleTripType();

            const fromInput = document.getElementById('from_location');
            const toInput = document.getElementById('to_location');
            const travelDateInput = document.getElementById('travel_date');
            const returnDateInput = document.getElementById('return_date');
            const passengersSelect = document.getElementById('passengers');

            // Initialize Persistence (Client Req 6)
            // Check if DB/Context values are present in inputs and update display
            if (fromInput && fromInput.value) {
                updateLocationDisplay('from_location', 'from_display', 'from_subtext');
            }
            if (toInput && toInput.value) {
                updateLocationDisplay('to_location', 'to_display', 'to_subtext');
            }
            if (travelDateInput && travelDateInput.value) {
                updateDateDisplay('travel_date', 'departure_display', 'departure_subtext');
            }
            if (returnDateInput && returnDateInput.value) {
                // If return date exists, switch to Round Trip
                if (tripReturnBtn) tripReturnBtn.click();
                updateDateDisplay('return_date', 'return_display', 'return_subtext');
            } else {
                // Default to One Way (hide return)
                if (tripOneWayBtn) tripOneWayBtn.click();
            }

            // Load Passenger persistence
            const adultsInput = document.getElementById('adults_input');
            const childrenInput = document.getElementById('children_input');
            const infantsInput = document.getElementById('infants_input');
            const travelClassInput = document.getElementById('travel_class_input');

            if (adultsInput) currentAdults = parseInt(adultsInput.value) || 1;
            if (childrenInput) currentChildren = parseInt(childrenInput.value) || 0;
            if (infantsInput) currentInfants = parseInt(infantsInput.value) || 0;
            if (travelClassInput) currentTravelClass = travelClassInput.value || 'economy';

            updatePassengerDisplay(); // Update display with persistent values
            initPassengerSelectors(); // Re-init selectors to match persistent values


            if (fromInput) {
                fromInput.addEventListener('input', function () {
                    filterDatalist(this, 'origin-suggestions', 'origin');
                    updateLocationDisplay('from_location', 'from_display', 'from_subtext');
                });

                fromInput.addEventListener('change', () => {
                    updateLocationDisplay('from_location', 'from_display', 'from_subtext');
                    // Client Req 2: Auto Focus To
                    if (this.value && toInput) {
                        toInput.focus();
                    }
                });

                fromInput.addEventListener('focus', function () {
                    // Clear options on focus if input is empty
                    if (!this.value.trim()) {
                        const datalist = document.getElementById('origin-suggestions');
                        if (datalist) {
                            datalist.innerHTML = '';
                        }
                    }
                });
            }

            if (toInput) {
                toInput.addEventListener('input', function () {
                    filterDatalist(this, 'destination-suggestions', 'destination');
                    updateLocationDisplay('to_location', 'to_display', 'to_subtext');
                });

                toInput.addEventListener('change', () => updateLocationDisplay('to_location', 'to_display', 'to_subtext'));

                toInput.addEventListener('focus', function () {
                    // Clear options on focus if input is empty
                    if (!this.value.trim()) {
                        const datalist = document.getElementById('destination-suggestions');
                        if (datalist) {
                            datalist.innerHTML = '';
                        }
                    }
                });
            }

            if (travelDateInput) {
                travelDateInput.addEventListener('change', () => {
                    updateDateDisplay('travel_date', 'departure_display', 'departure_subtext');
                    if (returnDateInput && returnDateInput.value) {
                        returnDateInput.min = travelDateInput.value;
                    }
                });
            }

            if (returnDateInput) {
                returnDateInput.addEventListener('change', () => updateDateDisplay('return_date', 'return_display', 'return_subtext'));
            }


            // Make display cards clickable
            document.getElementById('from_display_card').addEventListener('click', () => fromInput.focus());
            document.getElementById('to_display_card').addEventListener('click', () => toInput.focus());
            document.getElementById('departure_display_card').addEventListener('click', () => travelDateInput.focus());
            document.getElementById('return_display_card').addEventListener('click', () => {
                // Client Req 3: Auto Switch to Round Trip
                if (tripReturnBtn && !tripReturnBtn.classList.contains('active')) {
                    tripReturnBtn.click();
                }
                setTimeout(() => { if (returnDateInput) returnDateInput.focus(); }, 100);
            });

            // Passenger display card - open modal
            const passengerDisplayCard = document.getElementById('passenger_display_card');
            if (passengerDisplayCard) {
                passengerDisplayCard.addEventListener('click', openPassengerModal);
            }

            // Apply button - apply passenger selection
            const applyBtn = document.querySelector('.modal-apply-btn');
            if (applyBtn) {
                applyBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    applyPassengerSelection();
                });
            }
        });
    })();
    
    // Flight Type Selection Function with Direct Style Changes
    function selectFlightType(type) {
        // Update radio inputs
        document.getElementById('flight_any').checked = (type === 'any');
        document.getElementById('flight_direct').checked = (type === 'direct');
        document.getElementById('flight_via').checked = (type === 'via');
        
        // Get all button IDs
        const btnAny = document.getElementById('btn_flight_any');
        const btnDirect = document.getElementById('btn_flight_direct');
        const btnVia = document.getElementById('btn_flight_via');
        
        // Reset all buttons to default style (gray)
        if (btnAny) {
            btnAny.style.backgroundColor = 'white';
            btnAny.style.borderColor = '#d1d5db';
            btnAny.style.color = '#374151';
        }
        if (btnDirect) {
            btnDirect.style.backgroundColor = 'white';
            btnDirect.style.borderColor = '#d1d5db';
            btnDirect.style.color = '#374151';
        }
        if (btnVia) {
            btnVia.style.backgroundColor = 'white';
            btnVia.style.borderColor = '#d1d5db';
            btnVia.style.color = '#374151';
        }
        
        // Apply active style to selected button (blue)
        if (type === 'any' && btnAny) {
            btnAny.style.backgroundColor = '#2563eb';
            btnAny.style.borderColor = '#2563eb';
            btnAny.style.color = 'white';
        } else if (type === 'direct' && btnDirect) {
            btnDirect.style.backgroundColor = '#2563eb';
            btnDirect.style.borderColor = '#2563eb';
            btnDirect.style.color = 'white';
        } else if (type === 'via' && btnVia) {
            btnVia.style.backgroundColor = '#2563eb';
            btnVia.style.borderColor = '#2563eb';
            btnVia.style.color = 'white';
        }
        
        // Mobile buttons (if they exist)
        const btnAnyMobile = document.getElementById('btn_flight_any_mobile');
        const btnDirectMobile = document.getElementById('btn_flight_direct_mobile');
        const btnViaMobile = document.getElementById('btn_flight_via_mobile');
        
        if (btnAnyMobile && btnDirectMobile && btnViaMobile) {
            // Reset mobile buttons
            btnAnyMobile.style.backgroundColor = 'white';
            btnAnyMobile.style.borderColor = '#d1d5db';
            btnAnyMobile.style.color = '#374151';
            
            btnDirectMobile.style.backgroundColor = 'white';
            btnDirectMobile.style.borderColor = '#d1d5db';
            btnDirectMobile.style.color = '#374151';
            
            btnViaMobile.style.backgroundColor = 'white';
            btnViaMobile.style.borderColor = '#d1d5db';
            btnViaMobile.style.color = '#374151';
            
            // Apply active style to selected mobile button
            if (type === 'any') {
                btnAnyMobile.style.backgroundColor = '#2563eb';
                btnAnyMobile.style.borderColor = '#2563eb';
                btnAnyMobile.style.color = 'white';
            } else if (type === 'direct') {
                btnDirectMobile.style.backgroundColor = '#2563eb';
                btnDirectMobile.style.borderColor = '#2563eb';
                btnDirectMobile.style.color = 'white';
            } else if (type === 'via') {
                btnViaMobile.style.backgroundColor = '#2563eb';
                btnViaMobile.style.borderColor = '#2563eb';
                btnViaMobile.style.color = 'white';
            }
        }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            selectFlightType('any'); // Default to 'any'
        }, 100);
    });
</script>
{% endblock %}