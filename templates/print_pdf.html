{% load travel_filters %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>E-Ticket - {{ booking.booking_reference }}</title>
    <style>
        @page {
            size: A4;
            margin: 0.5cm;
        }

        body {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 10pt;
            color: #333;
            line-height: 1.3;
            margin: 0;
            padding: 20px;
        }

        /* Helpers */
        .text-bold {
            font-weight: bold;
        }

        .text-blue {
            color: #2c3e50;
        }

        .text-small {
            font-size: 8pt;
        }

        .text-xs {
            font-size: 7pt;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        td,
        th {
            padding: 5px;
            vertical-align: top;
        }

        /* Header */
        .header-section {
            border: 2px solid #2c3e50;
            margin-bottom: 2px;
            padding: 10px;
        }

        .agency-name {
            font-size: 12pt;
            font-weight: bold;
            color: #2c3e50;
        }

        .header-info {
            font-size: 9pt;
            margin-top: 8px;
        }
        
        .header-info table td {
            padding: 2px 0;
            vertical-align: top;
        }

        /* Blue Bar Title */
        .blue-bar {
            background-color: #d1efff;
            /* Light blue */
            border: 1px solid #2c3e50;
            border-top: none;
            color: #000;
            text-align: center;
            font-weight: bold;
            padding: 5px;
            font-size: 11pt;
            margin-bottom: 2px;
        }

        /* Sections */
        .section-box {
            border: 1px solid #2c3e50;
            border-top: none;
            margin-bottom: 0;
            padding: 10px;
        }

        .section-title {
            color: #2c3e50;
            font-weight: bold;
            text-decoration: underline;
            margin-bottom: 10px;
            font-size: 10pt;
        }

        /* Flight Summary Table */
        .flight-summary-table th {
            background-color: #e0e0e0;
            font-weight: normal;
            text-align: left;
            font-size: 9pt;
            border: none;
        }

        .flight-summary-table td {
            font-size: 9pt;
        }

        /* References Section */
        .ref-table td {
            vertical-align: top;
        }

        /* Detailed Itinerary */
        .itinerary-table th {
            background-color: #e0e0e0;
            font-weight: normal;
            text-align: left;
            font-size: 9pt;
        }

        /* Services Bar */
        .services-bar {
            background-color: #e0e0e0;
            padding: 5px;
            font-weight: bold;
            font-size: 9pt;
            border: 1px solid #2c3e50;
            border-top: none;
        }

        /* Footer / Legal */
        .legal-section {
            border: 1px solid #2c3e50;
            border-top: none;
            padding: 10px;
            font-size: 7pt;
            color: #555;
            text-align: justify;
        }

        .important-note {
            font-weight: bold;
            font-size: 9pt;
            margin: 10px 0;
            color: #000;
        }

        /* Web View Buttons */
        @media screen {
            .no-print {
                padding: 15px;
                background: #f1f1f1;
                text-align: center;
                margin-bottom: 20px;
            }

            .btn {
                background: #0056b3;
                color: white;
                text-decoration: none;
                padding: 8px 15px;
                border: none;
                cursor: pointer;
            }
        }

        @media print {
            .no-print {
                display: none;
            }
        }
    </style>
</head>

<body>

    <!-- Web Buttons -->
    {% if is_web_view %}
    <div class="no-print">
        <a href="{% url 'download_ticket_pdf' booking.id %}" class="btn">Download PDF</a>
        <button onclick="window.print()" class="btn" style="background: #28a745;">Print</button>
    </div>
    {% endif %}

    <!-- 1. Header Section -->
    <div class="header-section">
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 8px;">
            {% if user_profile and user_profile.logo %}
            <div style="flex-shrink: 0;">
                <img src="{{ user_profile.logo.url }}" alt="Company Logo" style="max-height: 60px; max-width: 150px; object-fit: contain;">
            </div>
            {% endif %}
            <div class="agency-name" style="flex: 1;">
                {% if user_profile and user_profile.company_name %}
                {{ user_profile.company_name|upper }}
                {% else %}
                SAFAR ZONE TRAVELS
                {% endif %}
            </div>
        </div>
        <div class="header-info">
            <table style="width: 100%; font-size: 9pt;">
                {% if user_profile and user_profile.address %}
                <tr>
                    <td width="80" style="vertical-align: top;">Address</td>
                    <td>: {{ user_profile.address }}</td>
                </tr>
                {% endif %}
                {% if user_profile and user_profile.city %}
                <tr>
                    <td width="80" style="vertical-align: top;">City</td>
                    <td>: {{ user_profile.city }}{% if user_profile.state %}, {{ user_profile.state }}{% endif %}{% if user_profile.pincode %} - {{ user_profile.pincode }}{% endif %}</td>
                </tr>
                {% elif user_profile and user_profile.state %}
                <tr>
                    <td width="80" style="vertical-align: top;">State</td>
                    <td>: {{ user_profile.state }}{% if user_profile.pincode %} - {{ user_profile.pincode }}{% endif %}</td>
                </tr>
                {% elif user_profile and user_profile.pincode %}
                <tr>
                    <td width="80" style="vertical-align: top;">Pin Code</td>
                    <td>: {{ user_profile.pincode }}</td>
                </tr>
                {% endif %}
                {% if user_profile and user_profile.country %}
                <tr>
                    <td width="80" style="vertical-align: top;">Country</td>
                    <td>: {{ user_profile.country }}</td>
                </tr>
                {% endif %}
                <tr>
                    <td width="80" style="vertical-align: top;">MOB</td>
                    <td>: {% if user and user.phone %}{{ user.phone }}{% elif user_profile and user_profile.user.phone %}{{ user_profile.user.phone }}{% else %}7379672019{% endif %}</td>
                </tr>
                <tr>
                    <td width="80" style="vertical-align: top;">Email</td>
                    <td>: {% if user and user.email %}{{ user.email }}{% elif user_profile and user_profile.user.email %}{{ user_profile.user.email }}{% else %}safarzonetravels@gmail.com{% endif %}</td>
                </tr>
                {% if user_profile and user_profile.gst_number %}
                <tr>
                    <td width="80" style="vertical-align: top;">GST No</td>
                    <td>: {{ user_profile.gst_number }}</td>
                </tr>
                {% endif %}
            </table>
        </div>
    </div>

    <!-- 2. Blue Title Bar -->
    <div class="blue-bar">
        Airline e-Ticket
    </div>

    <!-- 3. Traveller Information -->
    <div class="section-box">
        <div class="section-title">Traveller Information</div>
        <div style="margin-bottom: 10px;">
            {% for passenger in booking.passengers.all %}
            <div>{{ forloop.counter }}. {{ passenger.get_title_display }} {{ passenger.first_name }} {{ passenger.last_name }}</div>
            {% empty %}
            <div>TBA TBA</div>
            {% endfor %}
        </div>

        <table class="flight-summary-table">
            <tr>
                <th>Departure</th>
                <th>From</th>
                <th>To</th>
                <th>Flight</th>
                <th>Dep.Tmnl</th>
                <th>Tour Code</th>
                <th>Airline</th>
            </tr>
            <tr>
                <td>{{ booking.schedule.departure_date|date:"d/m/Y" }} {{ booking.schedule.route.departure_time|time:"H:i" }}</td>
                <td>{{ booking.schedule.route.from_location }}</td>
                <td>{{ booking.schedule.route.to_location }}</td>
                <td>{{ booking.schedule.route.carrier_number }}</td>
                <td>{% if booking.schedule.route.departure_terminal %}{{ booking.schedule.route.departure_terminal }}{% else %}-{% endif %}</td>
                <td>-</td>
                <td>{{ booking.schedule.route.name|default:"IndiGo" }}</td>
            </tr>
    </table>
    </div>

    <!-- 4. Booking Reference -->
    <div class="section-box">
        <div class="section-title">Booking Reference</div>
        <table style="width: 100%; font-size: 9pt;">
            <tr>
                <td width="100">Booking Ref</td>
                <td>: {{ booking.booking_reference }}</td>
            </tr>
            <tr>
                <td>Airline Ref</td>
                <td>: {% if booking.schedule.pnr %}{{ booking.schedule.pnr }}{% else %}PENDING{% endif %}</td>
            </tr>
        </table>
    </div>

    <!-- 5. Detailed Itinerary -->
    <div class="section-box">
        <div class="section-title">Detailed Itinerary</div>

        <!-- Flight 1 -->
        <div style="margin-bottom: 20px;">
            <div style="font-weight: bold; margin-bottom: 5px;">
                {% with from_code=airport_codes|get_item:booking.schedule.route.from_location|default:booking.schedule.route.from_location|slice:":3"|upper to_code=airport_codes|get_item:booking.schedule.route.to_location|default:booking.schedule.route.to_location|slice:":3"|upper %}
                {{ from_code }} - {{ to_code }}
                {% endwith %}
            </div>
            <div style="font-size: 8pt; color: #555; margin-bottom: 5px;">
                Flight No : {{ booking.schedule.route.carrier_number }} |
                Travel Class : Economy |
                Issue Date : {{ booking.created_at|date:"Y-m-d" }} |
                Travel Date : {{ booking.schedule.departure_date|date:"d/m/Y" }}
            </div>

            <table class="itinerary-table">
                <tr>
                    <th width="15%">Airline</th>
                    <th width="15%">Arr Terminal</th>
                    <th width="25%">Departure</th>
                    <th width="25%">Arrival</th>
                    <th width="20%">Duration</th>
                </tr>
                <tr>
                    <td>
                        {% if booking.schedule.route.airline_name %}
                            {{ booking.schedule.route.airline_name }}
                        {% else %}
                            {{ booking.schedule.route.name|default:"IndiGo" }}
                        {% endif %}
                    </td>
                    <td>{% if booking.schedule.route.arrival_terminal %}{{ booking.schedule.route.arrival_terminal }}{% else %}-{% endif %}</td>
                    <td>{{ booking.schedule.departure_date|date:"d/m/Y" }} {{ booking.schedule.route.departure_time|time:"H:i" }}</td>
                    <td>
                        {% if booking.schedule.arrival_date %}
                        {{ booking.schedule.arrival_date|date:"d/m/Y" }}
                        {% else %}
                        {{ booking.schedule.departure_date|date:"d/m/Y" }}
                        {% endif %}
                        {{ booking.schedule.route.arrival_time|time:"H:i" }}
                    </td>
                    <td>{{ booking.schedule.route.formatted_duration }} Hrs</td>
                </tr>
            </table>
        </div>

        {% if booking.return_schedule %}
        <div style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px;">
            <div style="font-weight: bold; margin-bottom: 5px;">
                {{ booking.return_schedule.route.from_location|slice:":3"|upper }} - {{
                booking.return_schedule.route.to_location|slice:":3"|upper }}
            </div>
            <div style="font-size: 8pt; color: #555; margin-bottom: 5px;">
                Flight No : {{ booking.return_schedule.route.carrier_number }} |
                Travel Class : Economy |
                Travel Date : {{ booking.return_schedule.departure_date|date:"d/m/Y" }}
            </div>
            <table class="itinerary-table">
                <tr>
                    <th width="15%">Airline</th>
                    <th width="15%">Arr Terminal</th>
                    <th width="25%">Departure</th>
                    <th width="25%">Arrival</th>
                    <th width="20%">Duration</th>
            </tr>
                <tr>
                    <td>
                        {% if booking.return_schedule and booking.return_schedule.route.get_airline_logo_url %}
                        <img src="{{ booking.return_schedule.route.get_airline_logo_url }}"
                            alt="{{ booking.return_schedule.route.airline_name|default:'Airline' }}" style="height: 18px; max-width: 70px; object-fit: contain;">
                        {% elif booking.schedule.route.get_airline_logo_url %}
                        <img src="{{ booking.schedule.route.get_airline_logo_url }}"
                            alt="{{ booking.schedule.route.airline_name|default:'Airline' }}" style="height: 18px; max-width: 70px; object-fit: contain;">
                        {% endif %}
                    </td>
                    <td>{% if booking.return_schedule.route.arrival_terminal %}{{
                        booking.return_schedule.route.arrival_terminal }}{% else %}-{% endif %}</td>
                    <td>{{ booking.return_schedule.departure_date|date:"d/m/Y" }} {{
                        booking.return_schedule.route.departure_time|time:"H:i" }}</td>
                    <td>
                        {% if booking.return_schedule.arrival_date %}
                        {{ booking.return_schedule.arrival_date|date:"d/m/Y" }}
                        {% else %}
                        {{ booking.return_schedule.departure_date|date:"d/m/Y" }}
                        {% endif %}
                        {{ booking.return_schedule.route.arrival_time|time:"H:i" }}
                    </td>
                    <td>{{ booking.return_schedule.route.formatted_duration }}</td>
            </tr>
    </table>
        </div>
        {% endif %}

    </div>

    <!-- 5.5. Fare Breakdown (if not hiding fare) -->
    {% if not hide_fare %}
    <div class="section-box">
        <div class="section-title">Fare Breakdown</div>
        <table style="width: 100%; font-size: 9pt;">
            <tr>
                <td width="200">Base Fare:</td>
                <td style="text-align: right; font-weight: bold;">₹{{ booking.base_fare|floatformat:2 }}</td>
            </tr>
            {% if booking.tax_amount > 0 %}
            <tr>
                <td>Taxes & Fees:</td>
                <td style="text-align: right; font-weight: bold;">₹{{ booking.tax_amount|floatformat:2 }}</td>
            </tr>
            {% endif %}
            {% if booking.discount_amount > 0 %}
            <tr>
                <td>Discount:</td>
                <td style="text-align: right; font-weight: bold; color: #10b981;">-₹{{ booking.discount_amount|floatformat:2 }}</td>
            </tr>
            {% endif %}
            {% if convenience_fee and convenience_fee > 0 %}
            <tr>
                <td>Convenience Fee:</td>
                <td style="text-align: right; font-weight: bold; color: #f59e0b;">+₹{{ convenience_fee|floatformat:2 }}</td>
            </tr>
            {% endif %}
            <tr style="border-top: 2px solid #2c3e50; margin-top: 5px;">
                <td style="font-weight: bold; font-size: 11pt; padding-top: 10px;">Total Amount:</td>
                <td style="text-align: right; font-weight: bold; font-size: 11pt; padding-top: 10px;">
                    ₹{% if convenience_fee and convenience_fee > 0 %}{{ total_with_fee|floatformat:2 }}{% else %}{{ booking.total_amount|floatformat:2 }}{% endif %}
                </td>
            </tr>
        </table>
    </div>
    {% endif %}

    <!-- 6. In-Flight Services -->
    <div style="border: 1px solid #2c3e50; border-top: none;">
        <div class="section-title" style="padding: 10px 10px 0 10px;">In-Flight Services</div>
        <div class="services-bar" style="border: none; margin-top: 5px;">
        Adult Cabin Baggage: 07 Kilo | Free Baggage: 30 Kilo<br>
            Infant Cabin Baggage: 10 Kilo | Free Baggage: NIL Kilo
        </div>
    </div>

    <!-- 7. Footer / Legal -->
    <div class="legal-section">
        <div class="text-bold" style="font-size: 9pt;">Positive identification required for airport check in</div>
        <br>
        <span class="text-bold">Notice:</span><br>
        CARRIAGE AND OTHER SERVICES PROVIDED BY THE CARRIER ARE SUBJECT TO CONDITIONS OF CARRIAGE, WHICH ARE HEREBY
        INCORPORATED BY REFERENCE. THESE CONDITIONS MAY BE OBTAINED FROM THE ISSUING CARRIER. PASSENGERS ON A JOURNEY
        INVOLVING AN ULTIMATE DESTINATION OR A STOP IN A COUNTRY OTHER THAN THE COUNTRY OF DEPARTURE ARE ADVISED THAT
        INTERNATIONAL TREATIES KNOWN AS THE MONTREAL CONVENTION, OR ITS PREDECESSOR, THE WARSAW CONVENTION, INCLUDING
        ITS AMENDMENTS THE WARSAW CONVENTION SYSTEM, MAY APPLY TO THE ENTIRE JOURNEY, INCLUDING ANY PORTION THEREOF
        WITHIN A COUNTRY. FOR SUCH PASSENGERS, THE APPLICABLE TREATY, INCLUDING SPECIAL CONTRACTS OF CARRIAGE EMBODIED
        IN ANY APPLICABLE TARIFFS, GOVERNS AND MAY LIMIT THE LIABILITY OF THE CARRIER. CHECK WITH YOUR CARRIER FOR MORE
        INFORMATION. IATA Ticket Notice. http://www.iatatravelcentre.com/e-ticket-notice/General/English/ (Subject to
        change without prior notice)

        <div class="important-note">
            Important note: The courts of {% if user_profile and user_profile.city %}{{ user_profile.city }}{% else %}Mumbai{% endif %} have jurisdiction to entertain any suits or legal proceeding
        </div>

        <span class="text-bold">Safety Travel Advisory during COVID-19</span><br>
        - All customers should wear a mask, face shield, gown (if applicable) and sanitize hands before boarding.<br>
        - Mask must cover nose and mouth throughout the journey, removable only for eating/drinking.<br>
        - Maintain social distancing.<br>
        - Hold a VALID Covid-19 Test certificate issued within 48 hours of sample collection, with accurate date/time of collection and reporting.<br>
        - Certificate must indicate a NEGATIVE test result, described in ARABIC or ENGLISH, from a certified lab at the original point of destination.<br>
        - MANDATORY QR code linked to the original report for verification by airlines and Dubai Health Authority (DHA) upon arrival in Dubai Airports.<br>
        - Adhere to announcements and directives from ground staff/crew.<br>
        - Familiarize with guidelines from Indian Ministry of Civil Aviation via provided links:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;https://www.civilaviation.gov.in/sites/default/files/Guidelines_for_Air_Passengers_21 May.pdf<br>
        &nbsp;&nbsp;&nbsp;&nbsp;https://www.civilaviation.gov.in/sites/default/files/State_wise_quarantine_regulation-converted.pdf<br>
        - Details should also be confirmed from the website of the concerned State Government.<br>
        - Caution: Customers are advised to check the latest travel guidelines and requirements before travel.
</div>

    <!-- Action Buttons Section (Only shown in web view, not in PDF) -->
    {% if is_web_view %}
    <div class="action-buttons-section" style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; text-align: center;">
        <h3 style="color: white; font-size: 14pt; margin-bottom: 20px; font-weight: bold;">
            <i class="fas fa-tools"></i> Ticket Actions
        </h3>
        
        <!-- Fare Input Section -->
        <div id="fareInputSection" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; max-width: 400px; margin-left: auto; margin-right: auto;">
            <label style="display: block; color: #333; font-weight: bold; margin-bottom: 10px; font-size: 12pt;">
                <i class="fas fa-rupee-sign"></i> Increase Fare (Convenience Fee)
            </label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="number" id="convenienceFee" min="0" step="0.01" value="0" 
                       placeholder="Enter amount" 
                       style="flex: 1; padding: 12px; border: 2px solid #667eea; border-radius: 6px; font-size: 14pt; font-weight: bold; text-align: center;">
                <span style="color: #333; font-weight: bold; font-size: 14pt;">₹</span>
            </div>
            <p id="totalWithFee" style="margin-top: 10px; color: #10b981; font-weight: bold; font-size: 13pt;">
                Total: ₹{{ booking.total_amount|floatformat:2 }}
            </p>
        </div>
        
        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <!-- Print with Fare Button -->
            <button onclick="printWithFare()" 
                    style="display: inline-flex; align-items: center; gap: 10px; padding: 12px 24px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 11pt; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: transform 0.2s;"
                    onmouseover="this.style.transform='scale(1.05)'"
                    onmouseout="this.style.transform='scale(1)'">
                <i class="fas fa-print" style="font-size: 14pt;"></i>
                <span>Print with Fare</span>
            </button>
            
            <!-- Print without Fare Button -->
            <button onclick="printWithoutFare()" 
                    style="display: inline-flex; align-items: center; gap: 10px; padding: 12px 24px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 11pt; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: transform 0.2s;"
                    onmouseover="this.style.transform='scale(1.05)'"
                    onmouseout="this.style.transform='scale(1)'">
                <i class="fas fa-file-pdf" style="font-size: 14pt;"></i>
                <span>Print without Fare</span>
            </button>
        </div>
    </div>
    {% endif %}

    <style>
        /* Hide action buttons when printing */
        @media print {
            .action-buttons-section {
                display: none !important;
            }
        }
    </style>
    
    <!-- Font Awesome for Icons -->
    {% if is_web_view %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        const bookingId = {{ booking.id }};
        const baseTotal = {{ booking.total_amount }};
        
        // Update total when fare changes
        document.getElementById('convenienceFee').addEventListener('input', function() {
            const fee = parseFloat(this.value) || 0;
            const newTotal = baseTotal + fee;
            document.getElementById('totalWithFee').textContent = `Total: ₹${newTotal.toFixed(2)}`;
        });
        
        function printWithFare() {
            const fee = parseFloat(document.getElementById('convenienceFee').value) || 0;
            if (fee < 0) {
                alert('Fare amount cannot be negative!');
                return;
            }
            
            // Open PDF with convenience fee parameter
            const url = `/ticket/${bookingId}/pdf/?convenience_fee=${fee}&view=true`;
            window.open(url, '_blank');
        }
        
        function printWithoutFare() {
            // Open PDF without fare
            const url = `/ticket/${bookingId}/pdf/?hide_fare=true&view=true`;
            window.open(url, '_blank');
        }
    </script>
    {% endif %}

</body>

</html>