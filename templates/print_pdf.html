{% load travel_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airline e-Ticket - {{ booking.booking_reference }}</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        @media print {
            body {
                background: white;
            }
            .ticket-container {
                margin: 0;
                border: none;
                box-shadow: none;
            }
            .action-buttons {
                display: none;
            }
        }
        body {
            background: #f7f7f7;
            font-family: Arial, sans-serif;
        }
        .ticket-container {
            background: white;
            border: 1px solid #4a4a4a;
            padding: 20px;
            margin: 20px auto;
            width: 85%;
            max-width: 900px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-title {
            background: #c8e9f3;
            font-weight: bold;
            text-align: center;
            padding: 8px;
            margin: 15px 0;
            font-size: 20px;
        }
        .section-title {
            font-weight: bold;
            text-decoration: underline;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        .info-table td {
            padding: 4px 8px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }
        .small-text {
            font-size: 14px;
        }
        .table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .action-buttons {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .action-buttons .btn {
            margin: 0 10px;
        }
    </style>
</head>
<body>

<div class="action-buttons">
    <a href="{% url 'download_ticket_pdf' booking.id %}" class="btn btn-primary" target="_blank">Download PDF</a>
    <a href="{% url 'print_ticket_pdf' booking.id %}" class="btn btn-success" target="_blank">Print Ticket</a>
    <button onclick="window.print()" class="btn btn-info">Print This Page</button>
</div>

<div class="ticket-container">

    <!-- Top Left Details -->
    <div class="row">
        <div class="col-12">
            <p class="mb-1"><strong>SAFAR ZONE TRAVELS</strong></p>
            <p class="mb-1 small-text">MOB : 7379672019</p>
            <p class="mb-1 small-text">Email : safarzonetravels@gmail.com</p>
        </div>
    </div>

    <!-- Title -->
    <div class="header-title">Airline e-Ticket</div>

    <!-- Traveller Information -->
    <p class="section-title">Traveller Information</p>

    <table class="table table-bordered small-text">
        <thead class="table-light">
            <tr>
                <th>Departure</th>
                <th>From</th>
                <th>To</th>
                <th>Flight</th>
                <th>Dep.Tmnl</th>
                <th>Tour Code</th>
                <th>Airline</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{{ booking.schedule.departure_date|date:"d/m/Y" }} {{ booking.schedule.route.departure_time|time:"H:i" }}</td>
                <td>{{ booking.schedule.route.from_location }}</td>
                <td>{{ booking.schedule.route.to_location }}</td>
                <td>{{ booking.schedule.route.carrier_number }}</td>
                <td>{% if booking.schedule.route.departure_terminal %}{{ booking.schedule.route.departure_terminal }}{% else %}-{% endif %}</td>
                <td>-</td>
                <td>{{ booking.schedule.route.name|default:"Airline" }}</td>
            </tr>
        </tbody>
    </table>

    <!-- e-Ticket Numbers and Booking Reference in two columns -->
    <div class="row">
        <div class="col-md-6">
            <p class="section-title">e-Ticket Numbers</p>
            <table class="table table-borderless small-text">
                {% for passenger in booking.passengers.all %}
                <tr>
                    <td>{% if passenger.pnr %}{{ passenger.pnr }}{% else %}--{% endif %}</td>
                </tr>
                {% empty %}
                <tr><td>--</td></tr>
                <tr><td>--</td></tr>
                <tr><td>--</td></tr>
                {% endfor %}
            </table>
        </div>
        <div class="col-md-6">
            <p class="section-title">Booking Reference</p>
            <table class="table table-borderless small-text">
                <tr>
                    <td><strong>Booking Ref:</strong></td>
                    <td>{{ booking.booking_reference }}</td>
                </tr>
                <tr>
                    <td><strong>Airline Ref:</strong></td>
                    <td>{% if booking.passengers.first.pnr %}{{ booking.passengers.first.pnr }}{% else %}{{ booking.booking_reference }}{% endif %}</td>
                </tr>
                <tr>
                    <td><strong>CRS Ref:</strong></td>
                    <td>{% if booking.passengers.first.pnr %}{{ booking.passengers.first.pnr }}{% else %}{{ booking.booking_reference }}{% endif %}</td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Detailed Itinerary -->
    <p class="section-title">Detailed Itinerary</p>

    {% with from_code=airport_codes|get_item:booking.schedule.route.from_location|default:booking.schedule.route.from_location|slice:":3"|upper to_code=airport_codes|get_item:booking.schedule.route.to_location|default:booking.schedule.route.to_location|slice:":3"|upper %}
    <p class="small-text"><strong>{{ from_code }} â†’ {{ to_code }}</strong><br>
        Flight No : {{ booking.schedule.route.carrier_number }} | Travel Class : Economy | Issue Date : {{ booking.created_at|date:"d/m/Y" }} | Travel Date : {{ booking.schedule.departure_date|date:"d/m/Y" }}
    </p>
    {% endwith %}

    <table class="table table-bordered small-text">
        <thead class="table-light">
            <tr>
                <th>Airline</th>
                <th>Arr Terminal</th>
                <th>Departure</th>
                <th>Arrival</th>
                <th>Duration</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{{ booking.schedule.route.name|default:"Airline" }}</td>
                <td>{% if booking.schedule.route.arrival_terminal %}{{ booking.schedule.route.arrival_terminal }}{% else %}-{% endif %}</td>
                <td>{{ booking.schedule.departure_date|date:"d/m/Y" }} {{ booking.schedule.route.departure_time|time:"H:i" }}</td>
                <td>
                    {% if booking.schedule.arrival_date %}
                        {{ booking.schedule.arrival_date|date:"d/m/Y" }} {{ booking.schedule.route.arrival_time|time:"H:i" }}
                    {% else %}
                        {{ booking.schedule.departure_date|date:"d/m/Y" }} {{ booking.schedule.route.arrival_time|time:"H:i" }}
                    {% endif %}
                </td>
                <td>{{ booking.schedule.route.formatted_duration }}</td>
            </tr>
        </tbody>
    </table>

    <!-- In-flight services -->
    <p class="section-title">In-Flight Services</p>

    <p class="small-text">
        Adult Cabin Baggage: 07 Kilo | Free Baggage: 30 Kilo<br>
        Infant Cabin Baggage: SS Kilo | Free Baggage: SS Kilo
    </p>

    <!-- Passenger Details -->
    {% if booking.passengers.exists %}
    <p class="section-title">Passenger Details</p>
    <table class="table table-bordered small-text">
        <thead class="table-light">
            <tr>
                <th>Name</th>
                <th>PNR</th>
                <th>Type</th>
                <th>Date of Birth</th>
            </tr>
        </thead>
        <tbody>
            {% for passenger in booking.passengers.all %}
            <tr>
                <td>{{ passenger.get_title_display }} {{ passenger.first_name }} {{ passenger.last_name }}</td>
                <td>{% if passenger.pnr %}{{ passenger.pnr }}{% else %}--{% endif %}</td>
                <td>{{ passenger.get_passenger_type_display }}</td>
                <td>{{ passenger.date_of_birth|date:"d/m/Y" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

</div>

</body>
</html>
