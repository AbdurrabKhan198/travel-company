{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% load travel_filters %}

{% block title %}Search Flights - Safar Zone Travels{% endblock %}

{% block extra_css %}
<style>
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .flight-card-animate {
        animation: slideIn 0.5s ease-out forwards;
    }
    
    /* Exclude non-refundable badge from any parent animations */
    .flight-card-animate .non-refundable-badge,
    .flight-card-animate .non-refundable-badge * {
        animation: none !important;
        transition: none !important;
    }
    
    /* Ensure Non-Refundable badge is always visible - Maximum Protection */
    .non-refundable-badge,
    .non-refundable-badge * {
        display: inline-block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        z-index: 9999 !important;
        animation: none !important;
        transition: none !important;
        transform: none !important;
        will-change: auto !important;
    }
    
    /* Prevent any fade or hide animations */
    @keyframes keepVisible {
        0%, 100% {
            opacity: 1 !important;
            visibility: visible !important;
            display: inline-block !important;
        }
    }
    
    .non-refundable-badge {
        animation: keepVisible 0.1s infinite !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-indigo-50 py-8">
    <div class="container mx-auto px-4">
        <!-- Search Summary Header -->
        <div class="bg-gradient-to-r from-sky-500 via-blue-600 to-indigo-700 rounded-3xl shadow-2xl p-8 mb-8 text-white animate-fade-in-up">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
                <div class="flex-1">
                    <div class="flex flex-wrap items-center gap-6 mb-4">
                        <!-- From -->
                        <div class="text-center lg:text-left">
                            <p class="text-white/80 text-sm mb-1">From</p>
                            <h2 class="text-3xl font-bold">
                                {{ from_location }}
                                {% if from_airport_code %}
                                <span class="text-yellow-300 text-xl">({{ from_airport_code }})</span>
                                {% endif %}
                            </h2>
                        </div>
                        
                        <!-- Arrow -->
                        <div class="hidden lg:block">
                            <i class="fas fa-arrow-right text-3xl text-white/60"></i>
                        </div>
                        
                        <!-- To -->
                        <div class="text-center lg:text-left">
                            <p class="text-white/80 text-sm mb-1">To</p>
                            <h2 class="text-3xl font-bold">
                                {{ to_location }}
                                {% if to_airport_code %}
                                <span class="text-yellow-300 text-xl">({{ to_airport_code }})</span>
                                {% endif %}
                            </h2>
                            </div>
                        </div>
                        
                    <!-- Search Details -->
                    <div class="flex flex-wrap items-center gap-6">
                                {% if travel_date %}
                        <div class="flex items-center space-x-2 bg-white/20 backdrop-blur-md rounded-lg px-4 py-2">
                            <i class="fas fa-calendar-alt"></i>
                            <span class="font-semibold">{{ travel_date|date:"D, d M Y" }}</span>
                                </div>
                                {% endif %}
                                
                                {% if passengers %}
                        <div class="flex items-center space-x-2 bg-white/20 backdrop-blur-md rounded-lg px-4 py-2">
                            <i class="fas fa-users"></i>
                            <span class="font-semibold">{{ passengers }} Passenger{{ passengers|pluralize }}</span>
                                </div>
                                {% endif %}
                                
                                {% if route_type %}
                        <div class="flex items-center space-x-2 bg-white/20 backdrop-blur-md rounded-lg px-4 py-2">
                            <i class="fas fa-{% if route_type == 'domestic' %}home{% else %}globe{% endif %}"></i>
                            <span class="font-semibold">{{ route_type|title }}</span>
                                </div>
                                {% endif %}
                    </div>
                </div>
                
                <!-- Modify Search Button -->
                <a href="{% url 'homepage' %}" class="px-6 py-3 bg-white text-sky-600 rounded-xl font-bold hover:bg-gray-100 transition-all duration-200 transform hover:scale-105 shadow-lg flex items-center space-x-2">
                    <i class="fas fa-edit"></i>
                    <span>Modify Search</span>
                </a>
        </div>
    </div>

    <!-- Results Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <div>
                {% if flights %}
                <h2 class="text-3xl font-bold text-gray-900 mb-2 flex items-center">
                    <i class="fas fa-plane-departure text-sky-500 mr-3"></i>
                    Available Flights 
                    <span class="ml-3 px-4 py-1 bg-sky-100 text-sky-700 rounded-full text-lg font-semibold">
                        {{ flights|length }}
                    </span>
                </h2>
                <p class="text-gray-600">Select your preferred flight and continue to booking</p>
                {% else %}
                <h2 class="text-3xl font-bold text-gray-900 mb-2 flex items-center">
                    <i class="fas fa-search text-gray-400 mr-3"></i>
                    No Flights Found
            </h2>
                <p class="text-gray-600">We couldn't find any flights matching your search criteria</p>
            {% endif %}
        </div>
    </div>

        <!-- Flight Results -->
        {% if flights %}
        <div class="space-y-6">
            {% for flight in flights %}
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden border-l-4 {% if flight.route.route_type == 'domestic' %}border-sky-500{% else %}border-green-500{% endif %} hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 flight-card-animate" style="animation-delay: {{ forloop.counter0|multiply:0.1 }}s">
                <div class="p-6">
                    <div class="grid md:grid-cols-12 gap-6 items-center">
                        <!-- Flight Route & Times -->
                        <div class="md:col-span-8">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900 mb-1">
                                        {{ flight.route.carrier_number }}
                                    </h3>
                                    <div class="flex items-center space-x-2 flex-wrap">
                                        <span class="px-3 py-1 {% if flight.route.route_type == 'domestic' %}bg-sky-100 text-sky-700{% else %}bg-green-100 text-green-700{% endif %} rounded-full text-xs font-semibold">
                                            {{ flight.route.route_type|title }}
                                        </span>
                                        <span class="text-sm text-gray-500">
                                            <i class="fas fa-chair mr-1"></i>{{ flight.available_seats }} seats left
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Flight Timeline -->
                            <div class="flex items-center justify-between">
                                <!-- Departure -->
                                <div class="text-center flex-1">
                                    <div class="text-3xl font-bold text-gray-900 mb-1">
                                        {{ flight.route.departure_time|time:"H:i" }}
                                </div>
                                    <div class="text-sm font-semibold text-gray-700 mb-1">
                                        {{ from_location }}
                                        </div>
                                    <div class="text-xs text-sky-600 font-semibold mb-1">
                                        {{ from_airport_code }}
                                    </div>
                                    <div class="text-xs text-gray-500 mb-1">
                                        {{ flight.departure_date|date:"d M Y" }}
                                </div>
                                    {% if flight.route.departure_terminal %}
                                    <div class="text-xs font-semibold text-purple-600 mt-1">
                                        <i class="fas fa-building mr-1"></i>Terminal {{ flight.route.departure_terminal }}
                                </div>
                                        {% endif %}
                        </div>
                        
                                <!-- Duration Line -->
                                <div class="flex-1 mx-4 relative">
                                    <div class="absolute inset-0 flex items-center">
                                        <div class="w-full border-t-2 border-dashed border-gray-300"></div>
                                        </div>
                                    <div class="relative flex justify-center">
                                        <div class="bg-white px-3 py-1 rounded-full shadow-lg border-2 border-sky-200">
                                            <i class="fas fa-plane text-sky-500"></i>
                                        </div>
                                        </div>
                                    <div class="text-center mt-2">
                                        <p class="text-sm font-semibold text-gray-700">{{ flight.route.formatted_duration }}</p>
                                        <p class="text-xs text-gray-500 mb-2">Non-stop</p>
                                        <!-- Non-Refundable Badge - Always Shown -->
                                        <div class="mt-2 non-refundable-badge" style="display: block !important; visibility: visible !important; opacity: 1 !important; animation: none !important; transition: none !important;">
                                            <span class="px-4 py-2 bg-red-500 text-white rounded-lg text-xs font-bold shadow-md border-2 border-red-600 inline-block non-refundable-badge" style="display: inline-block !important; visibility: visible !important; opacity: 1 !important; animation: none !important; transition: none !important; transform: none !important; position: relative !important; z-index: 9999 !important;">
                                                <i class="fas fa-ban mr-1" style="display: inline !important; visibility: visible !important; opacity: 1 !important;"></i>Non-Refundable
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Arrival -->
                                <div class="text-center flex-1">
                                    <div class="text-3xl font-bold text-gray-900 mb-1">
                                        {{ flight.route.arrival_time|time:"H:i" }}
                                            </div>
                                    <div class="text-sm font-semibold text-gray-700 mb-1">
                                        {{ to_location }}
                                        </div>
                                    <div class="text-xs text-sky-600 font-semibold mb-1">
                                        {{ to_airport_code }}
                                            </div>
                                    <div class="text-xs text-gray-500 mb-1">
                                        {{ flight.arrival_date|date:"d M Y" }}
                                        </div>
                                    {% if flight.route.arrival_terminal %}
                                    <div class="text-xs font-semibold text-purple-600 mt-1">
                                        <i class="fas fa-building mr-1"></i>Terminal {{ flight.route.arrival_terminal }}
                                            </div>
                                        {% endif %}
                                        </div>
                                            </div>
                                        </div>
                        
                        <!-- Price & Book Button -->
                        <div class="md:col-span-4 border-t md:border-t-0 md:border-l border-gray-200 pt-4 md:pt-0 md:pl-6">
                            <div class="text-center md:text-right mb-4">
                                <div class="text-4xl font-bold text-sky-600 mb-1">
                                    â‚¹{{ flight.price|floatformat:0 }}
                                    </div>
                                <div class="text-sm text-gray-600">per person</div>
                            </div>
                            
                            {% if flight.is_available and flight.available_seats >= passengers %}
                            <a href="{% url 'booking' flight.id %}?passengers={{ passengers }}" class="w-full block text-center px-6 py-4 bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                                <i class="fas fa-shopping-cart mr-2"></i>
                                Book Now
                            </a>
                                    {% else %}
                            <button disabled class="w-full px-6 py-4 bg-gray-300 text-gray-600 font-bold rounded-xl cursor-not-allowed">
                                <i class="fas fa-times-circle mr-2"></i>
                                Not Available
                            </button>
                                    {% endif %}
                            
                            <button onclick="toggleFlightDetails({{ flight.id }})" class="w-full mt-3 text-sm text-sky-600 hover:text-sky-700 font-semibold transition-colors">
                                <i class="fas fa-chevron-down mr-1" id="chevron-{{ flight.id }}"></i>
                                Flight Details
      </button>
    </div>
  </div>
                    
                    <!-- Flight Details (Collapsible) -->
                    <div id="details-{{ flight.id }}" class="hidden mt-6 pt-6 border-t border-gray-200">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-bold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-info-circle text-sky-500 mr-2"></i>
                                    Flight Information
                        </h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-xs text-gray-600 mb-1">Flight Number</p>
                                        <p class="font-semibold text-gray-900">{{ flight.route.carrier_number }}</p>
                            </div>
                                    <div>
                                        <p class="text-xs text-gray-600 mb-1">Duration</p>
                                        <p class="font-semibold text-gray-900">{{ flight.route.formatted_duration }}</p>
                            </div>
                                    <div>
                                        <p class="text-xs text-gray-600 mb-1">Available Seats</p>
                                        <p class="font-semibold text-gray-900">{{ flight.available_seats }} / {{ flight.total_seats }}</p>
                            </div>
                                    <div>
                                        <p class="text-xs text-gray-600 mb-1">Route Type</p>
                                        <p class="font-semibold text-gray-900">{{ flight.route.route_type|title }}</p>
                            </div>
                        </div>
                    </div>

                                <div>
                                <h4 class="font-bold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-utensils text-sky-500 mr-2"></i>
                                    Onboard Services
                        </h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
                                        <i class="fas fa-utensils text-sky-500"></i>
                                        <span class="text-sm font-medium text-gray-700">Meal Included</span>
                            </div>
                                    <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
                                        <i class="fas fa-wifi text-sky-500"></i>
                                        <span class="text-sm font-medium text-gray-700">Free WiFi</span>
                            </div>
                                    <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
                                        <i class="fas fa-tv text-sky-500"></i>
                                        <span class="text-sm font-medium text-gray-700">Entertainment</span>
                            </div>
                                    <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
                                        <i class="fas fa-suitcase-rolling text-sky-500"></i>
                                        <span class="text-sm font-medium text-gray-700">15kg Baggage</span>
                            </div>
                        </div>
                    </div>
                </div>
                        </div>
                        </div>
                        </div>
            {% endfor %}
                        </div>
        {% else %}
        <!-- No Flights Found -->
        <div class="bg-white rounded-2xl shadow-xl p-12 text-center animate-fade-in-up">
            <div class="w-32 h-32 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-paper-plane text-gray-400 text-5xl"></i>
                    </div>
            <h3 class="text-3xl font-bold text-gray-900 mb-3">No Flights Found</h3>
            <p class="text-gray-600 mb-8 max-w-md mx-auto">
                We couldn't find any flights matching your search criteria. Try modifying your search with different dates or routes.
            </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="{% url 'homepage' %}" class="px-6 py-3 bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                    <i class="fas fa-edit mr-2"></i>Modify Search
                </a>
                <a href="{% url 'homepage' %}" class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-xl transition-all duration-200">
                    <i class="fas fa-home mr-2"></i>Back to Home
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
    function toggleFlightDetails(flightId) {
        const details = document.getElementById('details-' + flightId);
        const chevron = document.getElementById('chevron-' + flightId);
        
        if (details.classList.contains('hidden')) {
            details.classList.remove('hidden');
            chevron.classList.remove('fa-chevron-down');
            chevron.classList.add('fa-chevron-up');
    } else {
            details.classList.add('hidden');
            chevron.classList.remove('fa-chevron-up');
            chevron.classList.add('fa-chevron-down');
        }
    }
    
    // Optimized: Ensure Non-Refundable badge is ALWAYS visible
    let isUpdating = false;
    
    function forceBadgeVisibility() {
        // Prevent infinite loops
        if (isUpdating) return;
        isUpdating = true;
        
        const badges = document.querySelectorAll('.non-refundable-badge');
        badges.forEach(function(badge) {
            // Only update if actually hidden
            const computedStyle = window.getComputedStyle(badge);
            if (computedStyle.display === 'none' || 
                computedStyle.visibility === 'hidden' || 
                parseFloat(computedStyle.opacity) < 0.5) {
                
                // Remove any classes that might hide it
                badge.classList.remove('hidden', 'invisible', 'opacity-0', 'fade-out');
                
                // Force inline styles with maximum priority
                badge.style.setProperty('display', 'inline-block', 'important');
                badge.style.setProperty('visibility', 'visible', 'important');
                badge.style.setProperty('opacity', '1', 'important');
            }
        });
        
        isUpdating = false;
    }
    
    // Run on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(forceBadgeVisibility, 100);
        });
    } else {
        setTimeout(forceBadgeVisibility, 100);
    }
    
    // Run on window load
    window.addEventListener('load', function() {
        setTimeout(forceBadgeVisibility, 200);
    });
    
    // Less frequent monitoring - check every 2 seconds instead of 100ms
    setInterval(forceBadgeVisibility, 2000);
    
    // Monitor for any DOM changes (only when badge is actually affected)
    document.addEventListener('DOMContentLoaded', function() {
        const badges = document.querySelectorAll('.non-refundable-badge');
        badges.forEach(function(badge) {
            // MutationObserver with debouncing
            let timeout;
            const observer = new MutationObserver(function(mutations) {
                clearTimeout(timeout);
                timeout = setTimeout(function() {
                    if (!isUpdating) {
                        forceBadgeVisibility();
                    }
                }, 100);
            });
            
            observer.observe(badge, {
                attributes: true,
                attributeFilter: ['style', 'class'],
                childList: false,
                subtree: false
            });
        });
    });
</script>
{% endblock %}
