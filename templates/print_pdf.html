{% load travel_filters %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>E-Ticket - {{ booking.booking_reference }}</title>
    <style>
        @page {
            size: A4;
            margin: 0.5cm;
        }

        body {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 10pt;
            color: #333;
            line-height: 1.3;
            margin: 0;
            padding: 20px;
        }

        /* Helpers */
        .text-bold {
            font-weight: bold;
        }

        .text-blue {
            color: #2c3e50;
        }

        .text-small {
            font-size: 8pt;
        }

        .text-xs {
            font-size: 7pt;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        td,
        th {
            padding: 5px;
            vertical-align: top;
        }

        /* Header */
        .header-section {
            border: 2px solid #2c3e50;
            margin-bottom: 2px;
            padding: 10px;
        }

        .agency-name {
            font-size: 12pt;
            font-weight: bold;
            color: #2c3e50;
        }

        .header-info {
            font-size: 9pt;
            margin-top: 8px;
        }
        
        .header-info table td {
            padding: 2px 0;
            vertical-align: top;
        }

        /* Blue Bar Title */
        .blue-bar {
            background-color: #d1efff;
            /* Light blue */
            border: 1px solid #2c3e50;
            border-top: none;
            color: #000;
            text-align: center;
            font-weight: bold;
            padding: 5px;
            font-size: 11pt;
            margin-bottom: 2px;
        }

        /* Sections */
        .section-box {
            border: 1px solid #2c3e50;
            border-top: none;
            margin-bottom: 0;
            padding: 10px;
        }

        .section-title {
            color: #2c3e50;
            font-weight: bold;
            text-decoration: underline;
            margin-bottom: 10px;
            font-size: 10pt;
        }

        /* Flight Summary Table */
        .flight-summary-table th {
            background-color: #e0e0e0;
            font-weight: normal;
            text-align: left;
            font-size: 9pt;
            border: none;
        }

        .flight-summary-table td {
            font-size: 9pt;
        }

        /* References Section */
        .ref-table td {
            vertical-align: top;
        }

        /* Detailed Itinerary */
        .itinerary-table th {
            background-color: #e0e0e0;
            font-weight: normal;
            text-align: left;
            font-size: 9pt;
        }

        /* Services Bar */
        .services-bar {
            background-color: #e0e0e0;
            padding: 5px;
            font-weight: bold;
            font-size: 9pt;
            border: 1px solid #2c3e50;
            border-top: none;
        }

        /* Footer / Legal */
        .legal-section {
            border: 1px solid #2c3e50;
            border-top: none;
            padding: 10px;
            font-size: 7pt;
            color: #555;
            text-align: justify;
        }

        .important-note {
            font-weight: bold;
            font-size: 9pt;
            margin: 10px 0;
            color: #000;
        }

        /* Web View Buttons */
        @media screen {
            .no-print {
                padding: 15px;
                background: #f1f1f1;
                text-align: center;
                margin-bottom: 20px;
            }

            .btn {
                background: #0056b3;
                color: white;
                text-decoration: none;
                padding: 8px 15px;
                border: none;
                cursor: pointer;
            }
        }

        @media print {
            .no-print {
                display: none;
            }
        }
    </style>
</head>

<body>

    <!-- Web Buttons -->
    {% if is_web_view %}
    <div class="no-print">
        <a href="{% url 'download_ticket_pdf' booking.id %}" class="btn">Download PDF</a>
        <button onclick="window.print()" class="btn" style="background: #28a745;">Print</button>
    </div>
    {% endif %}

    <!-- 1. Header Section -->
    <div class="header-section">
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 8px;">
            {% if user_profile and user_profile.logo %}
            <div style="flex-shrink: 0;">
                <img src="{{ user_profile.logo.url }}" alt="Company Logo" style="max-height: 60px; max-width: 150px; object-fit: contain;">
            </div>
            {% endif %}
            <div class="agency-name" style="flex: 1;">
                {% if user_profile and user_profile.company_name %}
                {{ user_profile.company_name|upper }}
                {% else %}
                SAFAR ZONE TRAVELS
                {% endif %}
            </div>
        </div>
        <div class="header-info">
            <table style="width: 100%; font-size: 9pt;">
                {% if user_profile and user_profile.address %}
                <tr>
                    <td width="80" style="vertical-align: top;">Address</td>
                    <td>: {{ user_profile.address }}</td>
                </tr>
                {% endif %}
                {% if user_profile and user_profile.city %}
                <tr>
                    <td width="80" style="vertical-align: top;">City</td>
                    <td>: {{ user_profile.city }}{% if user_profile.state %}, {{ user_profile.state }}{% endif %}{% if user_profile.pincode %} - {{ user_profile.pincode }}{% endif %}</td>
                </tr>
                {% elif user_profile and user_profile.state %}
                <tr>
                    <td width="80" style="vertical-align: top;">State</td>
                    <td>: {{ user_profile.state }}{% if user_profile.pincode %} - {{ user_profile.pincode }}{% endif %}</td>
                </tr>
                {% elif user_profile and user_profile.pincode %}
                <tr>
                    <td width="80" style="vertical-align: top;">Pin Code</td>
                    <td>: {{ user_profile.pincode }}</td>
                </tr>
                {% endif %}
                {% if user_profile and user_profile.country %}
                <tr>
                    <td width="80" style="vertical-align: top;">Country</td>
                    <td>: {{ user_profile.country }}</td>
                </tr>
                {% endif %}
                <tr>
                    <td width="80" style="vertical-align: top;">MOB</td>
                    <td>: {% if user and user.phone %}{{ user.phone }}{% elif user_profile and user_profile.user.phone %}{{ user_profile.user.phone }}{% else %}7379672019{% endif %}</td>
                </tr>
                <tr>
                    <td width="80" style="vertical-align: top;">Email</td>
                    <td>: {% if user and user.email %}{{ user.email }}{% elif user_profile and user_profile.user.email %}{{ user_profile.user.email }}{% else %}safarzonetravels@gmail.com{% endif %}</td>
                </tr>
                {% if user_profile and user_profile.gst_number %}
                <tr>
                    <td width="80" style="vertical-align: top;">GST No</td>
                    <td>: {{ user_profile.gst_number }}</td>
                </tr>
                {% endif %}
            </table>
        </div>
    </div>

    <!-- 2. Blue Title Bar -->
    <div class="blue-bar">
        Airline e-Ticket
    </div>

    <!-- 3. Traveller Information -->
    <div class="section-box">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
            <div style="flex: 1;">
                <div class="section-title">Traveller Information</div>
                <div style="margin-bottom: 10px;">
                    {% for passenger in booking.passengers.all %}
                    <div>{{ forloop.counter }}. {{ passenger.get_title_display }} {{ passenger.first_name }} {{ passenger.last_name }}</div>
                    {% empty %}
                    <div>TBA TBA</div>
                    {% endfor %}
                </div>
            </div>
            <!-- Airline Logo -->
            <div style="text-align: right; min-width: 120px;">
                <img src="{{ booking.schedule.route.carrier_number|airline_logo }}" 
                     alt="{{ booking.schedule.route.carrier_number|airline_name_from_code }}" 
                     style="max-height: 50px; max-width: 120px; object-fit: contain;"
                     onerror="this.style.display='none'">
                <div style="font-size: 8pt; font-weight: bold; color: #2c3e50; margin-top: 3px;">
                    {{ booking.schedule.route.carrier_number|airline_name_from_code }}
                </div>
            </div>
        </div>

        <table class="flight-summary-table">
            <tr>
                <th>Departure</th>
                <th>From</th>
                <th>To</th>
                <th>Flight</th>
                <th>Dep.Tmnl</th>
                <th>Tour Code</th>
                <th>Airline</th>
            </tr>
            <tr>
                <td>{{ booking.schedule.departure_date|date:"d/m/Y" }} {{ booking.schedule.route.departure_time|time:"H:i" }}</td>
                <td>{{ booking.schedule.route.from_location }}</td>
                <td>{{ booking.schedule.route.to_location }}</td>
                <td>{{ booking.schedule.route.carrier_number }}</td>
                <td>{% if booking.schedule.route.departure_terminal %}{{ booking.schedule.route.departure_terminal }}{% else %}-{% endif %}</td>
                <td>-</td>
                <td>{{ booking.schedule.route.carrier_number|airline_name_from_code }}</td>
            </tr>
    </table>
    </div>

    <!-- 4. Booking Reference -->
    <div class="section-box">
        <div class="section-title">Booking Reference</div>
        <table style="width: 100%; font-size: 9pt;">
            <tr>
                <td width="100">Booking Ref</td>
                <td>: {{ booking.booking_reference }}</td>
            </tr>
            <tr>
                <td>Airline Ref</td>
                <td>: {% if booking.schedule.pnr %}{{ booking.schedule.pnr }}{% else %}PENDING{% endif %}</td>
            </tr>
        </table>
    </div>

    <!-- 5. Detailed Itinerary -->
    <div class="section-box">
        <div class="section-title">Detailed Itinerary</div>

        <!-- Flight 1 -->
        <div style="margin-bottom: 20px;">
            <div style="font-weight: bold; margin-bottom: 5px;">
                {% with from_code=airport_codes|get_item:booking.schedule.route.from_location|default:booking.schedule.route.from_location|slice:":3"|upper to_code=airport_codes|get_item:booking.schedule.route.to_location|default:booking.schedule.route.to_location|slice:":3"|upper %}
                {{ from_code }} - {{ to_code }}
                {% endwith %}
            </div>
            <div style="font-size: 8pt; color: #555; margin-bottom: 5px;">
                Flight No : {{ booking.schedule.route.carrier_number }} |
                Travel Class : Economy |
                Issue Date : {{ booking.created_at|date:"Y-m-d" }} |
                Travel Date : {{ booking.schedule.departure_date|date:"d/m/Y" }}
            </div>

            <table class="itinerary-table">
                <tr>
                    <th width="15%">Airline</th>
                    <th width="15%">Arr Terminal</th>
                    <th width="25%">Departure</th>
                    <th width="25%">Arrival</th>
                    <th width="20%">Duration</th>
                </tr>
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <img src="{{ booking.schedule.route.carrier_number|airline_logo }}" 
                                 alt="" 
                                 style="height: 20px; width: auto;"
                                 onerror="this.style.display='none'">
                            <span>{{ booking.schedule.route.carrier_number|airline_name_from_code }}</span>
                        </div>
                    </td>
                    <td>{% if booking.schedule.route.arrival_terminal %}{{ booking.schedule.route.arrival_terminal }}{% else %}-{% endif %}</td>
                    <td>{{ booking.schedule.departure_date|date:"d/m/Y" }} {{ booking.schedule.route.departure_time|time:"H:i" }}</td>
                    <td>
                        {% if booking.schedule.arrival_date %}
                        {{ booking.schedule.arrival_date|date:"d/m/Y" }}
                        {% else %}
                        {{ booking.schedule.departure_date|date:"d/m/Y" }}
                        {% endif %}
                        {{ booking.schedule.route.arrival_time|time:"H:i" }}
                    </td>
                    <td>{{ booking.schedule.route.formatted_duration }} Hrs</td>
                </tr>
            </table>
        </div>

        {% if booking.return_schedule %}
        <div style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px;">
            <div style="font-weight: bold; margin-bottom: 5px;">
                {{ booking.return_schedule.route.from_location|slice:":3"|upper }} - {{
                booking.return_schedule.route.to_location|slice:":3"|upper }}
            </div>
            <div style="font-size: 8pt; color: #555; margin-bottom: 5px;">
                Flight No : {{ booking.return_schedule.route.carrier_number }} |
                Travel Class : Economy |
                Travel Date : {{ booking.return_schedule.departure_date|date:"d/m/Y" }}
            </div>
            <table class="itinerary-table">
                <tr>
                    <th width="15%">Airline</th>
                    <th width="15%">Arr Terminal</th>
                    <th width="25%">Departure</th>
                    <th width="25%">Arrival</th>
                    <th width="20%">Duration</th>
            </tr>
                <tr>
                    <td>
                        {% if booking.return_schedule and booking.return_schedule.route.get_airline_logo_url %}
                        <img src="{{ booking.return_schedule.route.get_airline_logo_url }}"
                            alt="{{ booking.return_schedule.route.airline_name|default:'Airline' }}" style="height: 18px; max-width: 70px; object-fit: contain;">
                        {% elif booking.schedule.route.get_airline_logo_url %}
                        <img src="{{ booking.schedule.route.get_airline_logo_url }}"
                            alt="{{ booking.schedule.route.airline_name|default:'Airline' }}" style="height: 18px; max-width: 70px; object-fit: contain;">
                        {% endif %}
                    </td>
                    <td>{% if booking.return_schedule.route.arrival_terminal %}{{
                        booking.return_schedule.route.arrival_terminal }}{% else %}-{% endif %}</td>
                    <td>{{ booking.return_schedule.departure_date|date:"d/m/Y" }} {{
                        booking.return_schedule.route.departure_time|time:"H:i" }}</td>
                    <td>
                        {% if booking.return_schedule.arrival_date %}
                        {{ booking.return_schedule.arrival_date|date:"d/m/Y" }}
                        {% else %}
                        {{ booking.return_schedule.departure_date|date:"d/m/Y" }}
                        {% endif %}
                        {{ booking.return_schedule.route.arrival_time|time:"H:i" }}
                    </td>
                    <td>{{ booking.return_schedule.route.formatted_duration }}</td>
            </tr>
    </table>
        </div>
        {% endif %}

    </div>

    <!-- 5.5. Fare Breakdown (if not hiding fare) -->
    {% if not hide_fare %}
    <div class="section-box">
        <div class="section-title">Fare Breakdown</div>
        <table style="width: 100%; font-size: 9pt;">
            <tr>
                <td width="200">Base Fare:</td>
                <td style="text-align: right; font-weight: bold;">₹{{ booking.base_fare|floatformat:2 }}</td>
            </tr>
            {% if booking.tax_amount > 0 %}
            <tr>
                <td>Taxes & Fees:</td>
                <td style="text-align: right; font-weight: bold;">₹{{ booking.tax_amount|floatformat:2 }}</td>
            </tr>
            {% endif %}
            {% if booking.discount_amount > 0 %}
            <tr>
                <td>Discount:</td>
                <td style="text-align: right; font-weight: bold; color: #10b981;">-₹{{ booking.discount_amount|floatformat:2 }}</td>
            </tr>
            {% endif %}
            {% if discount_applied and discount_applied > 0 %}
            <tr>
                <td>Special Discount:</td>
                <td style="text-align: right; font-weight: bold; color: #10b981;">-₹{{ discount_applied|floatformat:2 }}</td>
            </tr>
            {% endif %}
            {% if convenience_fee and convenience_fee > 0 %}
            <tr>
                <td>Service Charge:</td>
                <td style="text-align: right; font-weight: bold; color: #f59e0b;">+₹{{ convenience_fee|floatformat:2 }}</td>
            </tr>
            {% endif %}
            <tr style="border-top: 2px solid #2c3e50; margin-top: 5px;">
                <td style="font-weight: bold; font-size: 11pt; padding-top: 10px;">Total Amount:</td>
                <td style="text-align: right; font-weight: bold; font-size: 11pt; padding-top: 10px;">
                    ₹{% if show_modified_fare %}{{ total_with_fee|floatformat:2 }}{% else %}{{ booking.total_amount|floatformat:2 }}{% endif %}
                </td>
            </tr>
        </table>
    </div>
    {% endif %}

    <!-- 6. In-Flight Services -->
    <div style="border: 1px solid #2c3e50; border-top: none;">
        <div class="section-title" style="padding: 10px 10px 0 10px;">In-Flight Services</div>
        <div class="services-bar" style="border: none; margin-top: 5px;">
        Adult Cabin Baggage: 07 Kilo | Free Baggage: 30 Kilo<br>
            Infant Cabin Baggage: 10 Kilo | Free Baggage: NIL Kilo
        </div>
    </div>

    <!-- 7. Footer / Legal -->
    <div class="legal-section">
        <div class="text-bold" style="font-size: 9pt;">Positive identification required for airport check in</div>
        <br>
        <span class="text-bold">Notice:</span><br>
        CARRIAGE AND OTHER SERVICES PROVIDED BY THE CARRIER ARE SUBJECT TO CONDITIONS OF CARRIAGE, WHICH ARE HEREBY
        INCORPORATED BY REFERENCE. THESE CONDITIONS MAY BE OBTAINED FROM THE ISSUING CARRIER. PASSENGERS ON A JOURNEY
        INVOLVING AN ULTIMATE DESTINATION OR A STOP IN A COUNTRY OTHER THAN THE COUNTRY OF DEPARTURE ARE ADVISED THAT
        INTERNATIONAL TREATIES KNOWN AS THE MONTREAL CONVENTION, OR ITS PREDECESSOR, THE WARSAW CONVENTION, INCLUDING
        ITS AMENDMENTS THE WARSAW CONVENTION SYSTEM, MAY APPLY TO THE ENTIRE JOURNEY, INCLUDING ANY PORTION THEREOF
        WITHIN A COUNTRY. FOR SUCH PASSENGERS, THE APPLICABLE TREATY, INCLUDING SPECIAL CONTRACTS OF CARRIAGE EMBODIED
        IN ANY APPLICABLE TARIFFS, GOVERNS AND MAY LIMIT THE LIABILITY OF THE CARRIER. CHECK WITH YOUR CARRIER FOR MORE
        INFORMATION. IATA Ticket Notice. http://www.iatatravelcentre.com/e-ticket-notice/General/English/ (Subject to
        change without prior notice)

        <div class="important-note">
            Important note: The courts of {% if user_profile and user_profile.city %}{{ user_profile.city }}{% else %}Mumbai{% endif %} have jurisdiction to entertain any suits or legal proceeding
        </div>

        <span class="text-bold">Safety Travel Advisory during COVID-19</span><br>
        - All customers should wear a mask, face shield, gown (if applicable) and sanitize hands before boarding.<br>
        - Mask must cover nose and mouth throughout the journey, removable only for eating/drinking.<br>
        - Maintain social distancing.<br>
        - Hold a VALID Covid-19 Test certificate issued within 48 hours of sample collection, with accurate date/time of collection and reporting.<br>
        - Certificate must indicate a NEGATIVE test result, described in ARABIC or ENGLISH, from a certified lab at the original point of destination.<br>
        - MANDATORY QR code linked to the original report for verification by airlines and Dubai Health Authority (DHA) upon arrival in Dubai Airports.<br>
        - Adhere to announcements and directives from ground staff/crew.<br>
        - Familiarize with guidelines from Indian Ministry of Civil Aviation via provided links:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;https://www.civilaviation.gov.in/sites/default/files/Guidelines_for_Air_Passengers_21 May.pdf<br>
        &nbsp;&nbsp;&nbsp;&nbsp;https://www.civilaviation.gov.in/sites/default/files/State_wise_quarantine_regulation-converted.pdf<br>
        - Details should also be confirmed from the website of the concerned State Government.<br>
        - Caution: Customers are advised to check the latest travel guidelines and requirements before travel.
</div>

    <!-- Action Buttons Section (Only shown in web view, not in PDF) -->
    {% if is_web_view %}
    <style>
    .ticket-toolbar{margin-top:30px;background:linear-gradient(135deg,#1e3a5f 0%,#2d5a87 50%,#1e3a5f 100%);border-radius:16px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
    .toolbar-header{background:linear-gradient(90deg,#f97316,#ea580c);padding:15px 20px;display:flex;align-items:center;gap:12px}
    .toolbar-header h3{color:#fff;font-size:16pt;font-weight:700;margin:0}
    .toolbar-header i{color:#fff;font-size:18pt}
    .toolbar-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;padding:20px}
    @media(max-width:900px){.toolbar-grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:500px){.toolbar-grid{grid-template-columns:1fr}}
    .action-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;padding:16px 12px;border-radius:12px;border:none;cursor:pointer;font-weight:600;font-size:10pt;transition:all 0.3s;min-height:80px;text-decoration:none}
    .action-btn i{font-size:20pt}
    .action-btn:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,0.3)}
    .btn-print{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff}
    .btn-print-nf{background:linear-gradient(135deg,#10b981,#047857);color:#fff}
    .btn-email{background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:#fff}
    .btn-whatsapp{background:linear-gradient(135deg,#22c55e,#15803d);color:#fff}
    .btn-email-nf{background:linear-gradient(135deg,#06b6d4,#0891b2);color:#fff}
    .btn-pdf{background:linear-gradient(135deg,#ef4444,#b91c1c);color:#fff}
    .btn-discount{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}
    .btn-fee{background:linear-gradient(135deg,#ec4899,#be185d);color:#fff}
    .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center}
    .modal-overlay.active{display:flex}
    .modal-box{background:#fff;border-radius:16px;padding:30px;max-width:450px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.4)}
    .modal-title{font-size:16pt;font-weight:700;color:#1e3a5f;margin-bottom:20px;display:flex;align-items:center;gap:10px}
    .modal-input{width:100%;padding:14px;border:2px solid #e5e7eb;border-radius:10px;font-size:14pt;font-weight:600;text-align:center;margin-bottom:15px}
    .modal-input:focus{border-color:#3b82f6;outline:none}
    .modal-btns{display:flex;gap:12px;margin-top:20px}
    .modal-btn{flex:1;padding:12px;border:none;border-radius:10px;font-weight:600;font-size:11pt;cursor:pointer}
    .modal-btn-primary{background:#3b82f6;color:#fff}
    .modal-btn-cancel{background:#e5e7eb;color:#374151}
    .current-value{background:#f0fdf4;border:2px solid #22c55e;border-radius:10px;padding:12px;margin-bottom:15px;text-align:center}
    .current-value span{font-size:14pt;font-weight:700;color:#15803d}
    </style>

    <div class="ticket-toolbar no-print">
        <div class="toolbar-header">
            <i class="fas fa-ticket-alt"></i>
            <h3>TICKET ACTIONS</h3>
        </div>
        <div class="toolbar-grid">
            <button class="action-btn btn-print" onclick="printEticket()">
                <i class="fas fa-print"></i>
                <span>Print E-ticket</span>
            </button>
            <button class="action-btn btn-print-nf" onclick="printEticketNoFare()">
                <i class="fas fa-file-alt"></i>
                <span>Print E-ticket Without Fare</span>
            </button>
            <button class="action-btn btn-email" onclick="emailEticket()">
                <i class="fas fa-envelope"></i>
                <span>Email E-ticket</span>
            </button>
            <button class="action-btn btn-whatsapp" onclick="whatsappEticket()">
                <i class="fab fa-whatsapp"></i>
                <span>WhatsApp E-ticket</span>
            </button>
            <button class="action-btn btn-email-nf" onclick="emailEticketNoFare()">
                <i class="fas fa-envelope-open"></i>
                <span>Email E-ticket Without Fare</span>
            </button>
            <button class="action-btn btn-pdf" onclick="generatePDF()">
                <i class="fas fa-file-pdf"></i>
                <span>Generate PDF</span>
            </button>
            <button class="action-btn btn-discount" onclick="openDiscountModal()">
                <i class="fas fa-percentage"></i>
                <span>Add Discount</span>
            </button>
            <button class="action-btn btn-fee" onclick="openFeeModal()">
                <i class="fas fa-edit"></i>
                <span>Edit Transaction Fee</span>
            </button>
        </div>
    </div>

    <!-- Discount Modal -->
    <div class="modal-overlay" id="discountModal">
        <div class="modal-box">
            <div class="modal-title"><i class="fas fa-percentage" style="color:#f59e0b"></i> Add Discount</div>
            <div class="current-value">Current Total: <span>₹{{ booking.total_amount|floatformat:2 }}</span></div>
            <input type="number" class="modal-input" id="discountAmount" placeholder="Enter discount amount (₹)" min="0" step="0.01">
            <p id="discountResult" style="text-align:center;font-weight:600;color:#15803d"></p>
            <div class="modal-btns">
                <button class="modal-btn modal-btn-cancel" onclick="closeDiscountModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="applyDiscount()">Apply & Print</button>
            </div>
        </div>
    </div>

    <!-- Transaction Fee Modal -->
    <div class="modal-overlay" id="feeModal">
        <div class="modal-box">
            <div class="modal-title"><i class="fas fa-rupee-sign" style="color:#ec4899"></i> Edit Transaction Fee</div>
            <div class="current-value">Base Total: <span>₹{{ booking.total_amount|floatformat:2 }}</span></div>
            <input type="number" class="modal-input" id="transactionFee" placeholder="Enter additional fee (₹)" min="0" step="0.01">
            <p id="feeResult" style="text-align:center;font-weight:600;color:#3b82f6"></p>
            <div class="modal-btns">
                <button class="modal-btn modal-btn-cancel" onclick="closeFeeModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="applyFee()">Apply & Print</button>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div class="modal-overlay" id="emailModal">
        <div class="modal-box">
            <div class="modal-title"><i class="fas fa-envelope" style="color:#8b5cf6"></i> Email E-ticket</div>
            <input type="email" class="modal-input" id="emailAddress" placeholder="Enter email address" style="text-align:left">
            <div class="modal-btns">
                <button class="modal-btn modal-btn-cancel" onclick="closeEmailModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="emailSendBtn" onclick="sendEmail()">Send Email</button>
            </div>
        </div>
    </div>

    <!-- WhatsApp Modal -->
    <div class="modal-overlay" id="whatsappModal">
        <div class="modal-box">
            <div class="modal-title"><i class="fab fa-whatsapp" style="color:#22c55e"></i> WhatsApp E-ticket</div>
            <input type="tel" class="modal-input" id="whatsappNumber" placeholder="Enter WhatsApp number (with country code)" style="text-align:left">
            <div class="modal-btns">
                <button class="modal-btn modal-btn-cancel" onclick="closeWhatsappModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="sendWhatsapp()">Send via WhatsApp</button>
            </div>
        </div>
    </div>
    {% endif %}

    <style>
        /* Hide action buttons when printing */
        @media print {
            .action-buttons-section, .ticket-toolbar, .modal-overlay, .no-print {
                display: none !important;
            }
        }
    </style>
    
    <!-- Font Awesome for Icons -->
    {% if is_web_view %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        const bookingId = {{ booking.id }};
        const baseTotal = {{ booking.total_amount }};
        const bookingRef = '{{ booking.booking_reference }}';
        let hideFareForEmail = false;
        
        // Print E-ticket (with fare)
        function printEticket() {
            window.print();
        }
        
        // Print E-ticket without fare
        function printEticketNoFare() {
            const url = `/ticket/${bookingId}/pdf/?hide_fare=true&view=true`;
            window.open(url, '_blank');
        }
        
        // Email E-ticket modal
        function emailEticket() {
            hideFareForEmail = false;
            document.getElementById('emailModal').classList.add('active');
        }
        
        function closeEmailModal() {
            document.getElementById('emailModal').classList.remove('active');
            document.getElementById('emailAddress').value = '';
        }
        
        function sendEmail() {
            const email = document.getElementById('emailAddress').value.trim();
            if (!email) {
                alert('Please enter a valid email address');
                return;
            }
            const btn = document.getElementById('emailSendBtn');
            btn.textContent = 'Sending...';
            btn.disabled = true;
            
            const hideFare = hideFareForEmail ? '&hide_fare=true' : '';
            fetch(`/api/send-ticket-email/?booking_id=${bookingId}&email=${encodeURIComponent(email)}${hideFare}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('E-ticket sent successfully to ' + email);
                        closeEmailModal();
                    } else {
                        alert('Failed to send email: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    alert('Error sending email. Please try again.');
                })
                .finally(() => {
                    btn.textContent = 'Send Email';
                    btn.disabled = false;
                });
        }
        
        // Email E-ticket without fare
        function emailEticketNoFare() {
            hideFareForEmail = true;
            document.getElementById('emailModal').classList.add('active');
        }
        
        // WhatsApp E-ticket
        function whatsappEticket() {
            document.getElementById('whatsappModal').classList.add('active');
        }
        
        function closeWhatsappModal() {
            document.getElementById('whatsappModal').classList.remove('active');
            document.getElementById('whatsappNumber').value = '';
        }
        
        function sendWhatsapp() {
            const phone = document.getElementById('whatsappNumber').value.trim().replace(/[^0-9]/g, '');
            if (!phone || phone.length < 10) {
                alert('Please enter a valid phone number');
                return;
            }
            const ticketUrl = window.location.href;
            const message = encodeURIComponent(`Your E-Ticket for booking ${bookingRef} is ready!\n\nView/Download: ${ticketUrl}\n\nThank you for choosing us!`);
            window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
            closeWhatsappModal();
        }
        
        // Generate PDF
        function generatePDF() {
            const url = `/ticket/${bookingId}/pdf/download/`;
            window.open(url, '_blank');
        }
        
        // Discount Modal
        function openDiscountModal() {
            document.getElementById('discountModal').classList.add('active');
            document.getElementById('discountAmount').value = '';
            document.getElementById('discountResult').textContent = '';
        }
        
        function closeDiscountModal() {
            document.getElementById('discountModal').classList.remove('active');
        }
        
        document.getElementById('discountAmount').addEventListener('input', function() {
            const discount = parseFloat(this.value) || 0;
            const newTotal = Math.max(0, baseTotal - discount);
            document.getElementById('discountResult').textContent = `New Total: ₹${newTotal.toFixed(2)}`;
        });
        
        function applyDiscount() {
            const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
            if (discount < 0) {
                alert('Discount cannot be negative');
                return;
            }
            if (discount > baseTotal) {
                alert('Discount cannot exceed total amount');
                return;
            }
            const url = `/ticket/${bookingId}/pdf/?discount=${discount}&view=true`;
            window.open(url, '_blank');
            closeDiscountModal();
        }
        
        // Transaction Fee Modal
        function openFeeModal() {
            document.getElementById('feeModal').classList.add('active');
            document.getElementById('transactionFee').value = '';
            document.getElementById('feeResult').textContent = '';
        }
        
        function closeFeeModal() {
            document.getElementById('feeModal').classList.remove('active');
        }
        
        document.getElementById('transactionFee').addEventListener('input', function() {
            const fee = parseFloat(this.value) || 0;
            const newTotal = baseTotal + fee;
            document.getElementById('feeResult').textContent = `New Total: ₹${newTotal.toFixed(2)}`;
        });
        
        function applyFee() {
            const fee = parseFloat(document.getElementById('transactionFee').value) || 0;
            if (fee < 0) {
                alert('Fee cannot be negative');
                return;
            }
            const url = `/ticket/${bookingId}/pdf/?convenience_fee=${fee}&view=true`;
            window.open(url, '_blank');
            closeFeeModal();
        }
        
        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
    </script>
    {% endif %}

</body>

</html>