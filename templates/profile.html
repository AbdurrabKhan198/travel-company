{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<!-- Animate.css -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate__min.css">
<!-- Custom Styles -->
<style>
  :root {
    --primary: #3f51b5;
    --primary-light: #757de8;
    --primary-dark: #002984;
    --secondary: #ff4081;
    --dark: #2c3e50;
    --light: #f8f9fa;
    --success: #4caf50;
    --info: #2196f3;
    --warning: #ff9800;
    --danger: #f44336;
  }
  
  body {
    background: #f5f7fa;
    color: #333;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  
  .profile-container {
    padding: 2rem 0;
    animation: fadeIn 0.6s ease-in-out;
  }
  
  /* Profile Card */
  .profile-card {
    border: none;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    background: white;
    height: 100%;
  }
  
  .profile-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
  }
  
  .profile-header {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    padding: 2rem 1rem;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  
  .profile-header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    transform: rotate(30deg);
    pointer-events: none;
  }
  
  .profile-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 4px solid rgba(255, 255, 255, 0.3);
    object-fit: cover;
    margin: 0 auto 1rem;
    display: block;
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
  }
  
  .profile-avatar:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }
  
  .profile-name {
    color: white;
    font-weight: 700;
    margin: 0.5rem 0 0.25rem;
    position: relative;
    z-index: 1;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
  }
  
  .profile-email {
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.95rem;
    margin-bottom: 1.5rem;
    position: relative;
    z-index: 1;
  }
  
  .profile-stats {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin: 1.5rem 0;
    position: relative;
    z-index: 1;
  }
  
  .stat-item {
    text-align: center;
  }
  
  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    line-height: 1.2;
    margin-bottom: 0.25rem;
  }
  
  .stat-label {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.8);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .profile-actions {
    padding: 1.5rem;
    text-align: center;
  }
  
  .btn-edit {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    border: none;
    color: white;
    padding: 0.5rem 1.5rem;
    border-radius: 50px;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(63, 81, 181, 0.3);
  }
  
  .btn-edit:hover {
    transform: translateY(-2px);
    box-shadow: 0 7px 20px rgba(63, 81, 181, 0.4);
    color: white;
  }
  
  .btn-logout {
    background: transparent;
    border: 1px solid var(--danger);
    color: var(--danger);
    padding: 0.5rem 1.5rem;
    border-radius: 50px;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
    margin-top: 0.75rem;
  }
  
  .btn-logout:hover {
    background: var(--danger);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
  }
  
  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes slideInLeft {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
  }
  
  @keyframes slideInRight {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
  }
  
  .animate-delay-1 { animation-delay: 0.1s; }
  .animate-delay-2 { animation-delay: 0.2s; }
  .animate-delay-3 { animation-delay: 0.3s; }
  
  /* Responsive Adjustments */
  @media (max-width: 991.98px) {
    .profile-container {
      padding: 1rem 0;
    }
    
    .profile-avatar {
      width: 100px;
      height: 100px;
    }
  }
  
  @media (max-width: 767.98px) {
    .profile-stats {
      flex-direction: column;
      gap: 1rem;
    }
    
    .profile-actions {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .btn-logout {
      margin-top: 1rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
  <div class="container">
    <div class="row">
      <!-- Profile Sidebar -->
      <div class="col-lg-4 mb-4">
        <div class="profile-card h-100 animate__animated animate__fadeInLeft">
          <div class="profile-header">
            <div class="position-relative d-inline-block">
              {% if profile.profile_picture %}
                <img src="{{ profile.profile_picture.url }}" alt="Profile Picture" class="profile-avatar">
              {% else %}
                <div class="profile-avatar bg-light d-flex align-items-center justify-content-center" style="font-size: 48px; color: var(--primary);">
                  {{ user.email|first|upper }}
                </div>
              {% endif %}
              <label for="profile-picture-upload" class="position-absolute bottom-0 end-0 bg-white text-primary rounded-circle p-2 shadow-sm" style="cursor: pointer; z-index: 2;">
                <i class="fas fa-camera"></i>
                <input type="file" id="profile-picture-upload" class="d-none" accept="image/*">
              </label>
            </div>
            <h3 class="profile-name">{{ profile.full_name|default:user.email }}</h3>
            <p class="profile-email">{{ user.email }}</p>
            
            <div class="profile-stats">
              <div class="stat-item">
                <div class="stat-value">{{ bookings|length }}</div>
                <div class="stat-label">Bookings</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ user.date_joined|date:"M 'y" }}</div>
                <div class="stat-label">Member Since</div>
              </div>
            </div>
          </div>
          
          <div class="profile-actions">
            <button type="button" class="btn btn-edit mb-2" data-bs-toggle="modal" data-bs-target="#editProfileModal">
              <i class="fas fa-edit me-1"></i> Edit Profile
            </button>
            <a href="{% url 'logout' %}" class="btn btn-logout">
              <i class="fas fa-sign-out-alt me-1"></i> Logout
            </a>
          </div>
        </div>
      </div>

      <!-- Profile Content -->
      <div class="col-lg-8">
        <!-- Personal Information Card -->
        <div class="card shadow-sm mb-4 animate__animated animate__fadeInRight animate-delay-1">
          <div class="card-header bg-white border-0 py-3">
            <h5 class="mb-0 d-flex align-items-center">
              <i class="fas fa-user-circle text-primary me-2"></i>
              Personal Information
            </h5>
          </div>
          <div class="card-body">
            <div class="row g-4">
              <div class="col-md-6">
                <div class="info-item">
                  <label class="text-muted small mb-1">Full Name</label>
                  <p class="mb-0 fw-medium">{{ profile.full_name|default:"Not provided" }}</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="info-item">
                  <label class="text-muted small mb-1">Email Address</label>
                  <p class="mb-0">{{ user.email }}</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="info-item">
                  <label class="text-muted small mb-1">Phone Number</label>
                  <p class="mb-0">{{ user.phone|default:"Not provided" }}</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="info-item">
                  <label class="text-muted small mb-1">Date of Birth</label>
                  <p class="mb-0">{{ profile.date_of_birth|date:"F d, Y"|default:"Not provided" }}</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="info-item">
                  <label class="text-muted small mb-1">Gender</label>
                  <p class="mb-0">{{ profile.get_gender_display|default:"Not specified" }}</p>
                </div>
              </div>
              <div class="col-12">
                <div class="info-item">
                  <label class="text-muted small mb-1">Address</label>
                  <p class="mb-0">
                    {% if profile.address %}
                      {{ profile.address }}, {{ profile.city }}, {{ profile.state }}, {{ profile.country }} - {{ profile.pincode }}
                    {% else %}
                      Not provided
                    {% endif %}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Bookings -->
        {% if bookings %}
        <div class="card shadow-sm animate__animated animate__fadeInRight animate-delay-2">
          <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 d-flex align-items-center">
              <i class="fas fa-calendar-alt text-primary me-2"></i>
              Recent Bookings
            </h5>
            <a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-primary">
              View All <i class="fas fa-arrow-right ms-1"></i>
            </a>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                  <tr>
                    <th class="ps-4">Booking #</th>
                    <th>Route</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th class="text-end pe-4">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for booking in bookings|slice:":5" %}
                  <tr class="booking-row" style="cursor: pointer;" onclick="window.location='{% url 'booking_details' booking.id %}'">
                    <td class="ps-4 fw-medium">#{{ booking.booking_reference }}</td>
                    <td>
                      <div class="d-flex align-items-center">
                        <div class="route-icon me-2">
                          <i class="fas fa-plane-departure text-muted"></i>
                        </div>
                        <div>
                          <div class="fw-medium">{{ booking.inventory.route.from_location }} â†’ {{ booking.inventory.route.to_location }}</div>
                          <small class="text-muted">{{ booking.inventory.airline.name|default:"Airline" }}</small>
                        </div>
                      </div>
                    </td>
                    <td>{{ booking.inventory.travel_date|date:"M d, Y" }}</td>
                    <td>
                      <span class="badge rounded-pill bg-{% if booking.status == 'confirmed' %}success{% elif booking.status == 'cancelled' %}danger{% else %}warning{% endif %} bg-opacity-10 text-{% if booking.status == 'confirmed' %}success{% elif booking.status == 'cancelled' %}danger{% else %}warning{% endif %} py-2 px-3">
                        {{ booking.get_status_display }}
                      </span>
                    </td>
                    <td class="text-end pe-4">
                      <a href="{% url 'booking_details' booking.id %}" class="btn btn-sm btn-outline-primary">
                        View Details
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProfileModalLabel">
          <i class="fas fa-user-edit me-2"></i>Edit Profile
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" enctype="multipart/form-data" id="profileForm">
        {% csrf_token %}
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="id_full_name" class="form-label">Full Name</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-user"></i></span>
                {{ form.full_name }}
              </div>
              <div class="invalid-feedback">Please enter your full name.</div>
            </div>
            <div class="col-md-6">
              <label for="id_phone" class="form-label">Phone</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                <input type="tel" name="phone" value="{{ user.phone }}" class="form-control" id="id_phone">
              </div>
              <div class="invalid-feedback">Please enter a valid phone number.</div>
            </div>
            <div class="col-md-6">
              <label for="id_date_of_birth" class="form-label">Date of Birth</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                {{ form.date_of_birth }}
              </div>
            </div>
            <div class="col-md-6">
              <label for="id_gender" class="form-label">Gender</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-venus-mars"></i></span>
                {{ form.gender }}
              </div>
            </div>
            <div class="col-12">
              <label for="id_address" class="form-label">Address</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                {{ form.address }}
              </div>
            </div>
            <div class="col-md-4">
              <label for="id_city" class="form-label">City</label>
              {{ form.city }}
            </div>
            <div class="col-md-4">
              <label for="id_state" class="form-label">State</label>
              {{ form.state }}
            </div>
            <div class="col-md-4">
              <label for="id_country" class="form-label">Country</label>
              {{ form.country }}
            </div>
            <div class="col-md-4">
              <label for="id_pincode" class="form-label">Pincode</label>
              {{ form.pincode }}
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <span class="spinner-border spinner-border-sm d-none" id="saveSpinner" role="status" aria-hidden="true"></span>
            <span id="saveText">Save Changes</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% block extra_js %}
<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Custom Scripts -->
<script>
// Initialize tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl)
});

// CSRF Token for AJAX
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// Profile Picture Upload
document.getElementById('profile-picture-upload').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  // Show loading state
  const uploadBtn = document.querySelector('label[for="profile-picture-upload"]');
  const originalIcon = uploadBtn.innerHTML;
  uploadBtn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
  
  const formData = new FormData();
  formData.append('profile_picture', file);
  
  fetch('{% url "update_profile_picture" %}', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Show success message
      const toast = new bootstrap.Toast(document.getElementById('successToast'));
      document.getElementById('toastMessage').textContent = 'Profile picture updated successfully!';
      toast.show();
      
      // Update the image preview
      const reader = new FileReader();
      reader.onload = function(e) {
        const profileImg = document.querySelector('.profile-avatar');
        if (profileImg) {
          profileImg.src = e.target.result;
        }
      }
      reader.readAsDataURL(file);
    } else {
      throw new Error(data.error || 'Failed to update profile picture');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    const toast = new bootstrap.Toast(document.getElementById('errorToast'));
    document.getElementById('errorToastMessage').textContent = error.message || 'An error occurred while uploading the image';
    toast.show();
  })
  .finally(() => {
    // Reset the button
    uploadBtn.innerHTML = originalIcon;
  });
});

// Form validation and submission
(function() {
  'use strict';
  
  // Fetch the form we want to apply custom Bootstrap validation styles to
  const form = document.getElementById('profileForm');
  
  // Add event listener for form submission
  form.addEventListener('submit', function(event) {
    if (!form.checkValidity()) {
      event.preventDefault();
      event.stopPropagation();
    } else {
      // Show loading state
      const saveBtn = document.querySelector('#profileForm button[type="submit"]');
      const saveSpinner = document.getElementById('saveSpinner');
      const saveText = document.getElementById('saveText');
      
      saveBtn.disabled = true;
      saveSpinner.classList.remove('d-none');
      saveText.textContent = 'Saving...';
      
      // If form is valid, submit via AJAX
      event.preventDefault();
      
      const formData = new FormData(form);
      
      fetch('{% url "update_profile" %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Show success message
          const toast = new bootstrap.Toast(document.getElementById('successToast'));
          document.getElementById('toastMessage').textContent = 'Profile updated successfully!';
          toast.show();
          
          // Close the modal after a short delay
          setTimeout(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
            modal.hide();
            window.location.reload();
          }, 1500);
        } else {
          throw new Error(data.error || 'Failed to update profile');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        const toast = new bootstrap.Toast(document.getElementById('errorToast'));
        document.getElementById('errorToastMessage').textContent = error.message || 'An error occurred while saving your changes';
        toast.show();
      })
      .finally(() => {
        // Reset button state
        saveBtn.disabled = false;
        saveSpinner.classList.add('d-none');
        saveText.textContent = 'Save Changes';
      });
    }
    
    form.classList.add('was-validated');
  }, false);
})();

// Initialize date picker for date of birth field
if (document.getElementById('id_date_of_birth')) {
  const datePicker = new Pikaday({
    field: document.getElementById('id_date_of_birth'),
    format: 'YYYY-MM-DD',
    maxDate: new Date(),
    yearRange: [1900, new Date().getFullYear()],
    showMonthAfterYear: true,
    i18n: {
      previousMonth: 'Previous Month',
      nextMonth: 'Next Month',
      months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
      weekdays: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
      weekdaysShort: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
    }
  });
}

// Add animation to booking rows
const bookingRows = document.querySelectorAll('.booking-row');
bookingRows.forEach((row, index) => {
  row.style.opacity = '0';
  row.style.transform = 'translateX(20px)';
  row.style.transition = `all 0.4s ease ${index * 0.1}s`;
  
  setTimeout(() => {
    row.style.opacity = '1';
    row.style.transform = 'translateX(0)';
  }, 100);
});
</script>
{% endblock %}

<!-- Toast Notifications -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <!-- Success Toast -->
  <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" id="successToast">
    <div class="d-flex">
      <div class="toast-body d-flex align-items-center">
        <i class="fas fa-check-circle me-2"></i>
        <span id="toastMessage">Operation completed successfully!</span>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
  
  <!-- Error Toast -->
  <div class="toast align-items-center text-white bg-danger border-0 mt-2" role="alert" aria-live="assertive" aria-atomic="true" id="errorToast">
    <div class="d-flex">
      <div class="toast-body d-flex align-items-center">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span id="errorToastMessage">An error occurred. Please try again.</span>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>
{% endblock %}
