{% extends 'base.html' %}
{% load static %}
{% load travel_filters %}

{% block title %}Booking - Safar Zone Travels{% endblock %}

{% block content %}
<div class="bg-gradient-to-br from-gray-50 to-blue-50 py-8">
    <div class="container mx-auto px-4">
        <div class="max-w-7xl mx-auto">
            <!-- Progress Bar -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div
                            class="w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center font-bold shadow-lg">
                            1</div>
                        <span class="font-bold text-gray-800 hidden sm:inline">Passenger Details</span>
                        <span class="font-bold text-gray-800 sm:hidden">Passenger</span>
                    </div>
                    <div class="flex-1 border-t-2 border-primary mx-2 sm:mx-4"></div>
                    <div class="flex items-center space-x-3">
                        <div
                            class="w-10 h-10 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center font-bold">
                            2</div>
                        <span class="text-gray-500 hidden sm:inline">Review Booking</span>
                        <span class="text-gray-500 sm:hidden">Review</span>
                    </div>
                    <div class="flex-1 border-t-2 border-gray-300 mx-2 sm:mx-4"></div>
                    <div class="flex items-center space-x-3">
                        <div
                            class="w-10 h-10 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center font-bold">
                            3</div>
                        <span class="text-gray-500 hidden sm:inline">Confirmation</span>
                        <span class="text-gray-500 sm:hidden">Confirm</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Booking Form -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-2xl shadow-lg p-8">
                        <div class="flex items-center mb-6">
                            <div class="bg-primary bg-opacity-10 rounded-full p-3 mr-4">
                                <i class="fas fa-users text-primary text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">Passenger Details</h2>
                                <p class="text-gray-600">
                                    {% if adults > 0 %}{{ adults }} Adult{{ adults|pluralize }}{% endif %}
                                    {% if children > 0 %}{% if adults > 0 %}, {% endif %}{{ children }} Child{{
                                    children|pluralize }}{% endif %}
                                    {% if infants > 0 %}{% if adults > 0 or children > 0 %}, {% endif %}{{ infants }}
                                    Infant{{ infants|pluralize }}{% endif %}
                                </p>
                            </div>
                        </div>

                        <form method="POST" id="bookingForm">
                            {% csrf_token %}
                            {% if return_schedule %}
                            <input type="hidden" name="return_schedule_id" value="{{ return_schedule.id }}">
                            <input type="hidden" name="trip_type" value="{{ trip_type }}">
                            {% endif %}

                            <!-- Adults Section -->
                            {% if adults > 0 %}
                            <div class="mb-8 p-6 border-2 border-blue-200 rounded-2xl bg-blue-50" id="adults-section"
                                data-section-type="adults">
                                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-user text-blue-600 mr-2"></i>
                                    Adults (12+ years) - {{ adults }} Passenger{{ adults|pluralize }}
                                </h3>
                                {% for passenger in adult_passengers %}
                                <div class="mb-6 p-4 bg-white rounded-xl border border-blue-200 passenger-form"
                                    data-passenger-type="adult" data-passenger-index="{{ forloop.counter0 }}">
                                    <h4 class="font-semibold text-gray-700 mb-4">Adult {{ forloop.counter }}</h4>
                                    {% include 'booking_passenger_fields.html' with passenger_index=forloop.counter0
                                    passenger_type='adult' today=today passenger=passenger %}
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}

                            <!-- Children Section -->
                            {% if children > 0 %}
                            <div class="mb-8 p-6 border-2 border-green-200 rounded-2xl bg-green-50"
                                id="children-section" data-section-type="children">
                                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-child text-green-600 mr-2"></i>
                                    Children (2-11 years) - {{ children }} Passenger{{ children|pluralize }}
                                </h3>
                                {% for passenger in child_passengers %}
                                <div class="mb-6 p-4 bg-white rounded-xl border border-green-200 passenger-form"
                                    data-passenger-type="child"
                                    data-passenger-index="{{ forloop.counter0|add:adults }}">
                                    <h4 class="font-semibold text-gray-700 mb-4">Child {{ forloop.counter }}</h4>
                                    {% include 'booking_passenger_fields.html' with
                                    passenger_index=forloop.counter0|add:adults passenger_type='child' today=today
                                    passenger=passenger %}
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}

                            <!-- Infants Section -->
                            {% if infants > 0 %}
                            <div class="mb-8 p-6 border-2 border-orange-200 rounded-2xl bg-orange-50"
                                id="infants-section" data-section-type="infants">
                                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-baby text-orange-600 mr-2"></i>
                                    Infants (0-2 years) - {{ infants }} Passenger{{ infants|pluralize }}
                                    <span class="ml-2 text-sm font-normal text-orange-700">(No seat, travels on mother's
                                        lap)</span>
                                </h3>
                                {% for passenger in infant_passengers %}
                                <div class="mb-6 p-4 bg-white rounded-xl border border-orange-200 passenger-form"
                                    data-passenger-type="infant"
                                    data-passenger-index="{{ forloop.counter0|add:adults|add:children }}">
                                    <h4 class="font-semibold text-gray-700 mb-4">Infant {{ forloop.counter }}</h4>
                                    {% include 'booking_passenger_fields.html' with
                                    passenger_index=forloop.counter0|add:adults|add:children passenger_type='infant'
                                    today=today passenger=passenger %}
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}

                            <!-- Contact Information -->
                            <div class="mb-6 p-6 border-2 border-gray-200 rounded-2xl bg-gray-50">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Contact Information</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="form-group">
                                        <label for="contact_email" class="block text-gray-700 font-semibold mb-2">
                                            Contact Email <span class="text-red-500">*</span>
                                        </label>
                                        <input type="email" name="contact_email" id="contact_email" required
                                            value="{{ booking_data.contact_email|default:user.email }}"
                                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary">
                                    </div>
                                    <div class="form-group">
                                        <label for="contact_phone" class="block text-gray-700 font-semibold mb-2">
                                            Contact Phone <span class="text-red-500">*</span>
                                            <span class="text-sm text-gray-500 font-normal">(10 digits only)</span>
                                        </label>
                                        <input type="tel" name="contact_phone" id="contact_phone" required
                                            pattern="[0-9]{10}" maxlength="10" minlength="10" inputmode="numeric"
                                            placeholder="9876543210"
                                            title="Please enter exactly 10 digits (e.g., 9876543210)"
                                            value="{{ booking_data.contact_phone|default:'' }}"
                                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary"
                                            oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10)">
                                        <p class="text-xs text-gray-500 mt-1">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Enter 10-digit mobile number (e.g., 9876543210)
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <input type="hidden" name="seats_booked" value="{{ passengers }}">

                            <!-- Terms and Conditions -->
                            <div class="mb-6">
                                <label class="flex items-start space-x-3 cursor-pointer">
                                    <input type="checkbox" required
                                        class="mt-1 w-5 h-5 text-primary border-2 border-gray-300 rounded focus:ring-primary">
                                    <span class="text-gray-700 text-sm">
                                        I agree to the <a href="#" class="text-primary hover:underline">terms and
                                            conditions</a>
                                        and <a href="#" class="text-primary hover:underline">cancellation policy</a>
                                    </span>
                                </label>
                            </div>

                            <!-- Submit Button -->
                            <button type="submit" class="btn btn-primary w-full py-4 text-lg" id="submit-booking-btn">
                                <i class="fas fa-eye mr-2"></i>Review Booking
                            </button>
                        </form>

                        <!-- Hidden fields to preserve passenger counts -->
                        <input type="hidden" name="adults_count" value="{{ adults }}" id="adults_count_hidden">
                        <input type="hidden" name="children_count" value="{{ children }}" id="children_count_hidden">
                        <input type="hidden" name="infants_count" value="{{ infants }}" id="infants_count_hidden">
                    </div>
                </div>

                <!-- Fare Breakdown Sidebar -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-24">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Fare Breakdown</h3>

                        <!-- Flight Details -->
                        <div class="mb-6 pb-4 border-b">
                            <p class="text-sm text-gray-600 mb-2">{{ schedule.route.from_location }} → {{
                                schedule.route.to_location }}</p>
                            <p class="text-xs text-gray-500">{{ schedule.departure_date|date:"d F Y" }}</p>
                        </div>

                        <!-- Outbound Fare Breakdown -->
                        <div class="mb-4">
                            <h4 class="text-sm font-bold text-gray-700 mb-3">Outbound Flight</h4>
                            <div class="space-y-2" id="outbound-fare-breakdown">
                                {% if adults > 0 %}
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">{{ adults }}x Adult (₹{{ adult_fare_int }}):</span>
                                    <span class="font-semibold" id="adult-fare-total">₹0.00</span>
                                </div>
                                {% endif %}
                                {% if children > 0 %}
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">{{ children }}x Child (₹{{ child_fare_int }}):</span>
                                    <span class="font-semibold" id="child-fare-total">₹0.00</span>
                                </div>
                                {% endif %}
                                {% if infants > 0 %}
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">{{ infants }}x Infant (₹{{ infant_fare_int }}):</span>
                                    <span class="font-semibold" id="infant-fare-total">₹0.00</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Return Fare Breakdown -->
                        {% if trip_type == 'return' and return_schedule %}
                        <div class="mb-4 pb-4 border-b">
                            <h4 class="text-sm font-bold text-gray-700 mb-3">Return Flight</h4>
                            <div class="space-y-2" id="return-fare-breakdown">
                                {% if adults > 0 %}
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">{{ adults }}x Adult (₹{{ return_adult_fare_int
                                        }}):</span>
                                    <span class="font-semibold" id="return-adult-fare-total">₹0.00</span>
                                </div>
                                {% endif %}
                                {% if children > 0 %}
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">{{ children }}x Child (₹{{ return_child_fare_int
                                        }}):</span>
                                    <span class="font-semibold" id="return-child-fare-total">₹0.00</span>
                                </div>
                                {% endif %}
                                {% if infants > 0 %}
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">{{ infants }}x Infant (₹{{ return_infant_fare_int
                                        }}):</span>
                                    <span class="font-semibold" id="return-infant-fare-total">₹0.00</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Total Calculation -->
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Base Fare:</span>
                                <span class="font-semibold" id="base-fare-total">₹0.00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                            </div>
                            <div class="border-t pt-3 mt-3">
                                <div class="flex justify-between text-lg font-bold text-primary">
                                    <span>Total Amount:</span>
                                    <span id="total-amount">₹0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Ensure passenger forms are always visible - AGGRESSIVE */
    .passenger-form,
    .passenger-form *,
    div[data-passenger-type="adult"],
    div[data-passenger-type="child"],
    div[data-passenger-type="infant"],
    #adults-section,
    #children-section,
    #infants-section,
    div[data-section-type="adults"],
    div[data-section-type="children"],
    div[data-section-type="infants"],
    div[class*="border-blue-200"],
    div[class*="border-green-200"],
    div[class*="border-orange-200"],
    div.bg-blue-50,
    div.bg-green-50,
    div.bg-orange-50 {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        z-index: 1 !important;
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
    }

    /* Prevent any hiding animations */
    .passenger-form,
    div[data-passenger-type],
    #adults-section,
    #children-section,
    #infants-section {
        animation: none !important;
        transition: none !important;
    }

    /* Ensure all form fields are visible */
    .passenger-form input,
    .passenger-form select,
    .passenger-form label,
    .passenger-form .form-group,
    #adults-section input,
    #adults-section select,
    #adults-section label,
    #children-section input,
    #children-section select,
    #children-section label {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        z-index: 1 !important;
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
    }
</style>

<script>
    // Fare calculation
    const adultFare = {{ adult_fare_int }};
    const childFare = {{ child_fare_int }};
    const infantFare = {{ infant_fare_int }};
    const adults = {{ adults }};
    const children = {{ children }};
    const infants = {{ infants }};
    {% if trip_type == 'return' and return_schedule %}
    const returnAdultFare = {{ return_adult_fare_int }};
    const returnChildFare = {{ return_child_fare_int }};
    const returnInfantFare = {{ return_infant_fare_int }};
    {% else %}
    const returnAdultFare = 0;
    const returnChildFare = 0;
    const returnInfantFare = 0;
    {% endif %}

    // Force passenger forms to be visible on page load - AGGRESSIVE VERSION
    function ensurePassengerFormsVisible() {
        // Get all passenger forms
        const passengerForms = document.querySelectorAll('.passenger-form');
        passengerForms.forEach(form => {
            if (form) {
                form.style.setProperty('display', 'block', 'important');
                form.style.setProperty('visibility', 'visible', 'important');
                form.style.setProperty('opacity', '1', 'important');
                form.style.setProperty('position', 'relative', 'important');
                form.style.setProperty('z-index', '1', 'important');
                form.style.setProperty('height', 'auto', 'important');
                form.classList.remove('hidden', 'd-none', 'invisible');

                // Also ensure all child elements are visible
                const children = form.querySelectorAll('*');
                children.forEach(child => {
                    const computedStyle = window.getComputedStyle(child);
                    if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden') {
                        child.style.setProperty('display', 'block', 'important');
                        child.style.setProperty('visibility', 'visible', 'important');
                    }
                });
            }
        });

        // Ensure sections by ID first (most reliable)
        const adultSection = document.getElementById('adults-section');
        const childSection = document.getElementById('children-section');
        const infantSection = document.getElementById('infants-section');

        // Also try by class selector as backup
        const adultSectionByClass = document.querySelector('div.border-2.border-blue-200, div[class*="border-blue-200"]');
        const childSectionByClass = document.querySelector('div.border-2.border-green-200, div[class*="border-green-200"]');
        const infantSectionByClass = document.querySelector('div.border-2.border-orange-200, div[class*="border-orange-200"]');

        // Use ID selector first, fallback to class selector
        const sections = [
            adultSection || adultSectionByClass,
            childSection || childSectionByClass,
            infantSection || infantSectionByClass
        ];

        sections.forEach(section => {
            if (section) {
                section.style.setProperty('display', 'block', 'important');
                section.style.setProperty('visibility', 'visible', 'important');
                section.style.setProperty('opacity', '1', 'important');
                section.style.setProperty('height', 'auto', 'important');
                section.style.setProperty('min-height', 'auto', 'important');
                section.style.setProperty('max-height', 'none', 'important');
                section.classList.remove('hidden', 'd-none', 'invisible');

                // Check all children in sections
                const sectionChildren = section.querySelectorAll('*');
                sectionChildren.forEach(child => {
                    const computedStyle = window.getComputedStyle(child);
                    if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden' || computedStyle.opacity === '0') {
                        child.style.setProperty('display', 'block', 'important');
                        child.style.setProperty('visibility', 'visible', 'important');
                        child.style.setProperty('opacity', '1', 'important');
                    }
                });
            }
        });
    }

    function calculateFares() {
        // Outbound fares
        const outboundAdultTotal = adultFare * adults;
        const outboundChildTotal = childFare * children;
        const outboundInfantTotal = infantFare * infants;
        const outboundBaseFare = outboundAdultTotal + outboundChildTotal + outboundInfantTotal;

        // Return fares
        const returnAdultTotal = returnAdultFare * adults;
        const returnChildTotal = returnChildFare * children;
        const returnInfantTotal = returnInfantFare * infants;
        const returnBaseFare = returnAdultTotal + returnChildTotal + returnInfantTotal;

        // Total base fare
        const totalBaseFare = outboundBaseFare + returnBaseFare;

        // Tax removed as per client request
        const taxAmount = 0;

        // Total amount
        const totalAmount = totalBaseFare + taxAmount;

        // Update display
        if (adults > 0) {
            const adultEl = document.getElementById('adult-fare-total');
            if (adultEl) adultEl.textContent = '₹' + outboundAdultTotal.toFixed(2);
        }
        if (children > 0) {
            const childEl = document.getElementById('child-fare-total');
            if (childEl) childEl.textContent = '₹' + outboundChildTotal.toFixed(2);
        }
        if (infants > 0) {
            const infantEl = document.getElementById('infant-fare-total');
            if (infantEl) infantEl.textContent = '₹' + outboundInfantTotal.toFixed(2);
        }

        // Update return fares if return trip
        if (returnAdultFare > 0 && adults > 0) {
            const returnAdultEl = document.getElementById('return-adult-fare-total');
            if (returnAdultEl) returnAdultEl.textContent = '₹' + returnAdultTotal.toFixed(2);
        }
        if (returnChildFare > 0 && children > 0) {
            const returnChildEl = document.getElementById('return-child-fare-total');
            if (returnChildEl) returnChildEl.textContent = '₹' + returnChildTotal.toFixed(2);
        }
        if (returnInfantFare > 0 && infants > 0) {
            const returnInfantEl = document.getElementById('return-infant-fare-total');
            if (returnInfantEl) returnInfantEl.textContent = '₹' + returnInfantTotal.toFixed(2);
        }

        const baseFareEl = document.getElementById('base-fare-total');
        const taxEl = document.getElementById('tax-amount');
        const totalEl = document.getElementById('total-amount');

        if (baseFareEl) baseFareEl.textContent = '₹' + totalBaseFare.toFixed(2);
        if (taxEl) taxEl.textContent = '₹' + taxAmount.toFixed(2);
        if (totalEl) totalEl.textContent = '₹' + totalAmount.toFixed(2);
    }

    // Override any remove() or hide() functions that might affect passenger sections
    const originalRemove = Element.prototype.remove;
    Element.prototype.remove = function () {
        if (this.id === 'adults-section' ||
            this.id === 'children-section' ||
            this.id === 'infants-section' ||
            this.closest('#adults-section') ||
            this.closest('#children-section') ||
            this.closest('#infants-section') ||
            this.classList.contains('passenger-form')) {
            console.warn('Prevented removal of passenger section');
            ensurePassengerFormsVisible();
            return; // Don't remove
        }
        return originalRemove.call(this);
    };

    // Calculate on page load and ensure forms are visible
    document.addEventListener('DOMContentLoaded', function () {
        calculateFares();
        ensurePassengerFormsVisible();

        // Run multiple times to catch any late-loading scripts
        setTimeout(ensurePassengerFormsVisible, 50);
        setTimeout(ensurePassengerFormsVisible, 100);
        setTimeout(ensurePassengerFormsVisible, 200);
        setTimeout(ensurePassengerFormsVisible, 500);
        setTimeout(ensurePassengerFormsVisible, 1000);
        setTimeout(ensurePassengerFormsVisible, 2000);
        setTimeout(ensurePassengerFormsVisible, 5000); // After base.html's auto-hide

        // Continuous check every 200ms (more frequent)
        setInterval(ensurePassengerFormsVisible, 200);
    });

    // Also ensure visibility on window load
    window.addEventListener('load', function () {
        ensurePassengerFormsVisible();
        // Start continuous monitoring every 200ms
        setInterval(ensurePassengerFormsVisible, 200);
    });

    // Use MutationObserver to prevent forms from being hidden - AGGRESSIVE
    const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
            const target = mutation.target;

            // Check if target is a passenger form or section
            const isPassengerForm = target.classList && target.classList.contains('passenger-form');
            const isPassengerSection = target.id === 'adults-section' ||
                target.id === 'children-section' ||
                target.id === 'infants-section' ||
                (target.classList && (
                    target.classList.contains('border-blue-200') ||
                    target.classList.contains('border-green-200') ||
                    target.classList.contains('border-orange-200') ||
                    target.classList.contains('bg-blue-50') ||
                    target.classList.contains('bg-green-50') ||
                    target.classList.contains('bg-orange-50')
                ));
            const hasPassengerType = target.dataset && (target.dataset.passengerType || target.dataset.sectionType);

            if (isPassengerForm || isPassengerSection || hasPassengerType) {
                const style = window.getComputedStyle(target);
                if (style.display === 'none' || style.visibility === 'hidden' || style.opacity === '0' || style.height === '0px') {
                    target.style.setProperty('display', 'block', 'important');
                    target.style.setProperty('visibility', 'visible', 'important');
                    target.style.setProperty('opacity', '1', 'important');
                    target.style.setProperty('height', 'auto', 'important');
                }
                if (target.classList.contains('hidden') || target.classList.contains('d-none')) {
                    target.classList.remove('hidden', 'd-none', 'invisible');
                    target.style.setProperty('display', 'block', 'important');
                    target.style.setProperty('visibility', 'visible', 'important');
                    target.style.setProperty('opacity', '1', 'important');
                    target.style.setProperty('height', 'auto', 'important');
                }
            }

            // Also check for child elements being removed
            if (mutation.type === 'childList' && mutation.removedNodes.length > 0) {
                mutation.removedNodes.forEach(node => {
                    if (node.nodeType === 1 && (
                        node.classList.contains('passenger-form') ||
                        node.id === 'adults-section' ||
                        node.id === 'children-section' ||
                        node.id === 'infants-section' ||
                        node.classList.contains('border-blue-200') ||
                        node.classList.contains('border-green-200') ||
                        node.classList.contains('border-orange-200')
                    )) {
                        // If a passenger form was removed, restore it
                        ensurePassengerFormsVisible();
                    }
                });
            }
        });
    });

    // Start observing when DOM is ready
    document.addEventListener('DOMContentLoaded', function () {
        // Observe all passenger forms
        const passengerForms = document.querySelectorAll('.passenger-form');
        passengerForms.forEach(form => {
            observer.observe(form, {
                attributes: true,
                attributeFilter: ['style', 'class'],
                childList: true,
                subtree: true
            });
        });

        // Also observe parent sections by ID (most reliable)
        const adultSectionEl = document.getElementById('adults-section');
        const childSectionEl = document.getElementById('children-section');
        const infantSectionEl = document.getElementById('infants-section');

        [adultSectionEl, childSectionEl, infantSectionEl].forEach(section => {
            if (section) {
                observer.observe(section, {
                    attributes: true,
                    attributeFilter: ['style', 'class'],
                    childList: true,
                    subtree: true
                });
            }
        });

        // Also observe by class selector as backup
        const sections = document.querySelectorAll('div[class*="border-blue-200"], div[class*="border-green-200"], div[class*="border-orange-200"]');
        sections.forEach(section => {
            if (section && section.id !== 'adults-section' && section.id !== 'children-section' && section.id !== 'infants-section') {
                observer.observe(section, {
                    attributes: true,
                    attributeFilter: ['style', 'class'],
                    childList: true,
                    subtree: true
                });
            }
        });

        // Also observe the form container
        const formContainer = document.getElementById('bookingForm');
        if (formContainer) {
            observer.observe(formContainer, {
                childList: true,
                subtree: true
            });
        }
    });

    // Form validation before submission
    document.getElementById('bookingForm').addEventListener('submit', function (e) {
        const adults = {{ adults }
    };
    const children = {{ children }};
    const infants = {{ infants }};
    const totalPassengers = adults + children + infants;

    let isValid = true;
    let missingFields = [];

    // Check all passenger forms
    for (let i = 0; i < totalPassengers; i++) {
        const firstName = document.getElementById(`passenger_first_name_${i}`);
        const lastName = document.getElementById(`passenger_last_name_${i}`);
        const dob = document.getElementById(`passenger_dob_${i}`);
        const gender = document.getElementById(`passenger_gender_${i}`);
        const title = document.getElementById(`passenger_title_${i}`);
        const nationality = document.getElementById(`nationality_${i}`);

        if (!firstName || !firstName.value || !firstName.value.trim()) {
            isValid = false;
            missingFields.push(`Passenger ${i + 1}: First Name`);
            if (firstName) firstName.style.borderColor = '#ef4444';
        }
        if (!lastName || !lastName.value || !lastName.value.trim()) {
            isValid = false;
            missingFields.push(`Passenger ${i + 1}: Last Name`);
            if (lastName) lastName.style.borderColor = '#ef4444';
        }
        if (!dob || !dob.value || !dob.value.trim()) {
            isValid = false;
            missingFields.push(`Passenger ${i + 1}: Date of Birth`);
            if (dob) dob.style.borderColor = '#ef4444';
        }
        if (!gender || !gender.value || !gender.value.trim()) {
            isValid = false;
            missingFields.push(`Passenger ${i + 1}: Gender`);
            if (gender) gender.style.borderColor = '#ef4444';
        }
        if (!title || !title.value || !title.value.trim()) {
            isValid = false;
            missingFields.push(`Passenger ${i + 1}: Title`);
            if (title) title.style.borderColor = '#ef4444';
        }
        if (!nationality || !nationality.value || !nationality.value.trim()) {
            isValid = false;
            missingFields.push(`Passenger ${i + 1}: Nationality`);
            if (nationality) nationality.style.borderColor = '#ef4444';
        }
    }

    // Check contact information
    const contactEmail = document.getElementById('contact_email');
    const contactPhone = document.getElementById('contact_phone');

    if (!contactEmail || !contactEmail.value || !contactEmail.value.trim()) {
        isValid = false;
        missingFields.push('Contact Email');
        if (contactEmail) contactEmail.style.borderColor = '#ef4444';
    }
    if (!contactPhone || !contactPhone.value || !contactPhone.value.trim()) {
        isValid = false;
        missingFields.push('Contact Phone');
        if (contactPhone) contactPhone.style.borderColor = '#ef4444';
    } else {
        // Validate phone number is exactly 10 digits
        const phoneValue = contactPhone.value.replace(/[^0-9]/g, '');
        if (phoneValue.length !== 10) {
            isValid = false;
            missingFields.push('Contact Phone (must be exactly 10 digits)');
            contactPhone.style.borderColor = '#ef4444';
        } else if (!['6', '7', '8', '9'].includes(phoneValue[0])) {
            isValid = false;
            missingFields.push('Contact Phone (must start with 6, 7, 8, or 9)');
            contactPhone.style.borderColor = '#ef4444';
        }
    }

    if (!isValid) {
        e.preventDefault();
        alert('Please fill in all required fields:\n\n' + missingFields.join('\n'));
        // Scroll to first error
        const firstError = document.querySelector('[style*="border-color: rgb(239, 68, 68)"]');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstError.focus();
        }
        return false;
    }

    // If valid, allow form submission
    return true;
    });

    // Update title options based on passenger type and gender
    function updateTitleOptions(passengerIndex) {
        const titleSelect = document.getElementById(`passenger_title_${passengerIndex}`);
        const genderSelect = document.getElementById(`passenger_gender_${passengerIndex}`);
        const passengerForm = titleSelect ? titleSelect.closest('.passenger-form') : null;
        const passengerType = passengerForm ? passengerForm.dataset.passengerType : 'adult';

        if (!titleSelect || !genderSelect) return;

        const gender = genderSelect.value;
        const currentTitle = titleSelect.value;

        // Clear and rebuild options
        titleSelect.innerHTML = '<option value="">Select Title</option>';

        if (passengerType === 'infant' || passengerType === 'child') {
            // For children/infants: Master for male, Miss for female
            if (gender === 'M' || gender === '') {
                titleSelect.innerHTML += '<option value="Master">Master</option>';
            }
            if (gender === 'F' || gender === '') {
                titleSelect.innerHTML += '<option value="Miss">Miss</option>';
            }
        } else {
            // For adults: Mr, Mrs, Miss based on gender
            if (gender === 'M' || gender === '') {
                titleSelect.innerHTML += '<option value="Mr">Mr</option>';
            }
            if (gender === 'F' || gender === '') {
                titleSelect.innerHTML += '<option value="Mrs">Mrs</option>';
                titleSelect.innerHTML += '<option value="Miss">Miss</option>';
            }
            if (gender === 'O' || gender === '') {
                titleSelect.innerHTML += '<option value="Mr">Mr</option>';
                titleSelect.innerHTML += '<option value="Mrs">Mrs</option>';
                titleSelect.innerHTML += '<option value="Miss">Miss</option>';
            }
        }

        // Try to restore previous selection if still valid
        if (currentTitle) {
            const option = Array.from(titleSelect.options).find(opt => opt.value === currentTitle);
            if (option) {
                titleSelect.value = currentTitle;
            }
        }
    }
</script>
{% endblock %}