{% extends 'base.html' %}
{% load static %}
{% load travel_filters %}

{% block title %}Search Results - Safar Zone Travels{% endblock %}

{% block extra_css %}
<style>
    .flight-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }
    .flight-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    .badge-domestic {
        background-color: #e3f2fd;
        color: #1976d2;
    }
    .badge-international {
        background-color: #e8f5e9;
        color: #2e7d32;
    }
    .flight-time {
        font-size: 1.25rem;
        font-weight: 600;
    }
    .flight-duration {
        position: relative;
        height: 2px;
        background: #dee2e6;
        margin: 20px 0;
    }
    .flight-duration:after {
        content: '';
        position: absolute;
        top: -4px;
        left: 0;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #0d6efd;
    }
    .flight-duration:before {
        content: '';
        position: absolute;
        top: -4px;
        right: 0;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #0d6efd;
    }
    .flight-stops {
        position: absolute;
        left: 50%;
        top: -10px;
        transform: translateX(-50%);
        background: white;
        padding: 0 10px;
        font-size: 0.8rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Search Summary Card -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex flex-column flex-md-row align-items-center mb-3 mb-md-0">
                        <div class="text-center mb-3 mb-md-0 me-md-4">
                            <div class="text-muted small">From</div>
                            <div class="h4 mb-0 fw-bold">
                                {{ from_location }}
                                {% if from_airport_code %}
                                <small class="text-muted">({{ from_airport_code }})</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mx-3 d-none d-md-block">
                            <i class="fas fa-plane fa-lg text-primary"></i>
                        </div>
                        <div class="text-center">
                            <div class="text-muted small">To</div>
                            <div class="h4 mb-0 fw-bold">
                                {{ to_location }}
                                {% if to_airport_code %}
                                <small class="text-muted">({{ to_airport_code }})</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="ms-md-4 mt-3 mt-md-0">
                            <div class="d-flex flex-wrap gap-3">
                                {% if travel_date %}
                                <div class="border-end pe-3 me-3">
                                    <div class="text-muted small">Date</div>
                                    <div class="fw-medium">{{ travel_date|date:"d M Y" }}</div>
                                </div>
                                {% endif %}
                                {% if passengers %}
                                <div class="border-end pe-3 me-3">
                                    <div class="text-muted small">Passengers</div>
                                    <div class="fw-medium">{{ passengers }} {% if passengers > 1 %}Travelers{% else %}Traveler{% endif %}</div>
                                </div>
                                {% endif %}
                                {% if route_type %}
                                <div>
                                    <div class="text-muted small">Trip Type</div>
                                    <div class="fw-medium">{{ route_type|title }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <a href="{% url 'homepage' %}" class="btn btn-outline-primary">
                        <i class="fas fa-search me-2"></i>Modify Search
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
        <div class="mb-3 mb-md-0">
            <h2 class="h3 mb-1">
                {% if flights %}
                    Available Flights <span class="text-muted">({{ flights|length }})</span>
                {% else %}
                    No Flights Found
                {% endif %}
            </h2>
            {% if flights %}
            <p class="text-muted mb-0">Choose your preferred flight from the options below</p>
            {% endif %}
        </div>
        {% if flights %}
        <div class="d-flex gap-2">
            <button id="compareBtn" class="btn btn-outline-primary d-none">
                <i class="fas fa-balance-scale me-2"></i>Compare (<span id="compareCount">0</span>)
            </button>
            <button id="clearCompareBtn" class="btn btn-outline-secondary d-none">
                <i class="fas fa-times me-2"></i>Clear
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Flight List -->
    {% if flights %}
        <div class="row g-4">
            {% for flight in flights %}
            <div class="col-12" data-flight-id="{{ flight.id }}">
                <div class="card flight-card h-100 {% if not flight.is_available %}opacity-75{% endif %}">
                    <div class="card-body p-4">
                        <!-- Flight Header -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="d-flex align-items-center">
                                <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
                                    <i class="fas fa-plane text-primary"></i>
                                </div>
                                <div>
                                    <h5 class="card-title mb-0">{{ flight.route.carrier_number }}</h5>
                                    <span class="badge {% if flight.route.route_type == 'international' %}badge-international{% else %}badge-domestic{% endif %} rounded-pill">
                                        {{ flight.route.route_type|title }}
                                    </span>
                                </div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input compare-checkbox" type="checkbox" 
                                       id="compare-{{ flight.id }}" 
                                       data-flight-id="{{ flight.id }}"
                                       data-flight-number="{{ flight.route.carrier_number }}"
                                       data-from="{{ flight.route.from_location }}"
                                       data-to="{{ flight.route.to_location }}"
                                       data-price="{{ flight.price }}"
                                       data-duration="{{ flight.route.duration }}"
                                       data-travel-date="{{ flight.departure_date|date:'d M Y' }}"
                                       data-departure-time="{{ flight.route.departure_time }}"
                                       data-available-seats="{{ flight.available_seats }}"
                                       {% if not flight.is_available %}disabled{% endif %}>
                                <label class="form-check-label small text-muted" for="compare-{{ flight.id }}">
                                    Compare
                                </label>
                            </div>
                        </div>

                        <!-- Flight Route -->
                        <div class="row align-items-center my-4">
                            <div class="col-4">
                                <div class="flight-time">
                                    {{ flight.route.departure_time }}
                                </div>
                                <div class="text-muted small">
                                    {{ flight.departure_date|date:"D, d M" }}
                                </div>
                                <div class="fw-medium">
                                    {{ flight.route.from_location }}
                                    <span class="text-muted small">({{ from_airport_code }})</span>
                                </div>
                            </div>
                            
                            <div class="col-4">
                                <div class="position-relative px-3">
                                    <div class="flight-duration">
                                        <span class="flight-stops">
                                            <i class="fas fa-circle text-primary me-1"></i> {{ flight.route.duration }}
                                        </span>
                                    </div>
                                    <div class="text-center mt-4">
                                        <span class="badge bg-light text-dark">
                                            <i class="fas fa-plane me-1"></i> Direct
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-4 text-end">
                                <div class="flight-time">
                                    {{ flight.route.arrival_time }}
                                </div>
                                <div class="text-muted small">
                                    {{ flight.departure_date|date:"D, d M" }}
                                </div>
                                <div class="fw-medium">
                                    {{ flight.route.to_location }}
                                    <span class="text-muted small">({{ to_airport_code }})</span>
                                </div>
                            </div>
                        </div>

                        <!-- Flight Details -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center text-muted small">
                                    <i class="fas fa-suitcase-rolling me-2"></i>
                                    <div>
                                        <div>Baggage: <span class="text-dark">15kg</span></div>
                                        <div class="text-truncate" title="Cabin: 7kg">Cabin: 7kg</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center text-muted small">
                                    <i class="fas fa-utensils me-2"></i>
                                    <div>Meal: <span class="text-dark">Included</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Price and Book Button -->
                        <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                            <div>
                                <div class="h4 mb-0 text-primary">₹{{ flight.price }}</div>
                                <div class="text-muted small">per person</div>
                            </div>
                            <div>
                                {% if flight.is_available %}
                                <a href="{% url 'booking' flight.id %}" class="btn btn-primary px-4">
                                    <i class="fas fa-ticket-alt me-2"></i>Book Now
                                </a>
                                {% else %}
                                <button class="btn btn-secondary px-4" disabled>
                                    <i class="fas fa-times-circle me-2"></i>Sold Out
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-secondary ms-2" 
                                        onclick="showFlightDetails({{ flight.id }})">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </div>
                        </div>

                                <!-- Arrival -->
                                <div class="text-center">
                                    <div class="mb-2">
                                        <p class="text-2xl md:text-3xl font-bold text-gray-800">
                                            {{ flight.route.to_location }}
                                            {% with to_code=airport_codes|get_item:flight.route.to_location %}
                                                {% if to_code %}
                                                    <span class="text-lg text-gray-500 ml-1">({{ to_code }})</span>
                                                {% endif %}
                                            {% endwith %}
                                        </p>
                                        <p class="text-sm text-gray-600 font-medium">Arrival</p>
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        <i class="fas fa-map-marker-alt mr-1"></i> Destination
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Flight Features -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                            <div class="bg-white border border-gray-100 rounded-lg p-3 text-center hover:bg-gray-50 transition-colors">
                                <i class="fas fa-suitcase text-blue-500 text-lg mb-1"></i>
                                <p class="text-xs text-gray-600">Baggage</p>
                                <p class="text-sm font-semibold">15kg</p>
                            </div>
                            <div class="bg-white border border-gray-100 rounded-lg p-3 text-center hover:bg-gray-50 transition-colors">
                                <i class="fas fa-utensils text-green-500 text-lg mb-1"></i>
                                <p class="text-xs text-gray-600">Meals</p>
                                <p class="text-sm font-semibold">Included</p>
                            </div>
                            <div class="bg-white border border-gray-100 rounded-lg p-3 text-center hover:bg-gray-50 transition-colors">
                                <i class="fas fa-wifi text-purple-500 text-lg mb-1"></i>
                                <p class="text-xs text-gray-600">WiFi</p>
                                <p class="text-sm font-semibold">Available</p>
                            </div>
                            <div class="bg-white border border-gray-100 rounded-lg p-3 text-center hover:bg-gray-50 transition-colors">
                                <i class="fas fa-chair text-orange-500 text-lg mb-1"></i>
                                <p class="text-xs text-gray-600">Seat</p>
                                <p class="text-sm font-semibold">Selectable</p>
                            </div>
                        </div>

                        <!-- Price and Availability -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="relative group">
                                    <div class="cursor-help">
                                        <p class="text-3xl md:text-4xl font-bold text-primary">₹{{ flight.price }}</p>
                                        <p class="text-sm text-gray-500">per person</p>
                                    </div>
                                    
                                    <!-- Price Breakdown Tooltip -->
                                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 hidden group-hover:block z-50">
                                        <div class="bg-gray-800 text-white text-sm rounded-lg shadow-xl p-4 min-w-64">
                                            <div class="space-y-2">
                                                <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                                    <span class="font-semibold">Price Breakdown</span>
                                                    <i class="fas fa-info-circle text-blue-400"></i>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Base Fare:</span>
                                                    <span>₹{{ flight.price|floatformat:0|add:"-2000" }}</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Taxes & Fees:</span>
                                                    <span>₹1,200</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Service Charge:</span>
                                                    <span>₹300</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Convenience Fee:</span>
                                                    <span>₹500</span>
                                                </div>
                                                <div class="border-t border-gray-600 pt-2 flex justify-between font-bold">
                                                    <span>Total:</span>
                                                    <span>₹{{ flight.price }}</span>
                                                </div>
                                                <div class="text-xs text-gray-400 pt-2 border-t border-gray-600">
                                                    <i class="fas fa-lightbulb mr-1"></i>
                                                    Price includes all taxes and fees
                                                </div>
                                            </div>
                                            <!-- Tooltip Arrow -->
                                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-800"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-600">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-chair mr-2 text-green-500"></i>
                                        <span class="font-semibold">{{ flight.available_seats }} seats left</span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fas fa-users mr-2 text-blue-500"></i>
                                        <span>{{ passengers }} passenger{{ passengers|pluralize }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right space-y-2">
                                <button onclick="showFlightDetails({{ flight.id }})" 
                                        class="btn btn-outline-primary text-sm px-4 py-2 w-full">
                                    <i class="fas fa-info-circle mr-1"></i>View Details
                                </button>
                                {% if flight.is_available %}
                                    <a href="{% url 'booking' flight.id %}?passengers={{ passengers }}" 
                                       class="btn btn-primary shadow-hover px-6 py-3 text-lg">
                                        <i class="fas fa-ticket-alt mr-2"></i>Book Now
                                    </a>
                                {% else %}
                                    <button disabled class="btn btn-secondary opacity-75 cursor-not-allowed px-6 py-3 text-lg w-full">
                                        <i class="fas fa-times mr-2"></i>Not Available
                                    </button>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Trust Indicators -->
                        <div class="mt-4 pt-4 border-t border-gray-100 flex flex-wrap gap-3 text-sm">
                            <span class="flex items-center text-green-600 bg-green-50 px-3 py-1 rounded-full">
                                <i class="fas fa-check-circle mr-2"></i>Instant Confirmation
                            </span>
                            <span class="flex items-center text-blue-600 bg-blue-50 px-3 py-1 rounded-full">
                                <i class="fas fa-shield-alt mr-2"></i>Safe & Secure
                            </span>
                            <span class="flex items-center text-purple-600 bg-purple-50 px-3 py-1 rounded-full">
                                <i class="fas fa-calendar-times mr-2"></i>Easy Cancellation
                            </span>
                            {% if not flight.is_available %}
                                <span class="text-red-600 flex items-center bg-red-50 px-3 py-1 rounded-full">
                                    <i class="fas fa-times-circle mr-2"></i>No longer available
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- No Results Message -->
        <div class="text-center py-16">
            <div class="bg-gray-50 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-search text-4xl text-gray-400"></i>
            </div>
            <h3 class="text-2xl md:text-3xl font-bold text-gray-700 mb-3">No Flights Found</h3>
            <p class="text-gray-500 text-lg mb-8 max-w-md mx-auto">We couldn't find any flights matching your search criteria. Try adjusting your travel dates or search for a different route.</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="{% url 'homepage' %}" class="btn btn-primary shadow-hover">
                    <i class="fas fa-arrow-left mr-2"></i>Modify Search
                </a>
                <button onclick="window.history.back()" class="btn btn-outline-secondary shadow-hover">
                    <i class="fas fa-chevron-left mr-2"></i>Go Back
                </button>
            </div>
        </div>
    {% endif %}

        <!-- Help Section -->
        <div class="mt-16 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-8 animate-on-scroll">
            <div class="text-center">
                <h3 class="text-2xl font-bold text-blue-800 mb-2">Need Help with Your Booking?</h3>
                <p class="text-blue-600 mb-8">Our travel experts are here to assist you 24/7</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition-all duration-300">
                        <div class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-phone text-blue-600 text-xl"></i>
                        </div>
                        <h4 class="font-bold text-gray-800 mb-2">Call Us</h4>
                        <p class="text-blue-600 font-semibold">+91 123 456 7890</p>
                        <p class="text-sm text-gray-500 mt-1">Available 24/7</p>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition-all duration-300">
                        <div class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-envelope text-blue-600 text-xl"></i>
                        </div>
                        <h4 class="font-bold text-gray-800 mb-2">Email Us</h4>
                        <p class="text-blue-600 font-semibold">support@travel.com</p>
                        <p class="text-sm text-gray-500 mt-1">Response within 2 hours</p>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition-all duration-300">
                        <div class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-comments text-blue-600 text-xl"></i>
                        </div>
                        <h4 class="font-bold text-gray-800 mb-2">Live Chat</h4>
                        <p class="text-blue-600 font-semibold">Instant Support</p>
                        <p class="text-sm text-gray-500 mt-1">Click to start chat</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Flight Details Modal -->
<div id="flightDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-gray-800">Flight Details</h2>
                <button onclick="closeFlightDetails()" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div id="modalContent" class="p-6">
            <!-- Modal content will be loaded here -->
        </div>
    </div>
</div>

<script>
function showFlightDetails(flightId) {
    // Show modal
    document.getElementById('flightDetailsModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    // Simulate loading flight details
    const modalContent = document.getElementById('modalContent');
    modalContent.innerHTML = `
        <div class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <p class="text-gray-600">Loading flight details...</p>
        </div>
    `;
    
    // Simulate API call delay
    setTimeout(() => {
        modalContent.innerHTML = `
            <div class="space-y-6">
                <!-- Flight Overview -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-100">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="bg-primary rounded-full p-3">
                                <i class="fas fa-plane text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Flight ${flightId}</h3>
                                <p class="text-gray-600">Direct Flight • 2h 30m</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">On Time</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-gray-800">Delhi</p>
                            <p class="text-sm text-gray-600">DEL • 08:30 AM</p>
                        </div>
                        <div class="flex items-center justify-center">
                            <div class="text-center">
                                <i class="fas fa-arrow-right text-primary text-2xl"></i>
                                <p class="text-xs text-gray-500 mt-1">2h 30m</p>
                            </div>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-gray-800">Mumbai</p>
                            <p class="text-sm text-gray-600">BOM • 11:00 AM</p>
                        </div>
                    </div>
                </div>

                <!-- Aircraft & Airline Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white border border-gray-200 rounded-xl p-4">
                        <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-plane mr-2 text-blue-500"></i>Aircraft Information
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Aircraft Type:</span>
                                <span class="font-semibold">Airbus A320</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Registration:</span>
                                <span class="font-semibold">VT-ABC</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Age:</span>
                                <span class="font-semibold">5.2 years</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Capacity:</span>
                                <span class="font-semibold">180 passengers</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-4">
                        <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-building mr-2 text-green-500"></i>Airline Details
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Operating Airline:</span>
                                <span class="font-semibold">Air India</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Flight Code:</span>
                                <span class="font-semibold">AI-101</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Alliance:</span>
                                <span class="font-semibold">Star Alliance</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Safety Rating:</span>
                                <span class="font-semibold text-green-600">★★★★★</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Services & Amenities -->
                <div class="bg-white border border-gray-200 rounded-xl p-4">
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-concierge-bell mr-2 text-purple-500"></i>Services & Amenities
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-3 bg-green-50 rounded-lg">
                            <i class="fas fa-suitcase text-green-500 text-xl mb-2"></i>
                            <p class="text-sm font-semibold text-gray-800">15kg Baggage</p>
                            <p class="text-xs text-gray-600">Included</p>
                        </div>
                        <div class="text-center p-3 bg-blue-50 rounded-lg">
                            <i class="fas fa-utensils text-blue-500 text-xl mb-2"></i>
                            <p class="text-sm font-semibold text-gray-800">Meals</p>
                            <p class="text-xs text-gray-600">Complimentary</p>
                        </div>
                        <div class="text-center p-3 bg-purple-50 rounded-lg">
                            <i class="fas fa-wifi text-purple-500 text-xl mb-2"></i>
                            <p class="text-sm font-semibold text-gray-800">WiFi</p>
                            <p class="text-xs text-gray-600">Available</p>
                        </div>
                        <div class="text-center p-3 bg-orange-50 rounded-lg">
                            <i class="fas fa-chair text-orange-500 text-xl mb-2"></i>
                            <p class="text-sm font-semibold text-gray-800">Seat Selection</p>
                            <p class="text-xs text-gray-600">Free</p>
                        </div>
                    </div>
                </div>

                <!-- Price Breakdown -->
                <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-xl p-4">
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-calculator mr-2 text-orange-500"></i>Price Breakdown
                    </h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Base Fare:</span>
                            <span class="font-semibold">₹8,500</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Taxes & Fees:</span>
                            <span class="font-semibold">₹1,200</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Service Charge:</span>
                            <span class="font-semibold">₹300</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Convenience Fee:</span>
                            <span class="font-semibold">₹500</span>
                        </div>
                        <div class="border-t border-yellow-300 pt-2 flex justify-between font-bold">
                            <span class="text-gray-800">Total per person:</span>
                            <span class="text-orange-600">₹10,000</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="/booking/${flightId}?passengers={{ passengers }}" 
                       class="btn btn-primary px-8 py-3 text-lg">
                        <i class="fas fa-ticket-alt mr-2"></i>Continue to Booking
                    </a>
                    <button onclick="closeFlightDetails()" 
                            class="btn btn-outline-secondary px-6 py-3">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                </div>
            </div>
        `;
    }, 1000);
}

function closeFlightDetails() {
    document.getElementById('flightDetailsModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('flightDetailsModal');
    if (event.target === modal) {
        closeFlightDetails();
    }
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeFlightDetails();
    }
});
</script>

<style>
#flightDetailsModal {
    backdrop-filter: blur(8px);
}

#flightDetailsModal > div {
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<!-- Flight Comparison Modal -->
<div id="compareModal" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-7xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-primary to-primary-dark text-white p-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-balance-scale text-2xl"></i>
                    <h2 class="text-2xl font-bold">Flight Comparison</h2>
                </div>
                <button onclick="closeCompareModal()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Modal Content -->
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
            <div id="compareContent">
                <!-- Comparison table will be populated here -->
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="bg-gray-50 p-6 border-t border-gray-200">
            <div class="flex flex-col sm:flex-row gap-4 justify-between items-center">
                <p class="text-gray-600">Select up to 4 flights to compare side by side</p>
                <div class="flex gap-3">
                    <button onclick="closeCompareModal()" class="btn btn-outline-secondary">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                    <button onclick="clearAllComparisons()" class="btn btn-outline-primary">
                        <i class="fas fa-refresh mr-2"></i>Clear All
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Flight Comparison JavaScript
let selectedFlights = new Set();
const maxComparisons = 4;

// Initialize comparison functionality
document.addEventListener('DOMContentLoaded', function() {
    const compareCheckboxes = document.querySelectorAll('.compare-checkbox');
    compareCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', handleFlightSelection);
    });

    const compareBtn = document.getElementById('compareBtn');
    const clearCompareBtn = document.getElementById('clearCompareBtn');
    
    if (compareBtn) {
        compareBtn.addEventListener('click', showComparison);
    }
    if (clearCompareBtn) {
        clearCompareBtn.addEventListener('click', clearAllComparisons);
    }
});

function handleFlightSelection(event) {
    const checkbox = event.target;
    const flightId = checkbox.dataset.flightId;
    
    if (checkbox.checked) {
        if (selectedFlights.size >= maxComparisons) {
            checkbox.checked = false;
            alert(`You can compare up to ${maxComparisons} flights at a time.`);
            return;
        }
        selectedFlights.add(flightId);
    } else {
        selectedFlights.delete(flightId);
    }
    
    updateCompareUI();
}

function updateCompareUI() {
    const compareBtn = document.getElementById('compareBtn');
    const clearCompareBtn = document.getElementById('clearCompareBtn');
    const compareCount = document.getElementById('compareCount');
    
    compareCount.textContent = selectedFlights.size;
    
    if (selectedFlights.size > 0) {
        compareBtn.classList.remove('hidden');
        clearCompareBtn.classList.remove('hidden');
    } else {
        compareBtn.classList.add('hidden');
        clearCompareBtn.classList.add('hidden');
    }
}

function showComparison() {
    if (selectedFlights.size < 2) {
        alert('Please select at least 2 flights to compare.');
        return;
    }
    
    const selectedFlightData = [];
    document.querySelectorAll('.compare-checkbox:checked').forEach(checkbox => {
        selectedFlightData.push({
            id: checkbox.dataset.flightId,
            flightNumber: checkbox.dataset.flightNumber,
            from: checkbox.dataset.from,
            to: checkbox.dataset.to,
            price: checkbox.dataset.price,
            duration: checkbox.dataset.duration,
            travelDate: checkbox.dataset.travelDate,
            departureTime: checkbox.dataset.departureTime,
            aircraft: checkbox.dataset.aircraft,
            airline: checkbox.dataset.airline,
            availableSeats: checkbox.dataset.availableSeats
        });
    });
    
    generateComparisonTable(selectedFlightData);
    document.getElementById('compareModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function generateComparisonTable(flights) {
    const content = document.getElementById('compareContent');
    
    let tableHTML = `
        <div class="overflow-x-auto">
            <table class="w-full border-collapse bg-white rounded-xl overflow-hidden shadow-sm">
                <thead>
                    <tr class="bg-gradient-to-r from-gray-50 to-blue-50">
                        <th class="text-left p-4 font-bold text-gray-800 border-b-2 border-gray-200">Feature</th>
                        ${flights.map(flight => `
                            <th class="text-center p-4 font-bold text-gray-800 border-b-2 border-gray-200 min-w-48">
                                <div class="space-y-2">
                                    <div class="bg-primary text-white rounded-lg p-2 text-sm font-bold">
                                        ${flight.flightNumber}
                                    </div>
                                    <div class="text-xs text-gray-600">${flight.airline || 'Safar Zone'}</div>
                                </div>
                            </th>
                        `).join('')}
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
    `;
    
    // Price Comparison
    const prices = flights.map(f => parseInt(f.price));
    const minPrice = Math.min(...prices);
    
    tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4 font-semibold text-gray-800">Price</td>
                        ${flights.map(flight => `
                            <td class="p-4 text-center">
                                <div class="space-y-1">
                                    <div class="text-2xl font-bold ${parseInt(flight.price) === minPrice ? 'text-green-600' : 'text-primary'}">
                                        ₹${flight.price}
                                    </div>
                                    ${parseInt(flight.price) === minPrice ? '<span class="text-xs text-green-600 font-semibold">Best Price</span>' : ''}
                                </div>
                            </td>
                        `).join('')}
                    </tr>
    `;
    
    // Route Information
    tableHTML += `
                    <tr class="hover:bg-gray-50 bg-gray-50">
                        <td class="p-4 font-semibold text-gray-800">Route</td>
                        ${flights.map(flight => `
                            <td class="p-4 text-center">
                                <div class="space-y-2">
                                    <div class="font-bold text-gray-800">${flight.from}</div>
                                    <i class="fas fa-arrow-down text-primary"></i>
                                    <div class="font-bold text-gray-800">${flight.to}</div>
                                </div>
                            </td>
                        `).join('')}
                    </tr>
    `;
    
    // Travel Date
    tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4 font-semibold text-gray-800">Travel Date</td>
                        ${flights.map(flight => `
                            <td class="p-4 text-center">
                                <div class="font-semibold text-gray-800">${flight.travelDate}</div>
                                <div class="text-sm text-gray-600">${flight.departureTime}</div>
                            </td>
                        `).join('')}
                    </tr>
    `;
    
    // Duration
    const durations = flights.map(f => f.duration);
    const minDuration = durations.reduce((a, b) => {
        const aTime = a.split('h').reduce((acc, val, i) => acc + (i === 0 ? parseInt(val) * 60 : parseInt(val) || 0), 0);
        const bTime = b.split('h').reduce((acc, val, i) => acc + (i === 0 ? parseInt(val) * 60 : parseInt(val) || 0), 0);
        
        return aTime < bTime ? a : b;
    });
    
    tableHTML += `
                    <tr class="hover:bg-gray-50 bg-gray-50">
                        <td class="p-4 font-semibold text-gray-800">Duration</td>
                        ${flights.map(flight => `
                            <td class="p-4 text-center">
                                <div class="space-y-1">
                                    <div class="font-semibold ${flight.duration === minDuration ? 'text-green-600' : 'text-gray-800'}">
                                        ${flight.duration}
                                    </div>
                                    ${flight.duration === minDuration ? '<span class="text-xs text-green-600 font-semibold">Fastest</span>' : ''}
                                </div>
                            </td>
                        `).join('')}
                    </tr>
    `;
    
    // Aircraft Type
    tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4 font-semibold text-gray-800">Aircraft</td>
                        ${flights.map(flight => `
                            <td class="p-4 text-center font-semibold text-gray-800">${flight.aircraft}</td>
                        `).join('')}
                    </tr>
    `;
    
    // Available Seats
    const seats = flights.map(f => parseInt(f.availableSeats));
    const maxSeats = Math.max(...seats);
    
    tableHTML += `
                    <tr class="hover:bg-gray-50 bg-gray-50">
                        <td class="p-4 font-semibold text-gray-800">Available Seats</td>
                        ${flights.map(flight => `
                            <td class="p-4 text-center">
                                <div class="space-y-1">
                                    <div class="font-semibold ${parseInt(flight.availableSeats) === maxSeats ? 'text-blue-600' : 'text-gray-800'}">
                                        ${flight.availableSeats} seats
                                    </div>
                                    ${parseInt(flight.availableSeats) === maxSeats ? '<span class="text-xs text-blue-600 font-semibold">Most Available</span>' : ''}
                                </div>
                            </td>
                        `).join('')}
                    </tr>
    `;
    
    // Action Buttons
    tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4 font-semibold text-gray-800">Actions</td>
                        ${flights.map(flight => `
                            <td class="p-4 text-center">
                                <div class="space-y-2">
                                    <a href="/booking/${flight.id}?passengers={{ passengers }}" 
                                       class="btn btn-primary btn-sm w-full">
                                        <i class="fas fa-ticket-alt mr-1"></i>Book Now
                                    </a>
                                    <button onclick="removeFromComparison('${flight.id}')" 
                                            class="btn btn-outline-secondary btn-sm w-full">
                                        <i class="fas fa-times mr-1"></i>Remove
                                    </button>
                                </div>
                            </td>
                        `).join('')}
                    </tr>
    `;
    
    tableHTML += `
                </tbody>
            </table>
        </div>
        
        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-xl p-4">
            <h4 class="font-bold text-blue-800 mb-2 flex items-center">
                <i class="fas fa-lightbulb mr-2"></i>Comparison Tips
            </h4>
            <ul class="text-sm text-blue-700 space-y-1">
                <li>• <strong>Best Price:</strong> Highlighted in green for the most affordable option</li>
                <li>• <strong>Fastest:</strong> Highlighted in green for the shortest travel time</li>
                <li>• <strong>Most Available:</strong> Highlighted in blue for best seat availability</li>
                <li>• Consider both price and convenience when making your choice</li>
            </ul>
        </div>
    `;
    
    content.innerHTML = tableHTML;
}

function removeFromComparison(flightId) {
    selectedFlights.delete(flightId);
    const checkbox = document.querySelector(`input[data-flight-id="${flightId}"]`);
    if (checkbox) {
        checkbox.checked = false;
    }
    updateCompareUI();
    
    if (selectedFlights.size < 2) {
        closeCompareModal();
    } else {
        showComparison();
    }
}

function clearAllComparisons() {
    selectedFlights.clear();
    document.querySelectorAll('.compare-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateCompareUI();
    closeCompareModal();
}

function closeCompareModal() {
    document.getElementById('compareModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('compareModal');
    if (event.target === modal) {
        closeCompareModal();
    }
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeCompareModal();
    }
});
</script>

{% endblock %}
