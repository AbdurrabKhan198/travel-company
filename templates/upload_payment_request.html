{% extends 'base.html' %}
{% load static %}

{% block title %}Upload Payment Request - Safar Zone Travels{% endblock %}

{% block extra_css %}
<style>
    @keyframes fade-in-up {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-fade-in-up {
        animation: fade-in-up 0.6s ease-out;
    }
    
    input, select, textarea {
        color: #111827 !important;
    }
    
    input::placeholder, textarea::placeholder {
        color: #9ca3af !important;
        opacity: 0.7;
    }
    
    label {
        color: #1f2937 !important;
    }
    
    .file-upload-area {
        border: 2px dashed #d1d5db;
        transition: all 0.3s ease;
    }
    
    .file-upload-area:hover {
        border-color: #0ea5e9;
        background: #f0f9ff;
    }
    
    .file-upload-area.dragover {
        border-color: #0ea5e9;
        background: #e0f2fe;
    }
    
    .status-badge {
        padding: 4px 12px;
        border-radius: 9999px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .status-pending {
        background: #fef3c7;
        color: #92400e;
    }
    
    .status-verified {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-rejected {
        background: #fee2e2;
        color: #991b1b;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-sky-50 via-blue-50 to-indigo-50 py-12">
    <div class="container mx-auto px-4">
        <div class="max-w-3xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8 animate-fade-in-up">
                <div class="inline-block p-4 bg-gradient-to-br from-indigo-400 to-purple-600 rounded-2xl mb-4 shadow-lg">
                    <i class="fas fa-cloud-upload-alt text-white text-3xl"></i>
                </div>
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-3">
                    Upload <span class="gradient-text">Payment Request</span>
                </h1>
                <p class="text-xl text-gray-600">Submit your payment proof for verification</p>
            </div>

            <!-- Form Card -->
            <div class="bg-white rounded-2xl shadow-xl p-8 md:p-10 animate-fade-in-up" style="animation-delay: 0.1s;">
                <form method="POST" action="{% url 'upload_payment_request' %}" enctype="multipart/form-data" id="uploadForm">
                    {% csrf_token %}
                    
                    <!-- Payment Details Section -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                            <i class="fas fa-rupee-sign text-sky-600 mr-3"></i>
                            Payment Details
                        </h2>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label for="amount" class="block text-gray-700 font-semibold mb-2">
                                    Amount <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-semibold">‚Çπ</span>
                                    <input type="number" name="amount" id="amount" required min="1" step="0.01"
                                           class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                                           placeholder="Enter amount">
                                </div>
                            </div>
                            <div>
                                <label for="bank_account" class="block text-gray-700 font-semibold mb-2">
                                    Bank Account (Optional)
                                </label>
                                <select name="bank_account" id="bank_account"
                                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                                    <option value="">Select bank account</option>
                                    {% for account in bank_accounts %}
                                    <option value="{{ account.id }}">{{ account.bank_name }} - {{ account.account_number|slice:"-4:" }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="payment_method" class="block text-gray-700 font-semibold mb-2">
                                    Payment Method <span class="text-red-500">*</span>
                                </label>
                                <select name="payment_method" id="payment_method" required
                                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                                    <option value="">Select payment method</option>
                                    <option value="net_banking">üè¶ Net Banking</option>
                                    <option value="upi">üì± UPI / QR Code</option>
                                    <option value="credit_card">üí≥ Credit Card</option>
                                    <option value="debit_card">üí≥ Debit Card</option>
                                    <option value="wallet">üëõ Digital Wallet (Paytm, PhonePe, Google Pay)</option>
                                    <option value="neft_rtgs">üèß NEFT / RTGS</option>
                                    <option value="imps">‚ö° IMPS</option>
                                    <option value="cheque">üìù Cheque</option>
                                    <option value="cash">üíµ Cash Deposit</option>
                                    <option value="other">üîÑ Other</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="transaction_id" class="block text-gray-700 font-semibold mb-2">
                                    Transaction ID / UTR Number
                                </label>
                                <input type="text" name="transaction_id" id="transaction_id"
                                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                                       placeholder="Enter UTR number or transaction reference">
                            </div>
                        </div>
                    </div>

                    <!-- Payment Proof Upload Section -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                            <i class="fas fa-image text-sky-600 mr-3"></i>
                            Payment Proof <span class="text-red-500 ml-1">*</span>
                        </h2>
                        <div class="file-upload-area rounded-xl p-8 text-center cursor-pointer" id="dropZone" onclick="document.getElementById('proof_image').click()">
                            <input type="file" name="proof_image" id="proof_image" required 
                                   accept="image/*,.pdf" class="hidden"
                                   onchange="handleFileSelect(event)">
                            <div id="uploadPlaceholder">
                                <i class="fas fa-cloud-upload-alt text-5xl text-gray-400 mb-4"></i>
                                <p class="text-lg font-semibold text-gray-700 mb-2">Drop your file here or click to upload</p>
                                <p class="text-sm text-gray-500">Supported: JPG, PNG, GIF, WEBP, PDF (Max 10MB)</p>
                            </div>
                            <div id="filePreview" class="hidden">
                                <img id="imagePreview" src="" alt="Preview" class="max-h-48 mx-auto rounded-lg shadow-lg">
                                <p id="fileName" class="mt-3 text-sm font-semibold text-gray-700"></p>
                                <button type="button" onclick="event.stopPropagation(); clearFile()" class="mt-2 text-red-500 hover:text-red-700 font-semibold">
                                    <i class="fas fa-times mr-1"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                            <i class="fas fa-sticky-note text-sky-600 mr-3"></i>
                            Additional Notes
                        </h2>
                        <div>
                            <label for="notes" class="block text-gray-700 font-semibold mb-2">
                                Notes (Optional)
                            </label>
                            <textarea name="notes" id="notes" rows="4"
                                      class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                                      placeholder="Any additional information about the payment..."></textarea>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex flex-col md:flex-row gap-4 justify-end">
                        <a href="{% url 'bank_accounts' %}" class="px-8 py-3 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold transition-all duration-200 flex items-center justify-center">
                            <i class="fas fa-arrow-left mr-2"></i>
                            View Bank Accounts
                        </a>
                        <button type="submit" class="px-8 py-3 rounded-xl bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 text-white font-bold shadow-lg transform hover:scale-105 transition-all duration-200 flex items-center justify-center">
                            <i class="fas fa-paper-plane mr-2"></i>
                            Submit Request
                        </button>
                    </div>
                </form>
            </div>

            <!-- Previous Requests -->
            {% if user_requests %}
            <div class="mt-8 bg-white rounded-2xl shadow-xl p-6 md:p-8 animate-fade-in-up" style="animation-delay: 0.2s;">
                <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                    <i class="fas fa-history text-sky-600 mr-3"></i>
                    Recent Upload Requests
                </h2>
                <div class="space-y-4">
                    {% for request in user_requests %}
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-sky-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-receipt text-sky-600"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900">{{ request.reference_id }}</p>
                                <p class="text-sm text-gray-500">‚Çπ{{ request.amount|floatformat:2 }} ‚Ä¢ {{ request.created_at|date:"d M Y, H:i" }}</p>
                            </div>
                        </div>
                        <div>
                            {% if request.status == 'pending' %}
                            <span class="status-badge status-pending">
                                <i class="fas fa-clock mr-1"></i> Pending
                            </span>
                            {% elif request.status == 'verified' %}
                            <span class="status-badge status-verified">
                                <i class="fas fa-check mr-1"></i> Verified
                            </span>
                            {% elif request.status == 'rejected' %}
                            <span class="status-badge status-rejected">
                                <i class="fas fa-times mr-1"></i> Rejected
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Info Card -->
            <div class="mt-8 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 border-2 border-blue-200 animate-fade-in-up" style="animation-delay: 0.3s;">
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-info text-white text-xl"></i>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-2">What happens next?</h3>
                        <ul class="text-gray-700 space-y-2">
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                                <span>Our team will verify your payment proof within a few hours</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                                <span>Once verified, your wallet will be credited with the amount</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                                <span>You'll receive a notification about the status</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Drag and drop functionality
    const dropZone = document.getElementById('dropZone');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight(e) {
        dropZone.classList.add('dragover');
    }
    
    function unhighlight(e) {
        dropZone.classList.remove('dragover');
    }
    
    dropZone.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) {
            document.getElementById('proof_image').files = files;
            handleFileSelect({ target: { files: files } });
        }
    }
    
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            // Validate file size (10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB');
                clearFile();
                return;
            }
            
            // Show preview
            const placeholder = document.getElementById('uploadPlaceholder');
            const preview = document.getElementById('filePreview');
            const imagePreview = document.getElementById('imagePreview');
            const fileName = document.getElementById('fileName');
            
            fileName.textContent = file.name;
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.classList.add('hidden');
            }
            
            placeholder.classList.add('hidden');
            preview.classList.remove('hidden');
        }
    }
    
    function clearFile() {
        const input = document.getElementById('proof_image');
        input.value = '';
        
        const placeholder = document.getElementById('uploadPlaceholder');
        const preview = document.getElementById('filePreview');
        
        placeholder.classList.remove('hidden');
        preview.classList.add('hidden');
    }
    
    // Form validation
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        const amount = document.getElementById('amount').value;
        const proofImage = document.getElementById('proof_image').files[0];
        
        if (!amount || parseFloat(amount) <= 0) {
            e.preventDefault();
            alert('Please enter a valid amount.');
            return false;
        }
        
        if (!proofImage) {
            e.preventDefault();
            alert('Please upload a payment proof image.');
            return false;
        }
    });
</script>
{% endblock %}
