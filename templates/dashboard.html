{% extends 'base.html' %}
{% load static %}
{% load travel_filters %}

{% block title %}View Profile - Safar Zone Travels{% endblock %}

{% block extra_css %}
<style>
    @keyframes slideInFromRight {
        from {
            opacity: 0;
            transform: translateX(30px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .slide-in-right {
        animation: slideInFromRight 0.5s ease-out;
    }

    /* Dashboard text visibility fixes */
    .dashboard-page h1,
    .dashboard-page h2,
    .dashboard-page h3 {
        color: #111827 !important;
    }

    .dashboard-page p {
        color: #4b5563 !important;
    }

    /* Wallet card - Force white text */
    .dashboard-page .wallet-card,
    .dashboard-page .wallet-card *,
    .dashboard-page .wallet-card p,
    .dashboard-page .wallet-card h2,
    .dashboard-page .wallet-card h3 {
        color: #ffffff !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5) !important;
    }

    /* Stats cards */
    .dashboard-page .stats-card p,
    .dashboard-page .stats-card h2 {
        color: #111827 !important;
    }

    /* Table tabs */
    .dashboard-page .tab-button {
        color: #374151 !important;
    }

    .dashboard-page .tab-button.active {
        color: inherit !important;
    }

    /* Booking cards */
    .dashboard-page .booking-card h3,
    .dashboard-page .booking-card p {
        color: #111827 !important;
    }

    /* Buttons */
    .dashboard-page button,
    .dashboard-page a.bg-gradient-to-r {
        color: #ffffff !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-page min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-indigo-50 py-8">
    <div class="container mx-auto px-4">
        <!-- Welcome Header -->
        <div class="mb-8 animate-fade-in-up">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div class="flex items-center gap-4">
                    <!-- Logo Display/Upload -->
                    <div class="flex-shrink-0">
                        {% if profile.logo %}
                        <img src="{{ profile.logo.url }}" alt="Logo"
                            class="w-20 h-20 rounded-xl object-cover border-4 border-white shadow-lg">
                        {% else %}
                        <div
                            class="w-20 h-20 rounded-xl bg-gradient-to-br from-sky-400 to-blue-600 flex items-center justify-center border-4 border-white shadow-lg">
                            <i class="fas fa-image text-white text-2xl"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div>
                        <h1 class="text-4xl md:text-5xl font-bold mb-2" style="color: #111827 !important;">
                            Welcome back, <span class="gradient-text">{% if user.profile %}{{ user.profile.company_name|default:user.email }}{% else %}{{ user.email }}{% endif %}!</span> ðŸ‘‹
                        </h1>
                        <p class="text-xl mb-2" style="color: #4b5563 !important;">Here's what's happening with your
                            travel plans</p>
                        {% if user.client_id %}
                        <p class="text-sm" style="color: #6b7280 !important;">
                            <i class="fas fa-id-card mr-2"></i>
                            Client ID: <span class="font-semibold text-sky-600">{{ user.client_id }}</span>
                        </p>
                        {% endif %}
                    </div>
                </div>
                <div class="flex gap-3">
                    <!-- Logo Upload Form -->
                    <form method="post" enctype="multipart/form-data" class="flex items-center">
                        {% csrf_token %}
                        <label
                            class="px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 flex items-center space-x-2 cursor-pointer">
                            <i class="fas fa-upload"></i>
                            <span>Upload Logo</span>
                            <input type="file" name="logo" accept="image/*" class="hidden"
                                onchange="this.form.submit()">
                        </label>
                    </form>
                    <a href="{% url 'homepage' %}"
                        class="px-6 py-3 bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 flex items-center space-x-2">
                        <i class="fas fa-plus"></i>
                        <span>New Booking</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Upcoming Trips -->
            <div
                class="stats-card bg-white rounded-2xl shadow-xl p-6 border-l-4 border-sky-500 hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 animate-fade-in-up">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium mb-1" style="color: #4b5563 !important;">Upcoming Trips</p>
                        <h2 class="text-4xl font-bold" style="color: #111827 !important;">{{ upcoming_count }}</h2>
                        <p class="text-xs mt-2" style="color: #6b7280 !important;">Bookings confirmed</p>
                    </div>
                    <div
                        class="w-16 h-16 bg-gradient-to-br from-sky-400 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-plane text-white text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Completed Trips -->
            <div class="stats-card bg-white rounded-2xl shadow-xl p-6 border-l-4 border-green-500 hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 animate-fade-in-up"
                style="animation-delay: 0.1s;">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium mb-1" style="color: #4b5563 !important;">Completed Trips</p>
                        <h2 class="text-4xl font-bold" style="color: #111827 !important;">{{ completed_count }}</h2>
                        <p class="text-xs mt-2" style="color: #6b7280 !important;">Journeys completed</p>
                    </div>
                    <div
                        class="w-16 h-16 bg-gradient-to-br from-green-400 to-emerald-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-check-circle text-white text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Total Spent -->
            <div class="stats-card bg-white rounded-2xl shadow-xl p-6 border-l-4 border-yellow-500 hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 animate-fade-in-up"
                style="animation-delay: 0.2s;">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium mb-1" style="color: #4b5563 !important;">Total Spent</p>
                        <h2 class="text-4xl font-bold" style="color: #111827 !important;">â‚¹{{ total_spent|floatformat:0 }}</h2>
                        <p class="text-xs mt-2" style="color: #6b7280 !important;">All time spending</p>
                    </div>
                    <div
                        class="w-16 h-16 bg-gradient-to-br from-yellow-400 to-orange-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-rupee-sign text-white text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- OD Wallet Card - Only show if admin has activated it -->
        {% if od_wallet %}
        <div class="mb-8 animate-fade-in-up" style="animation-delay: 0.3s;">
            <div class="wallet-card rounded-2xl shadow-2xl p-6"
                style="background: {% if od_wallet_is_expired or od_wallet_balance < 0 %}linear-gradient(135deg, #6b7280 0%, #4b5563 50%, #374151 100%){% else %}linear-gradient(135deg, #d97706 0%, #ea580c 50%, #dc2626 100%){% endif %} !important;">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-wallet text-2xl" style="color: #ffffff !important;"></i>
                            <h3 class="text-2xl font-bold"
                                style="color: #ffffff !important; text-shadow: 0 2px 4px rgba(0,0,0,0.5) !important;">OD
                                Wallet</h3>
                            {% if od_wallet_is_expired or od_wallet_balance < 0 %}
                            <span class="bg-red-500/80 px-3 py-1 rounded-full text-xs font-semibold"
                                style="color: #ffffff !important; text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;">EXPIRED</span>
                            {% elif has_od_wallet_access %}
                            <span class="bg-white/20 px-3 py-1 rounded-full text-xs font-semibold"
                                style="color: #ffffff !important; text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;">ACTIVE</span>
                            {% endif %}
                            {% if od_wallet_days_remaining is not None %}
                            <span class="bg-yellow-500/80 px-3 py-1 rounded-full text-xs font-semibold"
                                style="color: #ffffff !important; text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;">
                                {% if od_wallet_days_remaining < 0 %}
                                Expired {{ od_wallet_days_remaining|slice:"1:" }} Days Ago
                                {% elif od_wallet_days_remaining == 0 %}
                                Expires Today
                                {% elif od_wallet_days_remaining == 1 %}
                                1 Day Left
                                {% else %}
                                {{ od_wallet_days_remaining }} Days Left
                                {% endif %}
                            </span>
                            {% endif %}
                        </div>
                        <p class="mb-1"
                            style="color: #ffffff !important; text-shadow: 0 2px 4px rgba(0,0,0,0.5) !important;">
                            {% if od_wallet_balance < 0 %}
                            Used Amount (Negative Balance)
                            {% else %}
                            Available Balance
                            {% endif %}
                        </p>
                        <h2 class="text-5xl font-bold mb-2"
                            style="color: #ffffff !important; text-shadow: 0 3px 8px rgba(0,0,0,0.6) !important;">
                            {% if od_wallet_balance < 0 %}
                            -â‚¹{{ od_wallet_balance|floatformat:2|slice:"1:" }}
                            {% else %}
                            â‚¹{{ od_wallet_balance|floatformat:2 }}
                            {% endif %}
                        </h2>
                        <p class="text-sm"
                            style="color: #ffffff !important; text-shadow: 0 2px 4px rgba(0,0,0,0.5) !important;">
                            {% if od_wallet_is_expired %}
                            Wallet expired. Remaining balance deducted.
                            {% elif od_wallet_balance < 0 %}
                            You used â‚¹{{ od_wallet_balance|floatformat:2|slice:"1:" }} beyond allocated amount.
                            {% else %}
                            Admin managed wallet - Only admin can recharge
                            {% endif %}
                        </p>
                    </div>
                    <div class="flex flex-col gap-3 w-full md:w-auto">
                        <a href="{% url 'wallet_history' %}?type=od"
                            class="px-6 py-3 bg-white/20 backdrop-blur-sm font-bold rounded-xl shadow-lg hover:bg-white/30 transition-all duration-200 flex items-center justify-center space-x-2"
                            style="color: #ffffff !important; text-shadow: 0 2px 4px rgba(0,0,0,0.5) !important;">
                            <i class="fas fa-history" style="color: #ffffff !important;"></i>
                            <span style="color: #ffffff !important;">OD Wallet History</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Cash Balance Wallet Card - Always visible, users can recharge themselves -->
        <div class="mb-8 animate-fade-in-up" style="animation-delay: 0.4s;">
            <div class="wallet-card rounded-2xl shadow-2xl p-6"
                style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%) !important;">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-wallet text-2xl" style="color: #ffffff !important;"></i>
                            <h3 class="text-2xl font-bold"
                                style="color: #ffffff !important; text-shadow: 0 2px 4px rgba(0,0,0,0.5) !important;">
                                Cash Balance</h3>
                            <span class="bg-white/20 px-3 py-1 rounded-full text-xs font-semibold"
                                style="color: #ffffff !important; text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;">ACTIVE</span>
                        </div>
                        <p class="mb-1"
                            style="color: #ffffff !important; text-shadow: 0 2px 4px rgba(0,0,0,0.5) !important;">
                            Available Balance</p>
                        <h2 class="text-5xl font-bold mb-2"
                            style="color: #ffffff !important; text-shadow: 0 3px 8px rgba(0,0,0,0.6) !important;">â‚¹{{ cash_balance|floatformat:2 }}</h2>
                        <p class="text-sm"
                            style="color: #ffffff !important; text-shadow: 0 2px 4px rgba(0,0,0,0.5) !important;">
                            Recharge yourself and use for bookings instantly</p>
                    </div>
                    <div class="flex flex-col gap-3 w-full md:w-auto">
                        <a href="{% url 'wallet_recharge' %}"
                            class="px-6 py-3 bg-white font-bold rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 flex items-center justify-center space-x-2"
                            style="color: #1e40af !important;">
                            <i class="fas fa-plus-circle" style="color: #1e40af !important;"></i>
                            <span style="color: #1e40af !important;">Recharge Cash Balance</span>
                        </a>
                        <a href="{% url 'wallet_history' %}"
                            class="px-6 py-3 bg-white/20 backdrop-blur-sm font-bold rounded-xl shadow-lg hover:bg-white/30 transition-all duration-200 flex items-center justify-center space-x-2"
                            style="color: #ffffff !important; text-shadow: 0 2px 4px rgba(0,0,0,0.5) !important;">
                            <i class="fas fa-history" style="color: #ffffff !important;"></i>
                            <span style="color: #ffffff !important;">Transaction History</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>


    </div>
</div>

<!-- Ticket PDF View Modal -->
<div id="ticketPDFModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h3 class="text-2xl font-bold" style="color: #111827 !important;">Ticket PDF</h3>
            <button onclick="closeTicketPDFModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <div class="flex-1 overflow-hidden p-6">
            <embed id="ticketPDFFrame" src="" type="application/pdf"
                class="w-full h-full border-2 border-gray-200 rounded-lg" style="min-height: 500px;">
            <p class="text-center text-gray-500 mt-4" id="pdfErrorMsg" style="display: none;">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Unable to display PDF. <a href="#" id="pdfDirectLink" class="text-sky-600 hover:underline">Click here to
                    open in new tab</a>
            </p>
        </div>
        <div class="p-6 border-t border-gray-200">
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-3">
                <button onclick="downloadTicketPDF()"
                    class="px-4 py-3 bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 text-white font-semibold rounded-xl transition-all duration-200 flex items-center justify-center space-x-2">
                    <i class="fas fa-download"></i>
                    <span>Download</span>
                </button>
                <button onclick="printTicketPDF()"
                    class="px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold rounded-xl transition-all duration-200 flex items-center justify-center space-x-2">
                    <i class="fas fa-print"></i>
                    <span>Print (No Fare)</span>
                </button>
                <button onclick="editFare()"
                    class="px-4 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-semibold rounded-xl transition-all duration-200 flex items-center justify-center space-x-2">
                    <i class="fas fa-edit"></i>
                    <span>Edit Fare</span>
                </button>
                <button onclick="emailTicketWithFare()"
                    class="px-4 py-3 bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-semibold rounded-xl transition-all duration-200 flex items-center justify-center space-x-2">
                    <i class="fas fa-envelope"></i>
                    <span>Email (With Fare)</span>
                </button>
                <button onclick="emailTicketWithoutFare()"
                    class="px-4 py-3 bg-gradient-to-r from-pink-500 to-rose-600 hover:from-pink-600 hover:to-rose-700 text-white font-semibold rounded-xl transition-all duration-200 flex items-center justify-center space-x-2">
                    <i class="fas fa-envelope-open"></i>
                    <span>Email (No Fare)</span>
                </button>
                <button onclick="closeTicketPDFModal()"
                    class="px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-xl transition-all duration-200">
                    <i class="fas fa-times mr-2"></i>
                    <span>Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- PDF Upload/Edit Modal -->
<div id="pdfModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold" id="modalTitle" style="color: #111827 !important;">Upload PDF</h3>
            <button onclick="closePDFModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <form id="pdfUploadForm" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="pdf_type" id="pdfType">
            <div class="mb-6">
                <label class="block text-sm font-semibold mb-2" style="color: #374151 !important;">
                    Select PDF File
                </label>
                <input type="file" name="pdf_file" id="pdfFile" accept=".pdf" required
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-300">
                <p class="text-xs mt-2" style="color: #6b7280 !important;">Maximum file size: 10MB</p>
            </div>
            <div class="flex gap-3">
                <button type="button" onclick="closePDFModal()"
                    class="flex-1 px-4 py-3 bg-gray-200 hover:bg-gray-300 font-semibold rounded-xl transition-all duration-200"
                    style="color: #374151 !important;">
                    Cancel
                </button>
                <button type="submit"
                    class="flex-1 px-4 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-semibold rounded-xl transition-all duration-200">
                    <i class="fas fa-upload mr-2"></i>Upload
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function showTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });

        // Remove active class from all tabs
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active', 'bg-white', 'text-sky-600', 'text-green-600', 'text-red-600');
            button.classList.add('text-gray-700');
        });

        // Show selected tab content
        document.getElementById('content-' + tabName).classList.remove('hidden');

        // Add active class to selected tab
        const activeTab = document.getElementById('tab-' + tabName);
        activeTab.classList.add('active', 'bg-white');
        if (tabName === 'upcoming') {
            activeTab.classList.add('text-sky-600');
        } else if (tabName === 'past') {
            activeTab.classList.add('text-green-600');
        } else if (tabName === 'cancelled') {
            activeTab.classList.add('text-red-600');
        }
    }

    function confirmCancelBooking(bookingId) {
        if (confirm('Are you sure you want to cancel this booking?')) {
            document.getElementById('cancel-form-' + bookingId).submit();
        }
    }

    // Ticket PDF View Functions
    let currentTicketPDFUrl = '';
    let currentBookingId = '';

    function viewTicketPDF(bookingId, pdfUrl) {
        currentBookingId = bookingId;
        currentTicketPDFUrl = pdfUrl;
        // Add ?view=true to the URL for inline viewing
        const viewUrl = pdfUrl + (pdfUrl.includes('?') ? '&' : '?') + 'view=true';
        const pdfFrame = document.getElementById('ticketPDFFrame');
        const errorMsg = document.getElementById('pdfErrorMsg');
        const directLink = document.getElementById('pdfDirectLink');

        // Set up direct link as fallback
        directLink.href = pdfUrl;
        directLink.onclick = function (e) {
            e.preventDefault();
            window.open(pdfUrl, '_blank');
        };

        // Try to load PDF
        pdfFrame.src = viewUrl;
        errorMsg.style.display = 'none';

        // Show error message if PDF fails to load after 3 seconds
        setTimeout(function () {
            pdfFrame.onerror = function () {
                errorMsg.style.display = 'block';
            };
        }, 3000);

        document.getElementById('ticketPDFModal').classList.remove('hidden');
        document.getElementById('ticketPDFModal').classList.add('flex');
    }

    function closeTicketPDFModal() {
        document.getElementById('ticketPDFModal').classList.add('hidden');
        document.getElementById('ticketPDFModal').classList.remove('flex');
        const pdfFrame = document.getElementById('ticketPDFFrame');
        pdfFrame.src = '';
        document.getElementById('pdfErrorMsg').style.display = 'none';
    }

    function downloadTicketPDF() {
        if (currentTicketPDFUrl) {
            window.open(currentTicketPDFUrl, '_blank');
        }
    }

    function printTicketPDF() {
        if (currentBookingId) {
            const printUrl = `/ticket/${currentBookingId}/print/`;
            const printWindow = window.open(printUrl, '_blank');
            if (printWindow) {
                printWindow.onload = function () {
                    printWindow.print();
                };
            }
        }
    }

    function emailTicketWithFare() {
        if (!currentBookingId) return;

        const email = prompt('Enter email address to send ticket:', '{{ request.user.email }}');
        if (!email) return;

        if (!email.includes('@')) {
            alert('Please enter a valid email address.');
            return;
        }

        const formData = new FormData();
        formData.append('email', email);
        formData.append('hide_fare', 'false');
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch(`/ticket/${currentBookingId}/email/`, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                } else {
                    alert(data.message || 'Failed to send email.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while sending email.');
            });
    }

    function emailTicketWithoutFare() {
        if (!currentBookingId) return;

        const email = prompt('Enter email address to send ticket:', '{{ request.user.email }}');
        if (!email) return;

        if (!email.includes('@')) {
            alert('Please enter a valid email address.');
            return;
        }

        const formData = new FormData();
        formData.append('email', email);
        formData.append('hide_fare', 'true');
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch(`/ticket/${currentBookingId}/email/`, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                } else {
                    alert(data.message || 'Failed to send email.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while sending email.');
            });
    }

    function editFare() {
        if (!currentBookingId) return;

        const baseFare = prompt('Enter new base fare:', '');
        if (baseFare === null) return;

        const taxAmount = prompt('Enter new tax amount:', '');
        if (taxAmount === null) return;

        if (isNaN(baseFare) || isNaN(taxAmount) || parseFloat(baseFare) < 0 || parseFloat(taxAmount) < 0) {
            alert('Please enter valid positive numbers.');
            return;
        }

        const formData = new FormData();
        formData.append('base_fare', baseFare);
        formData.append('tax_amount', taxAmount);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch(`/ticket/${currentBookingId}/edit-fare/`, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message + (data.new_total ? '\nNew Total: â‚¹' + data.new_total : ''));
                    // Reload page to show updated fare
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert(data.message || 'Failed to update fare.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating fare.');
            });
    }

    // Close modal when clicking outside
    document.getElementById('ticketPDFModal')?.addEventListener('click', function (e) {
        if (e.target === this) {
            closeTicketPDFModal();
        }
    });

    // PDF Management Functions
    function uploadPDF(pdfType) {
        document.getElementById('modalTitle').textContent = 'Upload PDF Document';
        document.getElementById('pdfType').value = pdfType;
        document.getElementById('pdfFile').value = '';
        document.getElementById('pdfFile').required = true;
        document.getElementById('pdfModal').classList.remove('hidden');
        document.getElementById('pdfModal').classList.add('flex');
    }

    function editPDF(pdfType, currentUrl) {
        document.getElementById('modalTitle').textContent = 'Edit/Replace PDF Document';
        document.getElementById('pdfType').value = pdfType;
        document.getElementById('pdfFile').value = '';
        document.getElementById('pdfFile').required = true;
        document.getElementById('pdfModal').classList.remove('hidden');
        document.getElementById('pdfModal').classList.add('flex');
    }

    function deletePDF(pdfType) {
        if (confirm('Are you sure you want to delete this PDF document?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "delete_profile_pdf" %}';

            const csrf = document.createElement('input');
            csrf.type = 'hidden';
            csrf.name = 'csrfmiddlewaretoken';
            csrf.value = '{{ csrf_token }}';
            form.appendChild(csrf);

            const typeInput = document.createElement('input');
            typeInput.type = 'hidden';
            typeInput.name = 'pdf_type';
            typeInput.value = pdfType;
            form.appendChild(typeInput);

            document.body.appendChild(form);
            form.submit();
        }
    }

    function closePDFModal() {
        document.getElementById('pdfModal').classList.add('hidden');
        document.getElementById('pdfModal').classList.remove('flex');
        document.getElementById('pdfUploadForm').reset();
    }

    // Handle PDF form submission
    document.getElementById('pdfUploadForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
        submitBtn.disabled = true;

        fetch('{% url "upload_profile_pdf" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error || 'Failed to upload PDF');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while uploading the PDF');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
    });
</script>
{% endblock %}